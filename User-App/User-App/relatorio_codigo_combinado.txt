
#################################################################################
IN√çCIO DA AN√ÅLISE DE: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src
#################################################################################

=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\app.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\app.js
// C√ìDIGO COMPLETO E CORRIGIDO

import Fastify from 'fastify';
import cors from '@fastify/cors';
import fastifyFormbody from '@fastify/formbody';
import { fastifySwagger } from '@fastify/swagger';
import swaggerUI from '@fastify/swagger-ui';
import pino from 'pino';
import fs from 'fs';
import multipart from '@fastify/multipart';      // 1. IMPORTADO
import fastifyStatic from '@fastify/static';  // 2. IMPORTADO
import path from 'path';                         // 3. IMPORTADO
import { fileURLToPath } from 'url';             // 4. IMPORTADO

import authRoutes from './routes/auth.routes.js';
import apartamentoRoutes from './routes/apartamento.routes.js';
import dicaRoutes from './routes/dica.routes.js';
import userRoutes from './routes/user.routes.js';
import passwordRoutes from './routes/password.routes.js';
import cepRoutes from './routes/cep.routes.js';
import metasRoutes from './routes/metas.routes.js';
import profileRoutes from './routes/profile.routes.js';
import comunicadosRoutes from './routes/comunicados.routes.js';
import casaRoutes from './routes/casa.routes.js';

if (!fs.existsSync('./logs')) fs.mkdirSync('./logs')

// cria log di√°rio
const date = new Date().toISOString().slice(0, 10)
const filePath = `./logs/${date}.log`
const fileStream = fs.createWriteStream(filePath, { flags: 'a' })

const prettyTransport = pino.transport({
    target: 'pino-pretty',
    options: {
        colorize: true,
        translateTime: 'SYS:standard',
        ignore: 'pid,hostname',
    },
})

const multiStream = pino.multistream([
    { stream: prettyTransport },
    { stream: fileStream },
])

const fastify = Fastify({
    logger: {
        transport: {
            target: 'pino-pretty'
        }
    }
});

await fastify.register(cors, {
    origin: '*',
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH']
});

fastify.register(fastifyFormbody);
await fastify.register(multipart); // 5. REGISTRADO PLUGIN MULTIPART

// 6. REGISTRADO PLUGIN STATIC PARA SERVIR A PASTA 'uploads'
fastify.register(fastifyStatic, {
    root: path.join(process.cwd(), 'uploads'),
    prefix: '/api/uploads/',
});

// docs api
await fastify.register(fastifySwagger, {
    openapi: {
        info: {
            title: 'Aqua API Mobile',
            version: '1.0.0',
            description: 'Documenta√ß√£o da nossa API Mobile do Sistema Aqua.'
        },
    }
});

await fastify.register(swaggerUI, {
    routePrefix: '/docs',
    uiConfig: {
        docExpansion: 'list',
        deepLinking: false
    },
    initOAuth: {},
});

fastify.get('/api', {
    schema: {
        tags: ['Health Check'],
        summary: 'Status da API',
        description: 'Verifica se a API est√° online e respondendo',
        response: {
            200: {
                type: 'string',
                example: 'Hello API'
            }
        }
    }
}, (req, reply) => {
    return reply.status(200).send('Hello Mobile!')
})


fastify.register(authRoutes, { prefix: '/api/auth' });
fastify.register(apartamentoRoutes, { prefix: '/api/apartamentos' });
fastify.register(casaRoutes, { prefix: '/api/casas' });
fastify.register(dicaRoutes, { prefix: '/api/dica' });
fastify.register(userRoutes, { prefix: '/api/user' });
fastify.register(metasRoutes, { prefix: '/api/metas' });
fastify.register(cepRoutes, { prefix: '/api/cep' });
fastify.register(profileRoutes, { prefix: '/api/profile' });
fastify.register(passwordRoutes, { prefix: '/api/password' });
fastify.register(comunicadosRoutes, { prefix: '/api/comunicados' });

export default fastify;


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\config\sequelize.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\config\sequelize.js
// C√ìDIGO COMPLETO E CORRIGIDO

import dotenv from 'dotenv';
import { resolve } from "path";
dotenv.config({ path: resolve("..", ".env") });

import { Sequelize } from "sequelize";

// escolhe host e porta com base no ambiente
const dbHost = process.env.DB_ENV === "docker"
  ? process.env.DB_HOST_DOCKER
  : process.env.DB_HOST_LOCAL;

const dbPort = process.env.DB_ENV === "docker"
  ? Number(process.env.DB_PORT_DOCKER)
  : Number(process.env.DB_PORT_LOCAL);

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASS,
  {
    host: dbHost,
    port: dbPort,
    dialect: process.env.DB_DIALECT || 'mysql',
    logging: false
  }
);

export const connectDB = async () => {
  try {
    await sequelize.authenticate();
    console.log('Conex√£o estabelecida com sucesso!!');
    await sequelize.sync({ alter: true });
    console.log('Tabelas sincronizadas com o banco!');
  } catch (error) {
    console.error('Erro ao conectar com o banco de dados:', error);
    process.exit(1);
  }
};

export default sequelize;


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\ApartamentoController.js
=================================================================================

import ApartamentoService from "../services/ApartamentoService.js";

export default class ApartamentoController {

    static async getConsumo(req, reply){
        const {id} = req.params;
        const consumoTotal = await ApartamentoService.getConsumoTotal(id);
        return reply.status(200).send(consumoTotal);
    }

}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\AuthController.js
=================================================================================

import UserService from "../services/AuthService.js";
import { registerUserSchema, loginUserSchema } from "../dtos/auth/authDTO.js";
import jwt from 'jsonwebtoken'

export default class UserController {

  static async register(request, reply) {
    try {
      const data = registerUserSchema.parse(request.body);

      const result = await UserService.register(data);
      return reply.code(201).send(result);
    } catch (error) {
      console.error("Erro ao registrar usu√°rio:", error);

      if (error?.issues) {
        return reply.code(400).send({ errors: error.issues });
      }

      return reply.code(400).send({ error: error.message });
    }
  }

  static async login(request, reply) {
    try {
      const data = loginUserSchema.parse(request.body);

      const user = await UserService.login(data);

      const token = jwt.sign(
        {
          id: user.id,
          email: user.email,
          role: user.role,
          type: user.type,
        },
        process.env.JWT_SECRET,
        { expiresIn: "7d" }
      );

      // A MUDAN√áA EST√Å AQUI: Retornamos o objeto 'user' completo
      // que j√° cont√©m residencia_id e residencia_type do banco.
      // E removemos o password antes de enviar.
      const userResponse = user.toJSON();
      delete userResponse.password;

      return reply.code(200).send({
        message: "Login realizado com sucesso",
        user: userResponse,
        token,
      });

    } catch (error) {
      console.error("Erro no login:", error);

      if (error?.issues) {
        return reply.code(400).send({ errors: error.issues });
      }

      return reply.code(400).send({ error: error.message });
    }
  }

  static async me(req, reply) {
    const userId = req.user.id; // obtido do authMiddleware
    const user = await UserService.getMe(userId);
    return reply.status(200).send({
      id: user.id,
      name: user.name,
      email: user.email,
      type: user.type,
      role: user.role,
      status: user.status
    });
  }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\CasaController.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\CasaController.js
// NOVO ARQUIVO

import CasaService from "../services/CasaService.js";

export default class CasaController {
    static async getConsumo(req, reply) {
        try {
            const { id } = req.params;
            const userId = req.user.id; // Obtido do middleware de autentica√ß√£o
            const consumo = await CasaService.getConsumoTotal(id, userId);
            return reply.status(200).send(consumo);
        } catch (error) {
            console.error(error);
            return reply.status(404).send({ error: error.message });
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\CepController.js
=================================================================================

import CepService from "../services/CepService.js";

export default class CepController {

    static async buscarCep(req, reply) {
        const { cep } = req.params;

        // salvando cep limpo
        const cepLimpo = cep.replace(/\D/g, '');

        if (!/^\d{8}$/.test(cepLimpo)) {
            return reply.status(400).send({ error: 'CEP inv√°lido' });
        }

        const endereco = await CepService.buscarCep(cepLimpo);
        return reply.send(endereco);
    }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\ComunicadosController.js
=================================================================================

import ComunicadosService from "../services/ComunicadosService.js";

export default class ComunicadosController {
    static async getAll(req, reply) {
        const comunicados = await ComunicadosService.getAll();
        return reply.status(200).send(comunicados);
    }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\DicaController.js
=================================================================================

import DicaService from "../services/DicaService.js";

export default class DicaController {
    static async getDicaDoDia(req, reply) {
        const dica = await DicaService.gerarDicaDoDia();
        return reply.status(200).send({dica});
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\MetasController.js
=================================================================================

import MetasService from "../services/MetasService.js";

export default class MetasController {
    static async getAll(req, reply){
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const metas = await MetasService.getAllMetas(page, limit);
        return reply.status(200).send(metas);
    }

    static async create(req, reply){
        const meta = await MetasService.createMeta(req.body);
        return reply.status(201).send(meta)
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\PasswordController.js
=================================================================================

// C:\Users\...\backend-mobile\src\controllers\PasswordController.js

import PasswordService from "../services/PasswordService.js";

export default class PasswordController {
    static async forgotPassword(req, reply) {
        try {
            const { email } = req.body;
            if (!email) {
                return reply.status(400).send({ error: 'O campo e-mail √© obrigat√≥rio.' });
            }
            // O servi√ßo agora sempre retorna uma mensagem gen√©rica por seguran√ßa
            await PasswordService.sendResetEmail(email);
            return reply.status(200).send({ message: 'Se um usu√°rio com este e-mail existir em nosso sistema, um c√≥digo de redefini√ß√£o foi enviado.' });
        } catch (error) {
            console.error('Erro em forgotPassword:', error);
            return reply.status(500).send({ error: 'Ocorreu um erro interno ao processar a solicita√ß√£o.' });
        }
    }

    static async resetPassword(req, reply) {
        try {
            const { token, newPassword } = req.body;
            if (!token || !newPassword) {
                return reply.status(400).send({ error: 'Token e nova senha s√£o obrigat√≥rios.' });
            }
            if (newPassword.length < 6) {
                return reply.status(400).send({ error: 'A senha deve ter no m√≠nimo 6 caracteres.' });
            }

            const result = await PasswordService.resetPassword(token, newPassword);
            return reply.status(200).send(result);
        } catch (error) {
            // Captura erros espec√≠ficos do servi√ßo para dar feedback claro ao usu√°rio
            if (error.message.includes('Token inv√°lido ou expirado')) {
                return reply.status(400).send({ error: error.message });
            }
            console.error("Erro em resetPassword:", error);
            return reply.status(500).send({ error: 'Ocorreu um erro interno ao redefinir a senha.' });
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\ProfileController.js
=================================================================================

import ProfileService from '../services/ProfileService.js';

class ProfileController {
  async getAuthenticatedUserProfile(request, reply) {
    try {
      const userId = request.user.id;

      if (!userId) {
        return reply.status(401).send({ message: 'Acesso n√£o autorizado.' });
      }

      const userProfile = await ProfileService.findProfileById(userId);

      if (!userProfile) {
        return reply.status(404).send({ message: 'Perfil de usu√°rio n√£o encontrado.' });
      }

      return reply.status(200).send(userProfile);
    } catch (error) {
        reply.status(500).send({ message: error.message });
    }
  }
}

export default new ProfileController();


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\UserController.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\controllers\UserController.js
// C√ìDIGO COMPLETO E CORRIGIDO

import UserService from "../services/UserService.js";

export default class UserController {
    static async updateMe(req, reply) {
        const userId = req.user.id;
        const user = await UserService.updateMe(userId, req.body);
        return reply.status(200).send({ message: 'Perfil atualizado com sucesso!', user });
    }

    // NOVO M√âTODO PARA RECEBER O UPLOAD
    static async uploadProfile(req, reply) {
        try {
            const userId = req.user.id;
            const file = await req.file();

            if (!file) {
                return reply.status(400).send({ error: 'Nenhum arquivo enviado.' });
            }

            const imageUrl = await UserService.uploadProfilePicture(userId, file);

            return reply.status(200).send({
                message: 'Foto de perfil atualizada com sucesso!',
                img_url: imageUrl
            });
        } catch (error) {
            console.error('Erro no controller de upload:', error);
            return reply.status(500).send({ error: 'Erro interno ao salvar a imagem.' });
        }
    }

    static async getStats(req, reply) {
        const userId = req.user.id;
        const stats = await UserService.getUserStats(userId);
        return reply.status(200).send(stats);
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\dtos\auth\authDTO.js
=================================================================================

import { z } from "zod";

export const registerUserSchema = z
  .object({
    // Dados b√°sicos do usu√°rio
    name: z.string().min(3, "O nome √© obrigat√≥rio."),
    email: z.string().email("Formato de e-mail inv√°lido."),
    cpf: z
      .string()
      .regex(/^\d{3}\.\d{3}\.\d{3}\-\d{2}$/, "CPF inv√°lido. Use o formato 000.000.000-00"),
    password: z.string().min(6, "A senha deve ter pelo menos 6 caracteres."),

    // Tipo de resid√™ncia
    residencia_type: z.enum(["casa", "apartamento"], {
      required_error: "O tipo de resid√™ncia √© obrigat√≥rio.",
    }),

    // Campos de resid√™ncia (simplificados)
    codigo_acesso: z.string().optional(), // usado para dependentes ou para criar ap√™ em condom√≠nio
    cep: z.string().optional(), // obrigat√≥rio apenas para casa nova
    numero: z.string().optional(), // n√∫mero da casa ou do ap√™
    bloco: z.string().optional(), // opcional para ap√™
    numero_moradores: z.coerce.number().optional(),
  })
  // üîπ Regra 1: CASA NOVA (sem c√≥digo de acesso)
  .refine(
    (data) => {
      if (data.residencia_type === "casa" && !data.codigo_acesso) {
        // casa nova precisa de cep e n√∫mero
        return !!data.cep && !!data.numero;
      }
      return true;
    },
    {
      message: "Para cadastrar uma nova casa, informe o CEP e o n√∫mero da resid√™ncia.",
      path: ["cep"],
    }
  )
  // üîπ Regra 2: DEPENDENTE DE CASA (com c√≥digo de acesso)
  .refine(
    (data) => {
      if (data.residencia_type === "casa" && data.codigo_acesso) {
        return true; // s√≥ precisa do c√≥digo
      }
      return true;
    },
    {
      message: "Informe o c√≥digo de acesso da casa do respons√°vel.",
      path: ["codigo_acesso"],
    }
  )
  // üîπ Regra 3: NOVO APARTAMENTO (c√≥digo do condom√≠nio + n√∫mero do ap√™)
  .refine(
    (data) => {
      if (data.residencia_type === "apartamento" && data.codigo_acesso) {
        return !!data.numero;
      }
      return true;
    },
    {
      message: "Para criar um novo apartamento, o n√∫mero do ap√™ √© obrigat√≥rio.",
      path: ["numero"],
    }
  )
  // üîπ Regra 4: DEPENDENTE DE APARTAMENTO (c√≥digo do ap√™ existente)
  .refine(
    (data) => {
      if (data.residencia_type === "apartamento" && !data.codigo_acesso) {
        return false; // n√£o pode cadastrar sem o c√≥digo do ap√™
      }
      return true;
    },
    {
      message: "Para entrar como dependente em um apartamento, informe o c√≥digo de acesso.",
      path: ["codigo_acesso"],
    }
  );

export const loginUserSchema = z.object({
  email: z.string().email("E-mail inv√°lido."),
  password: z.string().min(6, "A senha deve ter pelo menos 6 caracteres."),
});



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\middlewares\AuthMidlleweare.js
=================================================================================

import jwt from "jsonwebtoken";
import User from "../models/User.js";

export async function authMiddleware(request, reply) {
  try {
    const authHeader = request.headers.authorization;
    if (!authHeader) return reply.code(401).send({ error: "Token n√£o fornecido" });

    const token = authHeader.split(" ")[1];
    const decoded = jwt.verify(token, process.env.JWT_SECRET);

    const user = await User.findByPk(decoded.id);
    if (!user) return reply.code(401).send({ error: "Usu√°rio n√£o encontrado" });

    request.user = user;
  } catch (error) {
    return reply.code(401).send({ error: "Token inv√°lido" });
  }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\middlewares\errorHandler.js
=================================================================================

export default async function errorHandler(fastify) {
  fastify.setErrorHandler((err, req, reply) => {
    fastify.log.error({
      error: err.message,
      stack: err.stack,
      url: req.url,
      method: req.method,
      params: req.params,
      body: req.body,
    });

    if (err.name === "ZodError") {
      return reply.status(400).send({
        message: "Erro de valida√ß√£o dos dados",
        issues: err.errors,
      });
    }

    if (err.name === "SequelizeValidationError") {
      return reply.status(400).send({
        message: "Erro de valida√ß√£o no banco de dados",
        details: err.errors.map((e) => e.message),
      });
    }

    if (err.name === "SequelizeUniqueConstraintError") {
      return reply.status(409).send({
        message: "Registro j√° existe (viola√ß√£o de chave √∫nica)",
      });
    }

    if (err.statusCode === 401) {
      return reply.status(401).send({ message: "N√£o autorizado" });
    }

    if (err.statusCode === 403) {
      return reply.status(403).send({ message: "Acesso negado" });
    }

    const status = err.statusCode || 500;
    const message =
      err.message && status !== 500
        ? err.message
        : "Erro interno do servidor";

    reply.status(status).send({ message });
  });
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Apartamento.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Apartamento.js
// C√ìDIGO COMPLETO E CORRIGIDO

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import Condominio from "./Condominio.js";
import sequelizePaginate from 'sequelize-paginate'
import Sensor from "./Sensor.js";
import { nanoid } from 'nanoid';

export default class Apartamento extends Model { }

Apartamento.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    condominio_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { model: Condominio, key: 'id' }
    },
    numero: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    bloco: {
        type: DataTypes.STRING,
        allowNull: true
    },
    numero_moradores: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    sensor_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { model: Sensor, key: 'id' }
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        allowNull: false,
        defaultValue: 'ativo'
    },
    codigo_acesso: {
        type: DataTypes.CHAR(10),
        defaultValue: () => nanoid(5),
        allowNull: false,
        unique: true
    },
    responsavel_id: {
        type: DataTypes.CHAR(36),
        allowNull: true,
        references: { model: 'users', key: 'id' }
    }
}, {
    sequelize,
    tableName: 'apartamentos',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})

sequelizePaginate.paginate(Apartamento);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Casa.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Casa.js
// C√ìDIGO COMPLETO E CORRIGIDO

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import sequelizePaginate from 'sequelize-paginate'
import Sensor from "./Sensor.js";
import { nanoid } from "nanoid";

export const estados = {
    AC: "Acre", AL: "Alagoas", AP: "Amap√°", AM: "Amazonas", BA: "Bahia",
    CE: "Cear√°", DF: "Distrito Federal", ES: "Esp√≠rito Santo", GO: "Goi√°s",
    MA: "Maranh√£o", MT: "Mato Grosso", MS: "Mato Grosso do Sul", MG: "Minas Gerais",
    PA: "Par√°", PB: "Para√≠ba", PR: "Paran√°", PE: "Pernambuco", PI: "Piau√≠",
    RJ: "Rio de Janeiro", RN: "Rio Grande do Norte", RS: "Rio Grande do Sul",
    RO: "Rond√¥nia", RR: "Roraima", SC: "Santa Catarina", SP: "S√£o Paulo",
    SE: "Sergipe", TO: "Tocantins",
};

export default class Casa extends Model { }

Casa.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    logradouro: { type: DataTypes.STRING(255), allowNull: false },
    bairro: { type: DataTypes.STRING(255), allowNull: false },
    numero: { type: DataTypes.CHAR(10), allowNull: false },
    cidade: { type: DataTypes.STRING(100), allowNull: false },
    uf: { type: DataTypes.STRING(2), allowNull: false },
    estado: { type: DataTypes.STRING(50), allowNull: false },
    cep: { type: DataTypes.CHAR(10), allowNull: false },
    numero_moradores: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 1 },
    sensor_id: { type: DataTypes.INTEGER, allowNull: false, references: { model: Sensor, key: 'id' } },
    codigo_acesso: {
        type: DataTypes.CHAR(10),
        defaultValue: () => nanoid(5).replace(/[^a-zA-Z0-9]/g, '').toUpperCase(),
        allowNull: false,
        unique: true
    },
    status: { type: DataTypes.ENUM('ativo', 'inativo'), allowNull: false, defaultValue: 'ativo' },
    responsavel_id: { type: DataTypes.CHAR(36), allowNull: true, references: { model: 'users', key: 'id' } }
}, {
    sequelize,
    tableName: 'casas',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em',
    hooks: {
        beforeValidate: (casa) => {
            if (casa.uf) {
                casa.estado = estados[casa.uf] || casa.estado;
            }
        },
    },
})


sequelizePaginate.paginate(Casa);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Comunicados.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";

export default class Comunicados extends Model {}

Comunicados.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    title: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    subject: {
        type: DataTypes.TEXT,
        allowNull: false
    },
    addressee: {
        type: DataTypes.ENUM('adminstradores', 'usu√°rios'),
        allowNull: false
    }
}, {
    sequelize,
    tableName: 'comunicados',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Condominio.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import User from "./User.js";
import { nanoid } from 'nanoid';
import sequelizePaginate from 'sequelize-paginate'

export const estados = {
    AC: "Acre",
    AL: "Alagoas",
    AP: "Amap√°",
    AM: "Amazonas",
    BA: "Bahia",
    CE: "Cear√°",
    DF: "Distrito Federal",
    ES: "Esp√≠rito Santo",
    GO: "Goi√°s",
    MA: "Maranh√£o",
    MT: "Mato Grosso",
    MS: "Mato Grosso do Sul",
    MG: "Minas Gerais",
    PA: "Par√°",
    PB: "Para√≠ba",
    PR: "Paran√°",
    PE: "Pernambuco",
    PI: "Piau√≠",
    RJ: "Rio de Janeiro",
    RN: "Rio Grande do Norte",
    RS: "Rio Grande do Sul",
    RO: "Rond√¥nia",
    RR: "Roraima",
    SC: "Santa Catarina",
    SP: "S√£o Paulo",
    SE: "Sergipe",
    TO: "Tocantins",
};

export default class Condominio extends Model { }

Condominio.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    name: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    logradouro: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    numero: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    bairro: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    cidade: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    uf: {
        type: DataTypes.STRING(2),
        allowNull: false,
    },
    estado: {
        type: DataTypes.STRING(50),
        allowNull: false,
    },
    cep: {
        type: DataTypes.CHAR(9),
        allowNull: false
    },
    codigo_acesso: {
        type: DataTypes.CHAR(10),
        defaultValue: () => nanoid(5).replace(/[^a-zA-Z0-9]/g, '').toUpperCase(),
        allowNull: false,
        unique: true
    },
    sindico_id: {
        type: DataTypes.CHAR(36),
        allowNull: true,
        references: { model: User, key: 'id' }
    },
    status: {
        type: DataTypes.ENUM("ativo", 'inativo'),
        defaultValue: 'ativo',
        allowNull: false
    }
}, {
    sequelize,
    tableName: 'condominios',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em',

    hooks: {
        beforeValidate: (condominio) => {
            if (condominio.uf) {
                condominio.estado = estados[condominio.uf] || condominio.estado;
            }
        },
    },
})

sequelizePaginate.paginate(Condominio);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\GamificationLog.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import User from "./User.js";

export default class GamificationLog extends Model {}

GamificationLog.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    user_id: {
        type: DataTypes.CHAR(36),
        allowNull: false,
        references: { model: User, key: 'id' }
    },
    points: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    reason: {
        type: DataTypes.STRING,
        allowNull: false,
        comment: 'Ex: "Meta semanal conclu√≠da", "Economia de 50L"'
    },
    related_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'ID da meta ou outra entidade relacionada'
    },
    related_type: {
        type: DataTypes.STRING,
        allowNull: true,
        comment: 'Ex: "meta", "economia_diaria"'
    }
}, {
    sequelize,
    tableName: 'gamification_logs',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: false
});

GamificationLog.belongsTo(User, { foreignKey: 'user_id' });
User.hasMany(GamificationLog, { foreignKey: 'user_id' });


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\index.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\index.js
// NOVO ARQUIVO

import sequelize from '../config/sequelize.js';

// 1. Importar todos os modelos
import User from './User.js';
import Sensor from './Sensor.js';
import LeituraSensor from './LeituraSensor.js';
import Casa from './Casa.js';
import Apartamento from './Apartamento.js';
import Condominio from './Condominio.js';
import Metas from './Metas.js';
import PasswordReset from './PasswordReset.js';

// 2. Fun√ß√£o para criar as associa√ß√µes
const initializeAssociations = () => {
    // Rela√ß√£o Sensor <-> LeituraSensor
    Sensor.hasMany(LeituraSensor, { foreignKey: 'sensor_id', as: 'leituras' });
    LeituraSensor.belongsTo(Sensor, { foreignKey: 'sensor_id', as: 'sensor' });

    // Rela√ß√£o Resid√™ncias -> Sensor
    Apartamento.belongsTo(Sensor, { foreignKey: 'sensor_id', as: 'sensor' });
    Casa.belongsTo(Sensor, { foreignKey: 'sensor_id', as: 'sensor' });

    // Outras rela√ß√µes importantes
    Apartamento.belongsTo(Condominio, { foreignKey: 'condominio_id', as: 'condominio' });
    Condominio.hasMany(Apartamento, { foreignKey: 'condominio_id', as: 'apartamentos' });

    User.belongsTo(Casa, { foreignKey: 'residencia_id', constraints: false, as: 'casa' });
    User.belongsTo(Apartamento, { foreignKey: 'residencia_id', constraints: false, as: 'apartamento' });
};

// 3. Exportar tudo
export {
    sequelize,
    initializeAssociations,
    User,
    Sensor,
    LeituraSensor,
    Casa,
    Apartamento,
    Condominio,
    Metas,
    PasswordReset
};


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\LeituraSensor.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import sequelizePaginate from 'sequelize-paginate'

export default class LeituraSensor extends Model {}

LeituraSensor.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    sensor_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { 
            model: 'sensores', 
            key: 'id' 
        }
    },
    consumo: {
        type: DataTypes.DECIMAL(10, 2),
        allowNull: false
    },
    vazamento_detectado: {
        type: DataTypes.BOOLEAN,
        defaultValue: false
    },
    data_registro: {
        type: DataTypes.DATE,
        defaultValue: DataTypes.NOW
    }
}, {
    sequelize,
    tableName: 'leituras_sensores',
    timestamps: false
});

sequelizePaginate.paginate(LeituraSensor);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Metas.js
=================================================================================



import {Model, DataTypes } from 'sequelize';
import sequelize from '../config/sequelize.js';
import User from './User.js';
import sequelizePaginate from 'sequelize-paginate'

export default class Metas extends Model {}

Metas.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    user_id: {
        type: DataTypes.CHAR(36),
        allowNull: false,
        references: {model: User, key: 'id'}
    },
    residencia_type: {
        type: DataTypes.ENUM('casa', 'apartamento'),
        allowNull: false
    },
    residencia_id: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    periodo: {
        type: DataTypes.ENUM('7 dias', '14 dias', '30_dias'),
        allowNull: false
    },
    limite_consumo: {
        type: DataTypes.DECIMAL(10, 2),
        defaultValue: 0
    },
    status: {
        type: DataTypes.ENUM('em_andamento', 'atingida', 'excedida'),
        defaultValue: 'em_andamento'
    },
    inicio_periodo: {
        type: DataTypes.DATE,
        allowNull: false
    },
    fim_periodo: {
        type: DataTypes.DATE,
        allowNull: false
    }
}, {
    sequelize,
    tableName: 'metas_consumo',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})

sequelizePaginate.paginate(Metas);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\PasswordReset.js
=================================================================================

import { Model, DataTypes } from 'sequelize';
import sequelize from '../config/sequelize.js';
import { v4 as uuidv4 } from 'uuid';
import User from './User.js';

export default class PasswordReset extends Model { }

PasswordReset.init({
    id: {
        type: DataTypes.CHAR(36),
        primaryKey: true,
        defaultValue: () => uuidv4(),
    },
    user_id: {
        type: DataTypes.CHAR(36),
        allowNull: false,
        references: { model: User, key: "id" }
    },
    token: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    expira_em: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: () => new Date(Date.now() + 3600 * 1000) 
    }

}, {
    sequelize,
    tableName: 'password_resets',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: false
})



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\Sensor.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import { nanoid } from 'nanoid';
import sequelizePaginate from 'sequelize-paginate'
import LeituraSensor from "./LeituraSensor.js";

export default class Sensor extends Model { }

Sensor.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    codigo: {
        type: DataTypes.CHAR(10),
        defaultValue: () => nanoid(10),
        allowNull: false,
        unique: true
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        defaultValue: 'ativo'
    },
    consumo_total: {
        type: DataTypes.DECIMAL(10, 2),
        allowNull: false
    },
    ultimo_envio: {
  type: DataTypes.DATE,
  allowNull: true, 
  defaultValue: null
}
}, {
    sequelize,
    tableName: 'sensores',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})

Sensor.hasMany(LeituraSensor, { foreignKey: 'sensor_id' });

sequelizePaginate.paginate(Sensor);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\User.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\models\User.js
// C√ìDIGO COMPLETO E CORRIGIDO

import sequelize from "../config/sequelize.js";
import { DataTypes, Model } from "sequelize";
import { v4 as uuidv4 } from 'uuid';
import bcrypt from 'bcryptjs'
import sequelizePaginate from 'sequelize-paginate'

export default class User extends Model {
    async checkPassword(password) {
        return bcrypt.compare(password, this.password)
    }
}

User.init({
    id: {
        type: DataTypes.CHAR(36),
        primaryKey: true,
        defaultValue: () => uuidv4(),
    },
    name: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    email: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    cpf: {
        type: DataTypes.CHAR(14),
        allowNull: false
    },
    password: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    img_url: { // <<<<<<<<<<<< CAMPO ADICIONADO
        type: DataTypes.STRING,
        allowNull: true
    },
    type: {
        type: DataTypes.ENUM('casa', 'condominio'),
        allowNull: false
    },
    responsavel_id: {
        type: DataTypes.CHAR(36),
        allowNull: true,
        references: { model: 'users', key: 'id' }
    },
    residencia_type: {
        type: DataTypes.ENUM('casa', 'apartamento'),
        allowNull: true
    },
    residencia_id: {
        type: DataTypes.INTEGER,
        allowNull: true
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        defaultValue: 'ativo',
        allowNull: false
    },
    role: {
        type: DataTypes.ENUM('morador', 'sindico'),
        defaultValue: 'morador',
        allowNull: false
    },
    notif_vazamento: {
        type: DataTypes.BOOLEAN,
        defaultValue: true,
        allowNull: false
    },
    notif_consumo_alto: {
        type: DataTypes.BOOLEAN,
        defaultValue: true,
        allowNull: false
    },
    notif_metas: {
        type: DataTypes.BOOLEAN,
        defaultValue: true,
        allowNull: false
    },
    notif_comunidade: {
        type: DataTypes.BOOLEAN,
        defaultValue: false,
        allowNull: false
    },
    notif_relatorios: {
        type: DataTypes.BOOLEAN,
        defaultValue: true,
        allowNull: false
    }
}, {
    sequelize,
    tableName: 'users',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em',
    hooks: {
        beforeCreate: async (user, options) => {
            if (user.password) {
                const salt = await bcrypt.genSalt(10);
                user.password = await bcrypt.hash(user.password, salt);
            }
        },
        beforeUpdate: async (user, options) => {
            if (user.changed('password')) {
                const salt = await bcrypt.genSalt(10);
                user.password = await bcrypt.hash(user.password, salt)
            }
        }
    }
})

sequelizePaginate.paginate(User);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\apartamento.routes.js
=================================================================================

import ApartamentoController from "../controllers/ApartamentoController.js";

export default async function apartamentoRoutes(fastify) {

    fastify.get('/:id/consumo-total',
        {
            schema: {
                summary: 'Consumo total de cada apartamento de usu√°rio',
                tags: ['apartamentos'],
                description: 'Listando consumo total da residencia (apartamento) do usu√°rio'
            }
        },
        ApartamentoController.getConsumo);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\auth.routes.js
=================================================================================

import UserController from "../controllers/AuthController.js";
import { authMiddleware } from "../middlewares/AuthMidlleweare.js"

export default async function authRoutes(fastify) {
  fastify.post("/register", 
    {
      schema: {
        summary: 'Cadastrando um novo usu√°rio',
        tags: ['autentica√ß√£o'],
        description: 'Registrando um novo usu√°rio no sistema mobile'
      }
    },
    UserController.register);

  fastify.post("/login",
    {
      schema: {
        summary: 'Login do usu√°rio',
        tags: ['autentica√ß√£o'],
        description: 'Rota para o usu√°rio poder fazer o login e entrar no seu app'
      }
    },
    UserController.login);

  fastify.get('/me', 
    {
      schema: {
        summary: "Informa√ß√µes do usu√°rio",
        tags: ['autentica√ß√£o'],
        description: 'Rota para a API puxar as informa√ß√µes do usu√°rio logado'
      }
      ,preHandler: authMiddleware 
    },
      UserController.me);
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\casa.routes.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\casa.routes.js
// NOVO ARQUIVO

import CasaController from "../controllers/CasaController.js";
import { authMiddleware } from "../middlewares/AuthMidlleweare.js";

export default async function casaRoutes(fastify) {
    fastify.get('/:id/consumo-total',
        {
            preHandler: [authMiddleware], // Protegendo a rota
            schema: {
                summary: 'Consumo total de uma casa',
                tags: ['casas'],
                description: 'Lista o consumo total da resid√™ncia (casa) do usu√°rio autenticado.'
            }
        },
        CasaController.getConsumo
    );
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\cep.routes.js
=================================================================================

import CepController from "../controllers/CepController.js";

export default async function cepRoutes(fastify) {
  fastify.get("/:cep",
    {
      schema: {
        summary: "API CEP",
        tags: ['cep'],
        descriptio: 'API para completar o cep automaticamente'
      }
    },
    CepController.buscarCep);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\comunicados.routes.js
=================================================================================

import ComunicadosController from "../controllers/ComunicadosController.js";

export default async function comunicadosRoutes(fastify){
    fastify.get('/', ComunicadosController.getAll);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\dica.routes.js
=================================================================================

import DicaController from "../controllers/DicaController.js";

export default async function dicaRoutes(fastify){
    fastify.get('/', 
        {
            schema: {
                summary: 'API GEMINI do qual destaca uma dica do dia para economizar',
                tags: ['dica-do-dia'],
                description: 'Dica do dia para o usu√°rio'
            }
        },
        DicaController.getDicaDoDia);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\metas.routes.js
=================================================================================

import MetasController from "../controllers/MetasController.js";

export default async function metasRoutes(fastify) {
    fastify.get('/',
        {
            schema: {
                summary: 'Listando todas as metas do usu√°rio',
                tags: ['metas'],
                description: 'Metas do usu√°rio referente ao consumo.'
            }
        },
        MetasController.getAll);

    fastify.post('/', 
        {
            schema: {
                summary: 'Criando uma nova meta',
                tags: ['metas'],
                description: 'Criando uma nova meta referente ao consumo de √°gua planejada durante determinado tempo'
            }
        },
        MetasController.create);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\password.routes.js
=================================================================================

import PasswordController from "../controllers/PasswordController.js";

export default async function passwordRoutes(fastify) {

    fastify.post('/forgot', {
        schema: {
            summary: 'Pedido de troca de senha',
            tags: ['forgot-password'],
            description: 'Requisi√ß√£o enviada ao servidor para efetuar a troca de senha'
        }
    }, PasswordController.forgotPassword);

    fastify.post('/reset', {
        schema: {
            summary: 'Resetando e definindo uma nova senha',
            tags: ['forgot-password'],
            description: 'Troca de senha de conta pessoal do usu√°rio'
        }
    }, PasswordController.resetPassword);
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\profile.routes.js
=================================================================================

import ProfileController from '../controllers/ProfileController.js';
import { authMiddleware } from '../middlewares/AuthMidlleweare.js';

async function profileRoutes(fastify, options) {
  fastify.get(
    '/', {
      schema: {
        summary: 'Rota para puxar as informa√ß√µes pessoal do usu√°rio',
        tags: ['profile'],
        description: 'Listando informa√ß√µes do usu√°rio'
      },
      preHandler: [authMiddleware],
    },
  
    ProfileController.getAuthenticatedUserProfile
  );
}

export default profileRoutes;


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\routes\user.routes.js
=================================================================================


import UserController from "../controllers/UserController.js";
import { authMiddleware } from "../middlewares/AuthMidlleweare.js";

export default async function userRoutes(fastify) {
    fastify.put('/me', {
        schema: {
            summary: 'Alterando informa√ß√µes pessoal',
            tags: ['users'],
            description: 'Listando informa√ß√µes do usu√°rio'
        },
        preHandler: [authMiddleware]
    }, UserController.updateMe);


    fastify.post('/upload-img', {
        schema: {
            summary: 'Upload da foto de perfil do usu√°rio',
            tags: ['users'],
            description: 'Envia uma imagem para ser usada como foto de perfil do usu√°rio logado.'
        },
        preHandler: [authMiddleware]
    }, UserController.uploadProfile);

    fastify.get('/me/stats', {
        schema: {
            summary: 'Puxa as estat√≠sticas do usu√°rio logado',
            tags: ['users'],
            description: 'Retorna dados como metas cumpridas, pontos, etc.'
        },
        preHandler: [authMiddleware]
    }, UserController.getStats);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\server.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\server.js
// C√ìDIGO COMPLETO E CORRIGIDO

import dotenv from 'dotenv';
import { resolve } from "path";
dotenv.config({ path: resolve("..", ".env") });
import app from "./app.js";
import { connectDB } from "./config/sequelize.js";
import { initializeAssociations } from './models/index.js'; // Importa a fun√ß√£o de associa√ß√µes

const PORT = 3334;

const start = async () => {
    try {
        // 1. Conecta ao banco de dados primeiro
        await connectDB();
        
        // 2. Depois de conectar, inicializa as associa√ß√µes dos modelos
        initializeAssociations();
        console.log('Associa√ß√µes entre modelos foram inicializadas com sucesso!');

        // 3. Finalmente, inicia o servidor
        await app.listen({
            host: '0.0.0.0', port: PORT
        });
        
        // A mensagem de "Server listening" agora √© mais precisa
        
    } catch (error){
        console.error('Erro fatal ao iniciar o servidor:', error);
        process.exit(1);
    }
}

start();


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\ApartamentoService.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\ApartamentoService.js
// C√ìDIGO COMPLETO E CORRIGIDO

import Apartamento from "../models/Apartamento.js";
import LeituraSensor from "../models/LeituraSensor.js"; // 1. Importa o modelo das leituras

export default class ApartamentoService {

    static async getConsumoTotal(apartamentoId) {
        try {

            const apartamento = await Apartamento.findByPk(apartamentoId);

            if (!apartamento) {
                throw new Error('Apartamento n√£o encontrado');
            }
            if (!apartamento.sensor_id) {
                throw new Error('Apartamento n√£o possui um sensor associado.');
            }


            const consumoTotal = await LeituraSensor.sum('consumo', {
                where: {
                    sensor_id: apartamento.sensor_id
                }
            });


            return { consumoTotal: consumoTotal || 0 };

        } catch (error) {
            console.error('Erro ao listar consumo total do seu apartamento', error);
            throw error;
        }
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\AuthService.js
=================================================================================

import User from "../models/User.js";
import Casa from "../models/Casa.js";
import Apartamento from "../models/Apartamento.js";
import Condominio from "../models/Condominio.js";
import Sensor from "../models/Sensor.js";
import CepService from "./CepService.js";
import bcrypt from "bcryptjs";
import { nanoid } from "nanoid";

export default class UserService {

  static async register(data) {
    const {
      name, email, cpf, password,
      residencia_type, codigo_acesso,
      cep, numero, bloco, numero_moradores
    } = data;

    if (!residencia_type)
      throw new Error("O tipo de resid√™ncia √© obrigat√≥rio (casa ou apartamento).");

    // ======================================
    // RESPONS√ÅVEL DE CASA
    // ======================================
    if (residencia_type === "casa" && !codigo_acesso) {
      if (!cep || !numero)
        throw new Error("CEP e n√∫mero s√£o obrigat√≥rios para criar uma nova casa.");

      const endereco = await CepService.buscarCep(cep);

      const user = await User.create({
        name,
        email,
        cpf,
        password,
        type: "casa",
        role: "morador",
        residencia_type: "casa",
        responsavel_id: null
      });

      const sensor = await Sensor.create({
        codigo: nanoid(10).toUpperCase(),
        status: "ativo",
        consumo_total: 0
      });

      const casa = await Casa.create({
        logradouro: endereco.logradouro,
        bairro: endereco.bairro,
        numero,
        cidade: endereco.cidade,
        uf: endereco.uf,
        estado: endereco.uf,
        cep: endereco.cep,
        numero_moradores: parseInt(numero_moradores, 10) || 1,
        sensor_id: sensor.id,
        codigo_acesso: nanoid(6).toUpperCase(),
        responsavel_id: user.id
      });

      user.residencia_id = casa.id;
      await user.save();

      return { message: "Usu√°rio respons√°vel (casa) criado com sucesso.", user, residencia: casa, sensor };
    }

    // ======================================
    // DEPENDENTE DE CASA
    // ======================================
    if (residencia_type === "casa" && codigo_acesso) {
      const casa = await Casa.findOne({ where: { codigo_acesso } });
      if (!casa) throw new Error("C√≥digo de acesso inv√°lido.");
      if (!casa.responsavel_id) throw new Error("Esta casa ainda n√£o possui um morador respons√°vel.");

      const user = await User.create({
        name, email, cpf, password,
        type: "casa",
        role: "morador",
        residencia_type: "casa",
        residencia_id: casa.id,
        responsavel_id: casa.responsavel_id
      });

      casa.numero_moradores += 1;
      await casa.save();

      return { message: "Usu√°rio dependente (casa) criado com sucesso.", user, residencia: casa };
    }

    // ======================================
    // RESPONS√ÅVEL DE APARTAMENTO
    // ======================================
    if (residencia_type === "apartamento" && codigo_acesso) {
      const condominio = await Condominio.findOne({ where: { codigo_acesso } });
      if (!condominio)
        throw new Error("C√≥digo de acesso do condom√≠nio inv√°lido.");
      if (!numero)
        throw new Error("N√∫mero do apartamento √© obrigat√≥rio.");

      const user = await User.create({
        name, email, cpf, password,
        type: "condominio",
        role: "morador",
        residencia_type: "apartamento"
      });

      const sensor = await Sensor.create({
        codigo: nanoid(10).toUpperCase(),
        status: "ativo",
        consumo_total: 0
      });

      const apartamento = await Apartamento.create({
        condominio_id: condominio.id,
        numero,
        bloco: bloco || null,
        codigo_acesso: nanoid(6).toUpperCase(),
        numero_moradores: parseInt(numero_moradores, 10) || 1,
        sensor_id: sensor.id,
        responsavel_id: user.id
      });

      user.residencia_id = apartamento.id;
      await user.save();

      return { message: "Usu√°rio respons√°vel (apartamento) criado com sucesso.", user, residencia: apartamento, sensor };
    }

    // ======================================
    // DEPENDENTE DE APARTAMENTO
    // ======================================
    const apartamentoExistente = await Apartamento.findOne({ where: { codigo_acesso } });
    if (apartamentoExistente) {
      if (!apartamentoExistente.responsavel_id)
        throw new Error("Este apartamento ainda n√£o possui um morador respons√°vel.");

      const user = await User.create({
        name, email, cpf, password,
        type: "condominio",
        role: "morador",
        residencia_type: "apartamento",
        residencia_id: apartamentoExistente.id,
        responsavel_id: apartamentoExistente.responsavel_id
      });

      apartamentoExistente.numero_moradores += 1;
      await apartamentoExistente.save();

      return { message: "Usu√°rio dependente (apartamento) criado com sucesso.", user, residencia: apartamentoExistente };
    }

    throw new Error("Fluxo de cadastro inv√°lido.");
  }

  // ======================================
  // LOGIN
  // ======================================
  static async login({ email, password }) {
    const user = await User.findOne({ where: { email } });
    if (!user) throw new Error("E-mail ou senha inv√°lidos.");

    const valid = await bcrypt.compare(password, user.password);
    if (!valid) throw new Error("E-mail ou senha inv√°lidos.");

    return user;
  }

  // ======================================
  // PERFIL
  // ======================================
  static async getMe(userId) {
    const user = await User.findByPk(userId, {
      attributes: { exclude: ["password"] }
    });
    if (!user) throw new Error("Usu√°rio n√£o encontrado");
    return user;
  }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\CasaService.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\CasaService.js
// C√ìDIGO COMPLETO E CORRIGIDO

import Casa from "../models/Casa.js";
import User from "../models/User.js";
import LeituraSensor from "../models/LeituraSensor.js"; // 1. Importa o modelo das leituras

export default class CasaService {

    static async getConsumoTotal(casaId, userId) {
        try {
            const user = await User.findByPk(userId);
            if (!user || user.residencia_id !== parseInt(casaId, 10) || user.residencia_type !== 'casa') {
                throw new Error('Acesso n√£o autorizado ou resid√™ncia n√£o encontrada.');
            }

            // 2. Busca a casa para encontrar o ID do sensor
            const casa = await Casa.findByPk(casaId);

            if (!casa) {
                throw new Error('Casa n√£o encontrada');
            }
            if (!casa.sensor_id) {
                throw new Error('Casa n√£o possui um sensor associado.');
            }

            // 3. Soma o consumo da tabela de leituras
            const consumoTotal = await LeituraSensor.sum('consumo', {
                where: {
                    sensor_id: casa.sensor_id
                }
            });

            // 4. Retorna o valor somado no formato esperado
            return { consumoTotal: consumoTotal || 0 };
            
        } catch (error) {
            console.error('Erro ao buscar consumo total da casa:', error);
            throw error;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\CepService.js
=================================================================================

import axios from 'axios';

export default class CepService {
  static async buscarCep(cep) {
    try {
      const response = await axios.get(`https://viacep.com.br/ws/${cep}/json/`);

      if (response.data.erro) {
        throw new Error('CEP n√£o encontrado');
      }

      return {
        logradouro: response.data.logradouro,
        bairro: response.data.bairro,
        cidade: response.data.localidade,
        uf: response.data.uf,
        cep: response.data.cep
      };
    } catch (error) {
      console.error('Erro ao buscar CEP:', error.message);
      throw new Error('N√£o foi poss√≠vel consultar o CEP');
    }
  }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\ComunicadosService.js
=================================================================================

import Comunicados from "../models/Comunicados.js";

export default class ComunicadosService {
    static async getAll(req, reply){
        try {
            const comunicados = await Comunicados.findAll({
                where: {addressee: 'usu√°rios'}
            });
            return comunicados;
        } catch (error) {
            console.error('Erro ao listar comunicados', error);
            throw error;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\DicaService.js
=================================================================================

import axios from "axios";

export default class DicaService {
    static async gerarDicaDoDia() {
        const apiKey = process.env.GEMINI_API_KEY;

        const prompt = `
¬† ¬†      Gere uma dica curta (at√© 200 caracteres) sobre consumo consciente e economia de recursos,
¬† ¬†      especialmente √°gua e energia. Use uma linguagem simples, inspiradora e pr√°tica.
¬† ¬†      Exemplo: "Desligue o chuveiro enquanto se ensaboa ‚Äî economiza at√© 30 litros por banho!"
¬† ¬†      `;

        try {
            const response = await axios.post(
                "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
                { contents: [{ parts: [{ text: prompt }] }] },
                {
                    headers: { "Content-Type": "application/json" },
                    params: { key: apiKey },
                }
            );

            const dica =
                response.data?.candidates?.[0]?.content?.parts?.[0]?.text ||
                "Economize energia desligando luzes desnecess√°rias.";

            return dica.trim();
        } catch (error) {
            console.error("Erro na chamada da API Gemini:", error.message);
            return "Erro ao gerar a dica do dia. Lembre-se: pequenas a√ß√µes geram grandes economias!";
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\EmailService.js
=================================================================================

import nodemailer from 'nodemailer';

// Converte a porta para n√∫mero a partir do .env
const EMAIL_PORT = parseInt(process.env.EMAIL_PORT, 10);

// Cria o transporter. A op√ß√£o 'secure' ser√° 'true' se a porta for 465.
const transporter = nodemailer.createTransport({
    host: process.env.EMAIL_HOST,
    port: EMAIL_PORT,
    secure: EMAIL_PORT === 465,
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS,
    },
});

const sendPasswordResetEmail = async (to, token) => {
    const mailOptions = {
        from: `"Aqua Services" <${process.env.EMAIL_USER}>`,
        to: to,
        subject: 'Seu C√≥digo de Redefini√ß√£o de Senha - Aqua Services',
        html: `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Redefini√ß√£o de Senha</title>
            <style>
                body { margin: 0; padding: 0; background-color: #f4f7f6; }
                table, td, a { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
                table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }
                img { -ms-interpolation-mode: bicubic; border: 0; outline: none; text-decoration: none; }
                table { border-collapse: collapse !important; }
            </style>
        </head>
        <body style="margin: 0 !important; padding: 0 !important; background-color: #f4f7f6;">
            <!-- Texto de Preheader (vis√≠vel na pr√©via do e-mail) -->
            <div style="display: none; font-size: 1px; color: #fefefe; line-height: 1px; max-height: 0px; max-width: 0px; opacity: 0; overflow: hidden;">
                Seu c√≥digo de verifica√ß√£o da Aqua Services est√° aqui.
            </div>

            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                <tr>
                    <td align="center" style="padding: 40px 15px;">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">
                            
                            <!-- HEADER -->
                            <tr>
                                <td align="center" style="padding: 30px 20px; background-color: #007bff; border-radius: 12px 12px 0 0;">
                                    <h1 style="font-family: 'Arial Black', Gadget, sans-serif; font-size: 32px; color: #ffffff; margin: 0; letter-spacing: 1px;">Aqua Services</h1>
                                </td>
                            </tr>
                            
                            <!-- CORPO DO CONTE√öDO -->
                            <tr>
                                <td align="left" style="padding: 40px 30px; background-color: #ffffff; border-radius: 0 0 12px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                                    <h2 style="font-family: Arial, sans-serif; font-size: 24px; color: #333333; margin: 0 0 20px;">Redefini√ß√£o de Senha</h2>
                                    <p style="font-family: Arial, sans-serif; font-size: 16px; color: #555555; line-height: 1.6; margin: 0 0 25px;">
                                        Ol√°,
                                    </p>
                                    <p style="font-family: Arial, sans-serif; font-size: 16px; color: #555555; line-height: 1.6; margin: 0 0 25px;">
                                        Recebemos uma solicita√ß√£o para redefinir a senha da sua conta. Para continuar, use o c√≥digo de verifica√ß√£o abaixo no seu aplicativo.
                                    </p>
                                    
                                    <!-- CAIXA DO C√ìDIGO -->
                                    <table border="0" cellspacing="0" cellpadding="0" width="100%">
                                        <tr>
                                            <td align="center" style="background-color: #f0f5ff; border-radius: 8px; border: 2px dashed #a0c4ff; padding: 25px 20px;">
                                                <p style="font-family: 'Courier New', Courier, monospace; font-size: 36px; font-weight: bold; letter-spacing: 6px; margin: 0; color: #004aad;">
                                                    ${token}
                                                </p>
                                            </td>
                                        </tr>
                                    </table>

                                    <p style="font-family: Arial, sans-serif; font-size: 14px; color: #777777; line-height: 1.6; margin: 25px 0 0; text-align: center;">
                                        Este c√≥digo expira em <strong>10 minutos</strong>.
                                    </p>
                                    <p style="font-family: Arial, sans-serif; font-size: 16px; color: #555555; line-height: 1.6; margin: 30px 0 0;">
                                        Se voc√™ n√£o solicitou esta altera√ß√£o, pode ignorar este e-mail com seguran√ßa.
                                    </p>
                                    <p style="font-family: Arial, sans-serif; font-size: 16px; color: #555555; line-height: 1.6; margin: 30px 0 0;">
                                        Atenciosamente,<br>Equipe Aqua Services
                                    </p>
                                </td>
                            </tr>
                            
                            <!-- RODAP√â -->
                            <tr>
                                <td align="center" style="padding: 30px 10px 0;">
                                    <p style="font-family: Arial, sans-serif; font-size: 12px; color: #999999; margin: 0;">
                                        ¬© 2025 Aqua Services. Todos os direitos reservados.
                                    </p>
                                    <p style="font-family: Arial, sans-serif; font-size: 12px; color: #999999; margin: 5px 0 0;">
                                        Esta √© uma mensagem autom√°tica, por favor, n√£o responda.
                                    </p>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </body>
        </html>
        `
    };

    try {
        await transporter.sendMail(mailOptions);
        console.log(`E-mail de redefini√ß√£o enviado com sucesso para: ${to}`);
    } catch (error) {
        console.error('ERRO DETALHADO AO ENVIAR E-MAIL:', error);
        throw new Error('Falha na comunica√ß√£o com o servidor de e-mail. Verifique as credenciais e a configura√ß√£o de porta/seguran√ßa.');
    }
};

export { sendPasswordResetEmail };


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\GamificationService.js
=================================================================================

import GamificationLog from '../models/GamificationLog.js';

const PONTOS_POR_META_ATINGIDA = 50;

export default class GamificationService {

    static async awardPointsForCompletedGoal(userId, meta) {
        try {
            const reason = `Meta '${meta.periodo}' conclu√≠da com sucesso.`;
            await GamificationLog.create({
                user_id: userId,
                points: PONTOS_POR_META_ATINGIDA,
                reason: reason,
                related_id: meta.id,
                related_type: 'meta'
            });
            console.log(`+${PONTOS_POR_META_ATINGIDA} pontos para o usu√°rio ${userId} por completar a meta ${meta.id}.`);
            return { success: true };
        } catch (error) {
            console.error('Erro ao atribuir pontos por meta conclu√≠da:', error);
            throw error;
        }
    }

    static async awardPointsForWaterSaved(userId, litersSaved) {
        try {
            // L√≥gica simples: 1 ponto a cada 20 litros economizados
            const points = Math.floor(litersSaved / 20);
            if (points > 0) {
                await GamificationLog.create({
                    user_id: userId,
                    points: points,
                    reason: `Economia de ${litersSaved.toFixed(2)}L de √°gua.`,
                    related_type: 'economia'
                });
                console.log(`+${points} pontos para o usu√°rio ${userId} por economizar √°gua.`);
            }
            return { success: true };
        } catch (error) {
            console.error('Erro ao atribuir pontos por economia de √°gua:', error);
            throw error;
        }
    }

    static async calculateTotalPoints(userId) {
        try {
            const totalPoints = await GamificationLog.sum('points', {
                where: { user_id: userId }
            });
            return totalPoints || 0;
        } catch (error) {
            console.error(`Erro ao calcular pontos totais para o usu√°rio ${userId}:`, error);
            return 0;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\MetasService.js
=================================================================================

import Metas from "../models/Metas.js";
import User from "../models/User.js";
import GamificationService from "./GamificationService.js"; // Importado

export default class MetasService {

    static async getAllMetas(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']]
            }
            const metas = Metas.paginate(options);
            return metas;
        } catch (error) {
            console.error('Erro ao listar metas do usu√°rio', error);
            throw error;
        }
    }

    static async createMeta({ userId, data }) {
        try {
            const user = await User.findByPk(userId);
            if (!user) throw new Error("Usu√°rio n√£o encontrado");

            const { residencia_id, residencia_type, periodo, limite_consumo, inicio_periodo } = data;

            const meta = await Metas.create({ 
                user_id: userId,
                residencia_id, 
                residencia_type, 
                periodo, 
                limite_consumo, 
                inicio_periodo 
            });


            return meta;
        } catch (error) {
            console.error("Erro ao criar meta", error);
            throw error;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\PasswordService.js
=================================================================================

// C:\Users\...\backend-mobile\src\services\PasswordService.js

import bcrypt from 'bcryptjs';
import crypto from 'crypto';
import User from '../models/User.js';
import PasswordReset from '../models/PasswordReset.js';
import { sendPasswordResetEmail } from './EmailService.js'; 

export default class PasswordService {
    static async sendResetEmail(email) {
        const user = await User.findOne({ where: { email } });
        if (!user) {
            console.log(`Tentativa de reset para e-mail n√£o cadastrado: ${email}`);
            return { message: 'Se um usu√°rio com este e-mail existir, um c√≥digo foi enviado.' };
        }

        const token = crypto.randomInt(100000, 999999).toString();
        const expira_em = new Date(Date.now() + 10 * 60 * 1000);

        await PasswordReset.destroy({ where: { user_id: user.id } });
        await PasswordReset.create({ user_id: user.id, token, expira_em });

        await sendPasswordResetEmail(user.email, token);

        return { message: 'E-mail de redefini√ß√£o enviado com sucesso!' };
    }

    static async resetPassword(token, newPassword) {
        const reset = await PasswordReset.findOne({ where: { token } });

        if (!reset || reset.expira_em < new Date()) {
            if (reset) await reset.destroy();
            throw new Error('Token inv√°lido ou expirado. Por favor, solicite um novo.');
        }

        const user = await User.findByPk(reset.user_id);
        if (!user) throw new Error("Usu√°rio n√£o encontrado.");

        // <-- CORRE√á√ÉO PRINCIPAL AQUI
        // Atribu√≠mos a nova senha em texto plano.
        // O hook 'beforeUpdate' no modelo User.js se encarregar√° de fazer o hash.
        user.password = newPassword;
        
        // Ao chamar .save(), o hook ser√° ativado e far√° o hash corretamente.
        await user.save();

        await reset.destroy(); // Remove o token ap√≥s o uso
        return { message: 'Senha redefinida com sucesso!' };
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\ProfileService.js
=================================================================================

// AQUI: Adicionamos .js ao final de sequelize
import sequelize from '../config/sequelize.js';

class ProfileService {
  async findProfileById(id) {
    try {
      const [profile] = await sequelize.query(
        'SELECT * FROM vw_users WHERE user_id = :id LIMIT 1',
        {
          replacements: { id: id },
          type: sequelize.QueryTypes.SELECT,
        }
      );
      return profile;
    } catch (error) {
      console.error('Erro no ProfileService:', error);
      throw new Error('Erro ao buscar dados do perfil.');
    }
  }
}

export default new ProfileService();


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\UserService.js
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-mobile\src\services\UserService.js
// C√ìDIGO COMPLETO E CORRIGIDO

import { Op } from 'sequelize';
import User from "../models/User.js";
import Metas from "../models/Metas.js";
import LeituraSensor from '../models/LeituraSensor.js';
import Casa from '../models/Casa.js';
import Apartamento from '../models/Apartamento.js';
import GamificationService from './GamificationService.js';
import sequelize from '../config/sequelize.js';
import GamificationLog from '../models/GamificationLog.js';
import path from 'path'; // <<<<<<< IMPORTADO
import fs from 'fs';   // <<<<<<< IMPORTADO

const PRECO_POR_LITRO = 0.015; // R$ 0,015 por litro (valor exemplo)

export default class UserService {
    static async updateMe(userId, data) {
        try {
            const user = await User.findByPk(userId);
            if (!user) throw new Error('Usu√°rio n√£o encontrado');

            const allowedUpdates = [
                'name', 'email',
                'notif_vazamento', 'notif_consumo_alto', 'notif_metas',
                'notif_comunidade', 'notif_relatorios'
            ];

            const updateData = {};
            for (const key of allowedUpdates) {
                if (data[key] !== undefined) {
                    updateData[key] = data[key];
                }
            }

            await user.update(updateData);

            return user;
        } catch (error) {
            console.error('Erro ao atualizar usu√°rio', error);
            throw error;
        }
    }

    // NOVO M√âTODO PARA UPLOAD DE FOTO DE PERFIL
    static async uploadProfilePicture(userId, file) {
        try {
            const user = await User.findByPk(userId);
            if (!user) throw new Error('Usu√°rio n√£o encontrado');

            const uploadDir = path.join(process.cwd(), 'uploads');

            if (!fs.existsSync(uploadDir)) {
                fs.mkdirSync(uploadDir, { recursive: true });
            }

            const fileName = `user-${userId}-${Date.now()}-${file.filename}`;
            const filePath = path.join(uploadDir, fileName);

            const buffer = await file.toBuffer();
            await fs.promises.writeFile(filePath, buffer);

            const fileUrl = `/api/uploads/${fileName}`;
            user.img_url = fileUrl;
            await user.save();

            return fileUrl;
        } catch (error) {
            console.error('Erro ao salvar foto de perfil do usu√°rio', error);
            throw new Error('Erro interno ao processar a imagem.');
        }
    }

    static async getUserStats(userId) {
        try {
            const user = await User.findByPk(userId, {
                include: [
                    { model: Casa, as: 'casa' },
                    { model: Apartamento, as: 'apartamento' }
                ]
            });
            if (!user) throw new Error('Usu√°rio n√£o encontrado');

            const hoje = new Date();
            const dataCriacao = new Date(user.criado_em);
            const diffTime = Math.abs(hoje - dataCriacao);
            const tempo_no_app = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const metas_cumpridas = await Metas.count({
                where: { user_id: userId, status: 'atingida' }
            });

            let agua_poupada = 0;
            const metasAtingidas = await Metas.findAll({ where: { user_id: userId, status: 'atingida' } });

            const sensorId = user.residencia_type === 'casa' ? user.casa?.sensor_id : user.apartamento?.sensor_id;

            if (sensorId) {
                for (const meta of metasAtingidas) {
                    const consumoNoPeriodo = await LeituraSensor.sum('consumo', {
                        where: {
                            sensor_id: sensorId,
                            data_registro: { [Op.between]: [meta.inicio_periodo, meta.fim_periodo] }
                        }
                    });
                    const economia = parseFloat(meta.limite_consumo) - (consumoNoPeriodo || 0);
                    if (economia > 0) {
                        agua_poupada += economia;
                    }
                }
            }

            const economia_total = agua_poupada * PRECO_POR_LITRO;

            const pontos = await GamificationService.calculateTotalPoints(userId);

            const userScores = await GamificationLog.findAll({
                attributes: ['user_id', [sequelize.fn('SUM', sequelize.col('points')), 'total_points']],
                group: ['user_id'],
                order: [[sequelize.fn('SUM', sequelize.col('points')), 'DESC']],
                raw: true
            });

            const userRankIndex = userScores.findIndex(score => score.user_id === userId);
            const ranking = userRankIndex !== -1 ? userRankIndex + 1 : userScores.length + 1;

            return {
                tempo_no_app: tempo_no_app || 0,
                metas_cumpridas: metas_cumpridas || 0,
                pontos: pontos || 0,
                ranking: ranking || 0,
                economia_total: parseFloat(economia_total.toFixed(2)) || 0,
                agua_poupada: parseFloat(agua_poupada.toFixed(2)) || 0
            };

        } catch (error) {
            console.error('Erro ao buscar estat√≠sticas do usu√°rio', error);
            throw error;
        }
    }
}


#################################################################################
IN√çCIO DA AN√ÅLISE DE: C:\Users\24250553\Documents\3mdR\aqua\User-App\User-App\screens
#################################################################################

=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\User-App\User-App\screens\Inicio.jsx
=================================================================================

import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { ScrollView, StyleSheet, View, Dimensions, ActivityIndicator, RefreshControl } from 'react-native';
import { 
  Provider as PaperProvider, 
  DefaultTheme, 
  Card, 
  Text, 
  SegmentedButtons, 
  Title, 
  Paragraph, 
  List,
  Surface,
  ProgressBar,
  Button
} from 'react-native-paper';
import { LineChart } from 'react-native-gifted-charts';
import 'react-native-svg';
import { MotiView, MotiText } from 'moti';
import { MotiPressable } from 'moti/interactions';
import * as Haptics from 'expo-haptics';
import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';

const API_URL = 'http://localhost:3334/api';

const { width: screenWidth } = Dimensions.get('window');
const chartWidth = screenWidth - 80;

const theme = {
  ...DefaultTheme,
  roundness: 12,
  colors: { 
    ...DefaultTheme.colors, 
    primary: '#0A84FF', 
    accent: '#005ecb', 
    background: '#F2F2F7', 
    surface: '#FFFFFF', 
    text: '#1C1C1E', 
    placeholder: '#8A8A8E', 
    success: '#34C759', 
    danger: '#FF3B30', 
    warning: '#FF9500', 
    cardBlue: '#E3F2FD', 
    cardGreen: '#E8F5E9' 
  },
};

const mockChartData = {
    hoje: [ { value: 10, label: '0h' }, { value: 12, label: '3h' }, { value: 20, label: '6h' }, { value: 18, label: '9h' }, { value: 25, label: '12h' }, { value: 15.7, label: 'Agora', dataPointText: '15.7' } ],
    semana: [ { value: 110, label: 'Seg' }, { value: 105, label: 'Ter' }, { value: 120, label: 'Qua' }, { value: 115, label: 'Qui' }, { value: 95, label: 'Sex' }, { value: 90, label: 'S√°b' }, { value: 89, label: 'Dom', dataPointText: '89' } ],
    mes: [ { value: 800, label: 'S1' }, { value: 750, label: 'S2' }, { value: 820, label: 'S3' }, { value: 790, label: 'S4', dataPointText: '790' } ]
};
const mockRecentHistory = [
    { id: '1', icon: 'shower-head', description: 'Banho (Ducha Principal)', time: '14:32', value: '-25 L', type: 'expense' },
    { id: '2', icon: 'alert-decagram', description: 'Pequeno vazamento detectado', time: '12:15', value: 'Verificar', type: 'alert' },
    { id: '3', icon: 'leaf-circle', description: 'Meta de economia di√°ria', time: '08:00', value: '+5 L', type: 'saving' },
];

export default function Inicio() {
  const [isLoading, setIsLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState(null);

  const [consumptionData, setConsumptionData] = useState({ todayConsumption: 0, todaySavings: 0, comparison: 0 });
  const [dailyGoal, setDailyGoal] = useState(200);
  const [chartData, setChartData] = useState(mockChartData);
  const [recentHistory, setRecentHistory] = useState(mockRecentHistory);
  const [dicaDoPingo, setDicaDoPingo] = useState("Carregando dica...");
  const [filter, setFilter] = useState('hoje');

  const loadDashboardData = useCallback(async (isRefresh = false) => {
    if (!isRefresh) {
      setIsLoading(true);
    }
    // N√£o definimos o erro como nulo aqui para que a mensagem de erro permane√ßa vis√≠vel at√© que uma atualiza√ß√£o bem-sucedida ocorra.

    try {
      const authToken = await AsyncStorage.getItem('token');
      const userDataString = await AsyncStorage.getItem('user');

      if (!authToken || !userDataString) {
        throw new Error("Usu√°rio n√£o autenticado. Por favor, fa√ßa login novamente.");
      }
      
      const user = JSON.parse(userDataString);
      if (!user || !user.residencia_id || !user.residencia_type) {
        throw new Error("Dados da resid√™ncia do usu√°rio est√£o incompletos. Tente fazer login de novo.");
      }

      const headers = { 'Authorization': `Bearer ${authToken}` };
      const residenciaEndpoint = user.residencia_type === 'apartamento' ? 'apartamentos' : 'casas';
      const consumoUrl = `${API_URL}/${residenciaEndpoint}/${user.residencia_id}/consumo-total`;

      const [consumoResponse, metasResponse, dicaResponse] = await Promise.all([
        axios.get(consumoUrl, { headers }),
        axios.get(`${API_URL}/metas`, { headers }),
        axios.get(`${API_URL}/dica`, { headers }),
      ]);
      
      // Se as chamadas foram bem-sucedidas, limpamos qualquer erro anterior.
      setError(null);

      const consumoResult = consumoResponse.data;
      if (consumoResult && typeof consumoResult.consumoTotal !== 'undefined') {
        setConsumptionData(prev => ({
          ...prev,
          todayConsumption: parseFloat(consumoResult.consumoTotal) || 0,
        }));
      }

      const metasResult = metasResponse.data;
      if (metasResult?.docs?.length > 0) {
        setDailyGoal(parseFloat(metasResult.docs[0].limite_consumo));
      }
      
      const dicaResult = dicaResponse.data;
      if (dicaResult?.dica) {
        setDicaDoPingo(dicaResult.dica);
      }

    } catch (err) {
      const errorMessage = err.response?.data?.error || err.message || "Erro desconhecido ao carregar dados.";
      setError(errorMessage);
      console.error("Erro em loadDashboardData:", errorMessage);
    } finally {
      // Garante que o spinner de carregamento inicial seja desativado.
      if (!isRefresh) {
        setIsLoading(false);
      }
      // Garante que o indicador de "puxar para atualizar" seja desativado.
      setRefreshing(false);
    }
  }, []);

  // Efeito para a carga inicial dos dados
  useEffect(() => {
    loadDashboardData(false);
  }, [loadDashboardData]);

  // Efeito para a atualiza√ß√£o autom√°tica a cada 2 segundos
  useEffect(() => {
    const intervalId = setInterval(() => {
      loadDashboardData(true); // 'true' para indicar que √© uma atualiza√ß√£o em segundo plano
    }, 2000); // 2000 ms = 2 segundos

    // Fun√ß√£o de limpeza: para o intervalo quando o componente √© desmontado
    return () => clearInterval(intervalId);
  }, [loadDashboardData]);


  const onRefresh = () => {
    setRefreshing(true);
    loadDashboardData(true);
  };
  
  const comparisonColor = useMemo(() => (consumptionData.comparison <= 0 ? theme.colors.success : theme.colors.danger), [consumptionData.comparison]);
  const comparisonText = useMemo(() => { if (consumptionData.comparison == null) return ''; return consumptionData.comparison <= 0 ? `${consumptionData.comparison}% em rela√ß√£o a ontem` : `+${consumptionData.comparison}% em rela√ß√£o a ontem`; }, [consumptionData.comparison]);
  const consumptionProgress = useMemo(() => (dailyGoal > 0 ? Math.min(consumptionData.todayConsumption / dailyGoal, 1) : 0), [consumptionData.todayConsumption, dailyGoal]);

  const handleFilterChange = (newFilter) => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    setFilter(newFilter);
  };
  
  if (isLoading && !refreshing) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: theme.colors.background }}>
        <ActivityIndicator size="large" color={theme.colors.primary} />
      </View>
    );
  }
  
  if (error && !isLoading) {
     return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20 }}>
        <Title style={{ textAlign: 'center' }}>Ocorreu um erro</Title>
        <Paragraph style={{textAlign: 'center'}}>{error}</Paragraph>
        <Button onPress={onRefresh} style={{marginTop: 10}}>Tentar Novamente</Button>
      </View>
    );
  }

  return (
    <PaperProvider theme={theme}>
      <ScrollView 
        style={styles.container} 
        contentContainerStyle={styles.contentContainer} 
        showsVerticalScrollIndicator={false}
        refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}
      >
          <>
            <MotiView from={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'timing', duration: 500 }}>
              <Card style={styles.card} elevation={4}>
                  <Card.Content>
                    <View style={styles.dailyCardHeader}>
                      <Title style={styles.dailyCardTitle}>Resumo de Hoje</Title>
                      <MotiText from={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 300 }} style={[styles.comparisonText, { color: comparisonColor }]}>
                        {comparisonText}
                      </MotiText>
                    </View>

                    <View style={styles.innerCardsContainer}>
                      <Surface style={[styles.innerCard, { backgroundColor: theme.colors.cardBlue }]}>
                        <List.Icon icon="water-outline" color={theme.colors.primary} style={styles.innerCardIcon} />
                        <View>
                          <MotiText style={styles.innerCardValue}>{consumptionData.todayConsumption.toFixed(1)} L</MotiText>
                          <Text style={styles.innerCardLabel}>Consumido</Text>
                        </View>
                      </Surface>
                      <Surface style={[styles.innerCard, { backgroundColor: theme.colors.cardGreen }]}>
                        <List.Icon icon="leaf-circle-outline" color={theme.colors.success} style={styles.innerCardIcon}/>
                        <View>
                          <MotiText style={styles.innerCardValue}>{consumptionData.todaySavings.toFixed(1)} L</MotiText>
                          <Text style={styles.innerCardLabel}>Economizado</Text>
                        </View>
                      </Surface>
                    </View>
                    
                    <View style={styles.goalContainer}>
                      <Text style={styles.goalText}>Meta Di√°ria: {consumptionData.todayConsumption.toFixed(0)}L / {dailyGoal.toFixed(0)}L</Text>
                      <ProgressBar progress={consumptionProgress} color={theme.colors.primary} style={styles.progressBar} />
                    </View>

                    <View style={styles.insightContainer}>
                        <List.Icon icon="lightbulb-on-outline" color={theme.colors.warning} style={styles.innerCardIcon} />
                        <Paragraph style={styles.insightText}>
                            <Text style={{fontWeight: 'bold'}}>Dica do Pingo:</Text> {dicaDoPingo}
                        </Paragraph>
                    </View>
                  </Card.Content>
              </Card>
            </MotiView>
            
            <MotiView from={{ opacity: 0, translateY: 20 }} animate={{ opacity: 1, translateY: 0 }} transition={{ type: 'timing', duration: 500, delay: 150 }}>
              <Card style={styles.card} elevation={2}>
                <Card.Content>
                  <SegmentedButtons value={filter} onValueChange={handleFilterChange} style={styles.filterButtons} buttons={[ { value: 'hoje', label: 'Hoje' }, { value: 'semana', label: '7d' }, { value: 'mes', label: '30d' }, ]} />
                  <MotiView key={filter} from={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ type: 'timing', duration: 300 }}>
                    <LineChart 
                      data={chartData[filter]}
                      width={chartWidth}
                      height={180}
                      color1={theme.colors.primary} 
                      dataPointsColor1={theme.colors.primary} 
                      thickness1={3} 
                      curved
                      yAxisTextStyle={{ color: theme.colors.placeholder, fontSize: 10 }} 
                      xAxisLabelTextStyle={{ color: theme.colors.placeholder, fontSize: 10, paddingTop: 5 }} 
                      startFillColor1={theme.colors.primary} 
                      endFillColor1={theme.colors.background}
                      areaChart
                      initialSpacing={15}
                      endSpacing={15}
                      noOfSections={4}
                      yAxisThickness={0}
                      rulesType="dashed"
                      rulesColor="#EAEAEA"
                      pointerConfig={{
                        pointerStripHeight: 160,
                        pointerStripColor: theme.colors.primary,
                        pointerStripWidth: 2,
                        pointerColor: theme.colors.primary,
                        radius: 6,
                        pointerLabelWidth: 100,
                        pointerLabelHeight: 90,
                        activatePointersOnLongPress: true,
                        autoAdjustPointerLabelPosition: true,
                        pointerLabelComponent: items => (
                          <View style={styles.pointerLabel}>
                            <Text style={styles.pointerLabelValue}>{items[0].value} L</Text>
                            <Text style={styles.pointerLabelDate}>{items[0].label}</Text>
                          </View>
                        ),
                      }}
                    />
                  </MotiView>
                </Card.Content>
              </Card>
            </MotiView>
            
            <MotiView from={{ opacity: 0, translateY: 20 }} animate={{ opacity: 1, translateY: 0 }} transition={{ type: 'timing', duration: 500, delay: 300 }} style={styles.actionsContainer}>
                <MotiPressable animate={({ pressed }) => ({ scale: pressed ? 0.95 : 1 })} style={styles.actionButton} onPress={() => console.log('Relat√≥rios')}>
                    <List.Icon icon="file-chart-outline" color={theme.colors.primary} />
                    <Text style={styles.actionText}>Ver Relat√≥rios</Text>
                </MotiPressable>
                <MotiPressable animate={({ pressed }) => ({ scale: pressed ? 0.95 : 1 })} style={styles.actionButton} onPress={() => console.log('Metas')}>
                    <List.Icon icon="bullseye-arrow" color={theme.colors.success} />
                    <Text style={styles.actionText}>Ajustar Metas</Text>
                </MotiPressable>
            </MotiView>
            
            <MotiView from={{ opacity: 0, translateY: 20 }} animate={{ opacity: 1, translateY: 0 }} transition={{ type: 'timing', duration: 500, delay: 450 }}>
              <Card style={styles.card} elevation={2}>
                <Card.Content>
                  <Title>Hist√≥rico Recente</Title>
                  {recentHistory.map((item, index) => {
                    const itemColor = item.type === 'expense' ? theme.colors.danger : 
                                      item.type === 'saving' ? theme.colors.success : 
                                      theme.colors.warning;
                    return (
                      <MotiView key={item.id} from={{ opacity: 0, translateX: -20 }} animate={{ opacity: 1, translateX: 0 }} transition={{ type: 'timing', delay: 100 + index * 100 }}>
                        <List.Item 
                          title={item.description} 
                          description={item.time} 
                          titleNumberOfLines={1} 
                          left={props => <List.Icon {...props} icon={item.icon} color={itemColor} />} 
                          right={() => <Text style={[styles.historyValue, { color: itemColor }]}>{item.value}</Text>} 
                          style={[styles.listItem, index === 0 && styles.firstListItem]} 
                        />
                      </MotiView>
                    )
                  })}
                </Card.Content>
              </Card>
            </MotiView>
          </>
      </ScrollView>
    </PaperProvider>
  );
}

const styles = StyleSheet.create({
  container: { 
    flex: 1, 
    backgroundColor: theme.colors.background,
  },
  contentContainer: { 
    padding: 16, 
    paddingBottom: 48,
  },
  card: { 
    marginBottom: 20, 
    borderRadius: theme.roundness * 1.5,
    backgroundColor: theme.colors.surface,
  },
  dailyCardHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  },
  dailyCardTitle: {
    fontWeight: 'bold',
  },
  comparisonText: { 
    fontSize: 14, 
    fontWeight: '600',
  },
  innerCardsContainer: { 
    flexDirection: 'row', 
    justifyContent: 'space-between',
    gap: 12,
  },
  innerCard: { 
    flexDirection: 'row', 
    alignItems: 'center', 
    padding: 12, 
    borderRadius: theme.roundness, 
    flex: 1,
  },
  innerCardIcon: {
    marginRight: 8,
    marginLeft: 0,
    marginTop: 0,
    marginBottom: 0,
  },
  innerCardValue: { 
    fontSize: 20, 
    fontWeight: 'bold',
    color: theme.colors.text,
  },
  innerCardLabel: { 
    fontSize: 13, 
    color: theme.colors.placeholder,
  },
  goalContainer: {
    marginTop: 20,
  },
  goalText: {
    marginBottom: 8,
    fontSize: 14,
    color: theme.colors.placeholder,
  },
  progressBar: {
    height: 8,
    borderRadius: 4,
  },
  insightContainer: {
      flexDirection: 'row',
      alignItems: 'center',
      backgroundColor: '#FFFBE6',
      borderRadius: theme.roundness,
      padding: 12,
      marginTop: 20,
  },
  insightText: {
      flex: 1,
      fontSize: 14,
      color: '#B26E00',
      lineHeight: 20,
  },
  filterButtons: { 
    marginBottom: 16,
  },
  pointerLabel: {
    height: 60,
    width: 100,
    backgroundColor: 'white',
    borderRadius: 8,
    justifyContent: 'center',
    padding: 12,
    elevation: 4,
    shadowColor: '#000',
    shadowOpacity: 0.1,
    shadowRadius: 5,
  },
  pointerLabelValue: {
    fontWeight: 'bold',
    textAlign: 'center',
    fontSize: 14,
  },
  pointerLabelDate: {
    textAlign: 'center',
    fontSize: 12,
    color: theme.colors.placeholder,
  },
  actionsContainer: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      gap: 16,
      marginBottom: 20,
  },
  actionButton: {
      flex: 1,
      flexDirection: 'row',
      alignItems: 'center',
      justifyContent: 'center',
      backgroundColor: theme.colors.surface,
      borderRadius: theme.roundness,
      paddingVertical: 12,
      elevation: 2,
  },
  actionText: {
      fontSize: 15,
      fontWeight: '600',
      color: theme.colors.text,
  },
  listItem: {
      paddingLeft: 0,
  },
  firstListItem: {
      borderTopWidth: 1, 
      borderTopColor: '#F0F0F0', 
      paddingTop: 16, 
      marginTop: 10,
  },
  historyValue: {
      fontWeight: 'bold', 
      alignSelf: 'center',
      fontSize: 15,
  },
});


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\User-App\User-App\screens\Login.jsx
=================================================================================

import React, { useState } from 'react';
import {
    StyleSheet,
    View,
    ScrollView,
    TouchableOpacity,
    KeyboardAvoidingView,
    Platform,
    LayoutAnimation,
    UIManager
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import axios from 'axios';
import {
    TextInput,
    Button,
    Card,
    Title,
    Paragraph,
    Provider as PaperProvider,
    DefaultTheme,
    Portal,
    Dialog,
    HelperText,
    Avatar,
    Checkbox,
    Snackbar,
    Text,
    Modal,
    Divider,
    Subheading,
    IconButton,
    Icon
} from 'react-native-paper';
import { mask } from 'react-native-mask-text';
import { LinearGradient } from 'expo-linear-gradient';

if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {
    UIManager.setLayoutAnimationEnabledExperimental(true);
}

// ATEN√á√ÉO: Se estiver usando o Expo Go no seu celular, substitua 'localhost'
// pelo endere√ßo IP da sua m√°quina na rede. Ex: 'http://192.168.1.10:3334'
const API_BASE_URL = 'http://localhost:3334';

const theme = {
    ...DefaultTheme,
    roundness: 10,
    colors: {
        ...DefaultTheme.colors,
        primary: '#0A84FF',
        accent: '#005ecb',
        background: '#F2F2F7',
        surface: '#FFFFFF',
        text: '#1C1C1E',
        placeholder: '#8A8A8E',
        error: '#FF3B30',
        success: '#34C759'
    },
};

export default function LoginRegisterScreen({ onLogin: onSuccessfulLogin }) {
    const [formType, setFormType] = useState('login');
    const [registrationType, setRegistrationType] = useState('casa');
    const [isLoading, setIsLoading] = useState(false);
    const [passwordVisible, setPasswordVisible] = useState(false);
    const [snackbar, setSnackbar] = useState({ visible: false, message: '', type: 'default' });

    const [codigoDialogVisible, setCodigoDialogVisible] = useState(false);
    const [planoIndividualDialog, setPlanoIndividualDialog] = useState(false);
    const [planoCondoDialog, setPlanoCondoDialog] = useState(false);

    const [termsVisible, setTermsVisible] = useState(false);
    const [agreeToTerms, setAgreeToTerms] = useState(false);
    const [scrolledToBottom, setScrolledToBottom] = useState(false);

    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [senha, setSenha] = useState('');
    const [cpf, setCpf] = useState('');
    const [cep, setCep] = useState('');
    const [logradouro, setLogradouro] = useState('');
    const [numero, setNumero] = useState('');
    const [bairro, setBairro] = useState('');
    const [cidade, setCidade] = useState('');
    const [uf, setUf] = useState('');
    const [estado, setEstado] = useState('');
    const [codigoAcesso, setCodigoAcesso] = useState('');
    const [bloco, setBloco] = useState('');
    const [numeroMoradores, setNumeroMoradores] = useState('1');

    // Estados para o fluxo de "Esqueci minha senha"
    const [forgotPasswordModalVisible, setForgotPasswordModalVisible] = useState(false);
    const [resetPasswordModalVisible, setResetPasswordModalVisible] = useState(false);
    const [resetEmail, setResetEmail] = useState('');
    const [resetToken, setResetToken] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmNewPassword, setConfirmNewPassword] = useState('');


    const showSnackbar = (message, type = 'default') => {
        setSnackbar({ visible: true, message, type });
    };

    const clearFormFields = () => {
        setName(''); setEmail(''); setSenha(''); setCpf(''); setCep('');
        setLogradouro(''); setNumero(''); setBairro(''); setCidade('');
        setUf(''); setEstado(''); setCodigoAcesso(''); setBloco('');
        setNumeroMoradores('1'); setAgreeToTerms(false);
    };

    const handleFormTypeChange = (newType) => {
        LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
        clearFormFields();
        setFormType(newType);
    };

    const fetchAddressFromCep = async (cepValue) => {
        const unmaskedCep = cepValue.replace(/\D/g, '');
        if (unmaskedCep.length !== 8) return null;

        setIsLoading(true);
        try {
            const response = await axios.get(`${API_BASE_URL}/api/cep/${unmaskedCep}`);
            const addressData = response.data;
            setLogradouro(addressData.logradouro || ''); setBairro(addressData.bairro || '');
            setCidade(addressData.cidade || ''); setUf(addressData.uf || '');
            return addressData;
        } catch (error) {
            console.error("Erro ao buscar CEP:", error);
            showSnackbar('CEP n√£o encontrado ou inv√°lido.', 'error');
            setLogradouro(''); setBairro(''); setCidade(''); setUf('');
            return null;
        } finally {
            setIsLoading(false);
        }
    };

    const handleLogin = async () => {
        if (!email || !senha) { showSnackbar('Por favor, preencha e-mail e senha.', 'error'); return; }
        setIsLoading(true);
        try {
            const response = await axios.post(`${API_BASE_URL}/api/auth/login`, { email, password: senha });
            const { token, user } = response.data;
            await AsyncStorage.setItem('token', token);
            await AsyncStorage.setItem('user', JSON.stringify(user));
            showSnackbar('Login realizado com sucesso!', 'success');
            if(onSuccessfulLogin) onSuccessfulLogin(user);
        } catch (error) {
            console.error("Erro no login:", error.response?.data || error.message);
            const errorMessage = error.response?.data?.error || 'Credenciais inv√°lidas ou erro no servidor.';
            showSnackbar(`Erro: ${errorMessage}`, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    const handleRegister = async () => {
        if (!name.trim() || !email.trim() || !senha.trim() || !cpf.trim()) { showSnackbar('Preencha todos os campos obrigat√≥rios.', 'error'); return; }
        if (!email.includes('@') || !email.includes('.')) { showSnackbar('Formato de e-mail inv√°lido.', 'error'); return; }
        if (senha.length < 6) { showSnackbar('A senha deve ter no m√≠nimo 6 caracteres.', 'error'); return; }
        if (cpf.replace(/\D/g, '').length !== 11) { showSnackbar('CPF inv√°lido.', 'error'); return; }
        if (registrationType === 'casa' && (!cep.trim() || !numero.trim())) { showSnackbar('Para resid√™ncia pr√≥pria, CEP e N√∫mero s√£o obrigat√≥rios.', 'error'); return; }
        if (registrationType === 'condominio' && (!codigoAcesso.trim() || !numero.trim())) { showSnackbar('Para plano condom√≠nio, C√≥digo de Acesso e N√∫mero s√£o obrigat√≥rios.', 'error'); return; }
        if (!agreeToTerms) { showSnackbar('Voc√™ precisa aceitar os Termos e Condi√ß√µes para continuar.', 'error'); return; }

        setIsLoading(true);

        const residencia_type = registrationType === 'condominio' ? 'apartamento' : 'casa';
        let userData = {
            name,
            email,
            password: senha,
            cpf,
            residencia_type,
            numero_moradores: parseInt(numeroMoradores, 10) || 1,
            // Campos espec√≠ficos de cada tipo
            cep,
            numero,
            bloco,
            codigo_acesso: codigoAcesso,
        };

        try {
            await axios.post(`${API_BASE_URL}/api/auth/register`, userData);
            showSnackbar('Cadastro realizado com sucesso! Fa√ßa o login.', 'success');
            handleFormTypeChange('login');
        } catch (error) {
            console.error("Detalhes do erro de cadastro:", error.response?.data || error);
            if (error.response?.data?.errors) {
                const errorMessages = error.response.data.errors.map(e => e.message).join('\n');
                showSnackbar(`Erros de valida√ß√£o:\n${errorMessages}`, 'error');
            } else if (error.response?.data?.error) {
                showSnackbar(`Erro: ${error.response.data.error}`, 'error');
            } else {
                showSnackbar('N√£o foi poss√≠vel conectar ao servidor.', 'error');
            }
        } finally {
            setIsLoading(false);
        }
    };

    const handleForgotPasswordRequest = async () => {
        if (!resetEmail.includes('@') || !resetEmail.includes('.')) {
            showSnackbar('Por favor, insira um e-mail v√°lido.', 'error');
            return;
        }
        setIsLoading(true);
        try {
            await axios.post(`${API_BASE_URL}/api/password/forgot`, { email: resetEmail });
            showSnackbar('C√≥digo enviado! Verifique sua caixa de entrada e spam.', 'success');
            setForgotPasswordModalVisible(false);
            setResetPasswordModalVisible(true);
        } catch (error) {
            console.error("Erro ao solicitar redefini√ß√£o:", error.response?.data || error.message);
            showSnackbar('Se o e-mail estiver correto, voc√™ receber√° um c√≥digo.', 'success');
            setForgotPasswordModalVisible(false);
            setResetPasswordModalVisible(true);
        } finally {
            setIsLoading(false);
        }
    };

    const handleResetPasswordSubmit = async () => {
        if (!resetToken.trim() || !newPassword.trim()) {
            showSnackbar('Preencha o c√≥digo e a nova senha.', 'error'); return;
        }
        if (newPassword !== confirmNewPassword) {
            showSnackbar('As senhas n√£o coincidem.', 'error'); return;
        }
        if (newPassword.length < 6) {
            showSnackbar('A nova senha deve ter no m√≠nimo 6 caracteres.', 'error'); return;
        }
        setIsLoading(true);
        try {
            await axios.post(`${API_BASE_URL}/api/password/reset`, { token: resetToken, newPassword });
            showSnackbar('Senha alterada com sucesso! Fa√ßa o login.', 'success');
            setResetPasswordModalVisible(false);
            setResetEmail(''); setResetToken(''); setNewPassword(''); setConfirmNewPassword('');
            handleFormTypeChange('login');
        } catch (error) {
            const errorMessage = error.response?.data?.error || 'N√£o foi poss√≠vel redefinir a senha.';
            showSnackbar(`Erro: ${errorMessage}`, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    const handleOpenTerms = () => setTermsVisible(true);
    const handleCloseTerms = () => setTermsVisible(false);
    const handleAcceptTerms = () => { setAgreeToTerms(true); handleCloseTerms(); };
    const isCloseToBottom = ({ layoutMeasurement, contentOffset, contentSize }) => {
        const paddingToBottom = 20;
        return layoutMeasurement.height + contentOffset.y >= contentSize.height - paddingToBottom;
    };

    const GradientButton = ({ onPress, loading, disabled, children, style }) => (
        <TouchableOpacity onPress={onPress} disabled={disabled || loading} style={[styles.gradientButtonContainer, style]}>
            <LinearGradient colors={disabled ? ['#B0B0B0', '#C0C0C0'] : ['#0A84FF', '#005ecb']} style={styles.gradientButton} start={{ x: 0, y: 0 }} end={{ x: 1, y: 1 }}>
                <Text style={styles.gradientButtonText}>{loading ? 'Aguarde...' : children}</Text>
            </LinearGradient>
        </TouchableOpacity>
    );

    const renderLoginForm = () => (
        <View>
            <Paragraph style={styles.paragraph}>Bem-vindo! Fa√ßa login para continuar.</Paragraph>
            <TextInput label="Email" value={email} onChangeText={setEmail} style={styles.input} mode="outlined" keyboardType="email-address" autoCapitalize="none" left={<TextInput.Icon icon="account-circle-outline" />} />
            <TextInput label="Senha" value={senha} onChangeText={setSenha} secureTextEntry={!passwordVisible} style={styles.input} mode="outlined" left={<TextInput.Icon icon="lock-outline" />} right={<TextInput.Icon icon={passwordVisible ? "eye-off" : "eye"} onPress={() => setPasswordVisible(!passwordVisible)} />} />
            <Button mode="text" onPress={() => setForgotPasswordModalVisible(true)} style={{ alignSelf: 'flex-end', marginBottom: 16 }}>
                Esqueci minha senha
            </Button>
            <GradientButton onPress={handleLogin} loading={isLoading} disabled={isLoading}>
                Login
            </GradientButton>
            <Button mode="text" onPress={() => handleFormTypeChange('register')} style={styles.switchButton}>
                Novo por aqui? Crie uma conta
            </Button>
        </View>
    );

    const renderRegisterForm = () => (
        <View>
            <Paragraph style={styles.paragraph}>Selecione o tipo de plano para come√ßar.</Paragraph>
            <View style={styles.customSegmentedContainer}>
                <TouchableOpacity
                    style={[styles.customSegmentButton, registrationType === 'casa' && styles.customSegmentButtonActive]}
                    onPress={() => setRegistrationType('casa')}
                >
                    <Icon source="home-variant-outline" size={20} color={registrationType === 'casa' ? '#FFFFFF' : theme.colors.primary} />
                    <Text style={[styles.customSegmentLabel, registrationType === 'casa' && styles.customSegmentLabelActive]}>
                        Resid√™ncia Pr√≥pria
                    </Text>
                    <IconButton
                        icon="help-circle-outline"
                        size={20}
                        iconColor={registrationType === 'casa' ? '#FFFFFF' : theme.colors.primary}
                        onPress={() => setPlanoIndividualDialog(true)}
                        style={styles.infoIcon}
                    />
                </TouchableOpacity>
                <TouchableOpacity
                    style={[styles.customSegmentButton, registrationType === 'condominio' && styles.customSegmentButtonActive]}
                    onPress={() => setRegistrationType('condominio')}
                >
                    <Icon source="office-building-outline" size={20} color={registrationType === 'condominio' ? '#FFFFFF' : theme.colors.primary} />
                    <Text style={[styles.customSegmentLabel, registrationType === 'condominio' && styles.customSegmentLabelActive]}>
                        Plano Condom√≠nio
                    </Text>
                    <IconButton
                        icon="help-circle-outline"
                        size={20}
                        iconColor={registrationType === 'condominio' ? '#FFFFFF' : theme.colors.primary}
                        onPress={() => setPlanoCondoDialog(true)}
                        style={styles.infoIcon}
                    />
                </TouchableOpacity>
            </View>

            <TextInput label="Nome Completo" style={styles.input} value={name} onChangeText={setName} mode="outlined" />
            <TextInput label="Email" style={styles.input} value={email} onChangeText={setEmail} mode="outlined" keyboardType="email-address" autoCapitalize="none"/>
            <TextInput label="Senha (m√≠n. 6 caracteres)" style={styles.input} value={senha} onChangeText={setSenha} secureTextEntry mode="outlined" />
            <TextInput label="CPF" style={styles.input} value={cpf} onChangeText={(text) => setCpf(mask(text, '999.999.999-99'))} mode="outlined" keyboardType="numeric" />

            {registrationType === 'casa' && (
                <>
                    <TextInput label="CEP" style={styles.input} value={cep} onChangeText={(text) => setCep(mask(text, '99999-999'))} onBlur={() => fetchAddressFromCep(cep)} mode="outlined" keyboardType="numeric" />
                    <TextInput label="Logradouro" style={styles.input} value={logradouro} onChangeText={setLogradouro} mode="outlined" disabled={true} />
                    <TextInput label="Bairro" style={styles.input} value={bairro} onChangeText={setBairro} mode="outlined" disabled={true} />
                    <TextInput label="Cidade" style={styles.input} value={cidade} onChangeText={setCidade} mode="outlined" disabled={true} />
                    <TextInput label="UF" style={styles.input} value={uf} onChangeText={setUf} mode="outlined" disabled={true} />
                    <TextInput label="N√∫mero da Casa" style={styles.input} value={numero} onChangeText={setNumero} mode="outlined" keyboardType="numeric" />
                    <TextInput label="N√∫mero de Moradores" style={styles.input} value={numeroMoradores} onChangeText={setNumeroMoradores} mode="outlined" keyboardType="numeric" />
                </>
            )}

            {registrationType === 'condominio' && (
                <>
                    <TextInput label="C√≥digo de Acesso do Condom√≠nio" style={styles.input} value={codigoAcesso} onChangeText={setCodigoAcesso} mode="outlined" />
                    <TextInput label="Bloco (Opcional)" style={styles.input} value={bloco} onChangeText={setBloco} mode="outlined" />
                    {/* CORRE√á√ÉO APLICADA AQUI: O label foi ajustado para maior clareza. */}
                    <TextInput label="N√∫mero do Apartamento" style={styles.input} value={numero} onChangeText={setNumero} mode="outlined" keyboardType="numeric" />
                    <TextInput label="N√∫mero de Moradores" style={styles.input} value={numeroMoradores} onChangeText={setNumeroMoradores} mode="outlined" keyboardType="numeric" />
                    <HelperText type="info" visible={true} style={{ textAlign: 'center' }}>
                        N√£o sabe o c√≥digo? <Button mode="text" compact onPress={() => setCodigoDialogVisible(true)} labelStyle={{ fontSize: 12 }}>Clique aqui</Button>
                    </HelperText>
                </>
            )}

            <TouchableOpacity onPress={handleOpenTerms} style={styles.checkboxContainer}>
                <Checkbox.Android status={agreeToTerms ? 'checked' : 'unchecked'} color={theme.colors.primary} />
                <Text style={styles.checkboxLabel}>Eu li e aceito os <Text style={styles.checkboxLink}>Termos e Condi√ß√µes</Text></Text>
            </TouchableOpacity>

            <GradientButton onPress={handleRegister} loading={isLoading} disabled={isLoading || !agreeToTerms}>
                Cadastrar
            </GradientButton>
            <Button mode="text" onPress={() => handleFormTypeChange('login')} style={styles.switchButton}>
                J√° tem uma conta? Fa√ßa login
            </Button>
        </View>
    );

    return (
        <PaperProvider theme={theme}>
            <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={styles.keyboardAvoidingView}>
                <ScrollView contentContainerStyle={styles.scrollContainer} keyboardShouldPersistTaps="handled">
                    <View style={styles.container}>
                        <Card style={styles.card}>
                            <Card.Content style={styles.cardContent}>
                                <View style={styles.logoContainer}>
                                    {/* Certifique-se de que o caminho para o logo est√° correto em 'assets/logo.png' */}
                                    <Avatar.Image size={80} source={require('../assets/logo.png')} style={{ backgroundColor: 'transparent' }} />
                                    <Title style={styles.title}>Aqua Services</Title>
                                </View>
                                {formType === 'login' ? renderLoginForm() : renderRegisterForm()}
                            </Card.Content>
                        </Card>
                    </View>
                </ScrollView>
            </KeyboardAvoidingView>

            <Portal>
                <Modal visible={termsVisible} onDismiss={handleCloseTerms} contentContainerStyle={styles.modalContainer}>
                    <View style={styles.modalHeader}>
                        <Title style={styles.modalTitle}>Termos e Condi√ß√µes de Uso</Title>
                        <Paragraph style={styles.modalSubtitle}>Aqua Services</Paragraph>
                    </View>
                    <Divider />
                    <ScrollView style={styles.modalScrollView} onScroll={({ nativeEvent }) => { if (isCloseToBottom(nativeEvent)) { if (!scrolledToBottom) setScrolledToBottom(true); }}} scrollEventThrottle={400}>
                        <Paragraph style={styles.termsText}>Bem-vindo ao Aqua! Agradecemos por escolher nossa solu√ß√£o para o monitoramento inteligente do consumo de √°gua. Antes de prosseguir, por favor, leia atentamente nossos Termos e Condi√ß√µes.</Paragraph>
                        <Subheading style={styles.termsSubheading}>1. O Servi√ßo Aqua</Subheading>
                        <Paragraph style={styles.termsText}>O projeto Aqua consiste em um sistema de assinaturas para monitoramento de √°gua em condom√≠nios e resid√™ncias individuais. Nossa plataforma √© composta por um Aplicativo Android, voltado para moradores e s√≠ndicos, e um Dashboard Administrativo para nossa equipe interna. O objetivo √© fornecer uma ferramenta centralizada para acompanhar o consumo estimado de √°gua, criar metas de economia e facilitar a comunica√ß√£o com nossos clientes.</Paragraph>
                        <Subheading style={styles.termsSubheading}>2. Cadastro e Conta do Usu√°rio</Subheading>
                        <Paragraph style={styles.termsText}>Ao se cadastrar, voc√™ concorda em fornecer informa√ß√µes verdadeiras, precisas e completas, como nome, e-mail e CPF. Voc√™ √© o √∫nico respons√°vel pela seguran√ßa de sua senha e por todas as atividades que ocorrem em sua conta.</Paragraph>
                        <Subheading style={styles.termsSubheading}>3. Coleta e Uso de Dados</Subheading>
                        <Paragraph style={styles.termsText}>Para fornecer nossos servi√ßos, coletamos dois tipos principais de dados:{"\n\n"}a) **Dados Pessoais:** Informa√ß√µes fornecidas durante o cadastro (nome, e-mail, CPF, endere√ßo) s√£o utilizadas para identifica√ß√£o, faturamento e comunica√ß√£o.{"\n\n"}b) **Dados de Consumo:** Nossos sensores IOT coletam dados sobre o fluxo de √°gua em sua resid√™ncia. Esses dados s√£o processados para gerar relat√≥rios de consumo estimado, identificar poss√≠veis vazamentos e auxiliar na cria√ß√£o de metas.{"\n\n"}Todos os dados s√£o armazenados de forma segura em nossa infraestrutura na nuvem (AWS) e tratados com a m√°xima confidencialidade. N√£o compartilharemos seus dados pessoais com terceiros sem seu consentimento expl√≠cito, exceto quando exigido por lei.</Paragraph>
                        <Subheading style={styles.termsSubheading}>4. Propriedade Intelectual</Subheading>
                        <Paragraph style={styles.termsText}>Todo o conte√∫do, design, c√≥digo-fonte, e elementos visuais do aplicativo Aqua, incluindo nosso mascote "Pingo", s√£o de propriedade exclusiva da equipe de desenvolvimento do projeto Aqua. √â proibida a reprodu√ß√£o, c√≥pia ou redistribui√ß√£o de qualquer parte do servi√ßo sem nossa permiss√£o pr√©via por escrito.</Paragraph>
                        <Subheading style={styles.termsSubheading}>5. Limita√ß√£o de Responsabilidade</Subheading>
                        <Paragraph style={styles.termsText}>O sistema Aqua fornece dados de consumo de forma **estimada** e para fins de monitoramento. Embora nos esforcemos para a m√°xima precis√£o, n√£o nos responsabilizamos por discrep√¢ncias entre os dados apresentados e sua fatura oficial de √°gua. O servi√ßo √© uma ferramenta de apoio √† gest√£o do consumo, e n√£o substitui a verifica√ß√£o de profissionais qualificados para problemas hidr√°ulicos.</Paragraph>
                        <Subheading style={styles.termsSubheading}>6. Agradecimentos</Subheading>
                        <Paragraph style={styles.termsText}>Este projeto foi desenvolvido como Trabalho de Conclus√£o de Curso por: Davi Rodrigues, Felipe Lopes, Davi Chagas, Ana Carollini e Thiago Henrique. Agradecemos por fazer parte desta jornada conosco.</Paragraph>
                    </ScrollView>
                    <Divider />
                    <View style={styles.modalFooter}>
                        <Button mode="contained" onPress={handleAcceptTerms} disabled={!scrolledToBottom} style={scrolledToBottom ? {} : { backgroundColor: theme.colors.placeholder }}>
                            {scrolledToBottom ? "Eu Li e Aceito os Termos" : "Role at√© o final para aceitar"}
                        </Button>
                    </View>
                </Modal>

                <Dialog visible={planoIndividualDialog} onDismiss={() => setPlanoIndividualDialog(false)} style={styles.dialog}>
                    <Dialog.Icon icon="home-variant-outline" size={48} color={theme.colors.primary} />
                    <Dialog.Title style={styles.dialogTitle}>Plano de Resid√™ncia Pr√≥pria</Dialog.Title>
                    <Dialog.Content>
                        <Paragraph style={styles.dialogParagraph}>Escolha esta op√ß√£o se voc√™ mora em uma casa ou resid√™ncia que n√£o faz parte de um condom√≠nio parceiro. O cadastro ser√° feito diretamente com seu endere√ßo.</Paragraph>
                    </Dialog.Content>
                    <Dialog.Actions>
                        <Button onPress={() => setPlanoIndividualDialog(false)} mode="contained">Entendi</Button>
                    </Dialog.Actions>
                </Dialog>

                <Dialog visible={planoCondoDialog} onDismiss={() => setPlanoCondoDialog(false)} style={styles.dialog}>
                    <Dialog.Icon icon="office-building-outline" size={48} color={theme.colors.primary} />
                    <Dialog.Title style={styles.dialogTitle}>Plano Condom√≠nio</Dialog.Title>
                    <Dialog.Content>
                        <Paragraph style={styles.dialogParagraph}>Escolha esta op√ß√£o se voc√™ mora em um apartamento ou casa dentro de um condom√≠nio que j√° possui o sistema Aqua. Voc√™ precisar√° do c√≥digo de acesso fornecido pelo s√≠ndico.</Paragraph>
                    </Dialog.Content>
                    <Dialog.Actions>
                        <Button onPress={() => setPlanoCondoDialog(false)} mode="contained">Entendi</Button>
                    </Dialog.Actions>
                </Dialog>

                <Dialog visible={codigoDialogVisible} onDismiss={() => setCodigoDialogVisible(false)} style={styles.dialog}>
                    <Dialog.Icon icon="information-outline" size={48} color={theme.colors.primary} />
                    <Dialog.Title style={styles.dialogTitle}>C√≥digo de Acesso</Dialog.Title>
                    <Dialog.Content>
                        <Paragraph style={styles.dialogParagraph}>O c√≥digo de acesso do condom√≠nio √© um identificador √∫nico. Voc√™ pode encontr√°-lo na sua fatura ou consultar a administra√ß√£o.</Paragraph>
                    </Dialog.Content>
                    <Dialog.Actions>
                        <Button onPress={() => setCodigoDialogVisible(false)} mode="contained">Entendi</Button>
                    </Dialog.Actions>
                </Dialog>

                <Modal visible={forgotPasswordModalVisible} onDismiss={() => setForgotPasswordModalVisible(false)} contentContainerStyle={styles.modalContainerShort}>
                    <View style={styles.modalHeader}>
                        <Title style={styles.modalTitle}>Redefinir Senha</Title>
                        <Paragraph style={styles.modalSubtitle}>Digite seu e-mail para receber um c√≥digo de verifica√ß√£o.</Paragraph>
                    </View>
                    <Divider />
                    <View style={styles.modalContent}>
                        <TextInput label="Seu e-mail de cadastro" value={resetEmail} onChangeText={setResetEmail} style={styles.input} mode="outlined" keyboardType="email-address" autoCapitalize="none" left={<TextInput.Icon icon="email-outline" />} />
                    </View>
                    <View style={styles.modalFooterRow}>
                        <Button onPress={() => setForgotPasswordModalVisible(false)} style={{ marginRight: 8 }}>Cancelar</Button>
                        <GradientButton onPress={handleForgotPasswordRequest} loading={isLoading} disabled={isLoading}>Enviar</GradientButton>
                    </View>
                </Modal>

                <Modal visible={resetPasswordModalVisible} onDismiss={() => setResetPasswordModalVisible(false)} contentContainerStyle={styles.modalContainerShort}>
                    <View style={styles.modalHeader}>
                        <Title style={styles.modalTitle}>Criar Nova Senha</Title>
                        <Paragraph style={styles.modalSubtitle}>Insira o c√≥digo recebido e defina sua nova senha.</Paragraph>
                    </View>
                    <Divider />
                    <View style={styles.modalContent}>
                        <TextInput label="C√≥digo de 6 d√≠gitos" value={resetToken} onChangeText={setResetToken} style={styles.input} mode="outlined" keyboardType="number-pad" maxLength={6} />
                        <TextInput label="Nova Senha" value={newPassword} onChangeText={setNewPassword} secureTextEntry style={styles.input} mode="outlined" />
                        <TextInput label="Confirmar Nova Senha" value={confirmNewPassword} onChangeText={setConfirmNewPassword} secureTextEntry style={styles.input} mode="outlined" />
                    </View>
                    <View style={styles.modalFooterRow}>
                        <Button onPress={() => setResetPasswordModalVisible(false)} style={{ marginRight: 8 }}>Cancelar</Button>
                        <GradientButton onPress={handleResetPasswordSubmit} loading={isLoading} disabled={isLoading}>Salvar Senha</GradientButton>
                    </View>
                </Modal>

            </Portal>

            <Snackbar
                visible={snackbar.visible}
                onDismiss={() => setSnackbar({ ...snackbar, visible: false })}
                duration={Snackbar.DURATION_MEDIUM}
                style={{ backgroundColor: snackbar.type === 'error' ? theme.colors.error : snackbar.type === 'success' ? theme.colors.success : '#323232' }}
            >
                {snackbar.message}
            </Snackbar>
        </PaperProvider>
    );
}

const styles = StyleSheet.create({
    keyboardAvoidingView: { flex: 1, backgroundColor: theme.colors.background },
    scrollContainer: { flexGrow: 1, justifyContent: 'center', paddingVertical: 20 },
    container: { paddingHorizontal: 20 },
    card: { width: '100%', maxWidth: 420, alignSelf: 'center', borderRadius: theme.roundness * 1.5, elevation: 8, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.1, shadowRadius: 12 },
    cardContent: { paddingHorizontal: 24, paddingVertical: 32 },
    logoContainer: { alignItems: 'center', marginBottom: 24 },
    title: { fontSize: 28, fontWeight: 'bold', color: theme.colors.primary, marginTop: 12, letterSpacing: 0.5 },
    paragraph: { fontSize: 16, color: theme.colors.placeholder, textAlign: 'center', marginBottom: 24, lineHeight: 22 },
    input: { marginBottom: 16, backgroundColor: theme.colors.background },
    gradientButtonContainer: { borderRadius: theme.roundness * 5, elevation: 4, shadowColor: '#0A84FF', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.3, shadowRadius: 5 },
    gradientButton: { paddingVertical: 14, paddingHorizontal: 20, alignItems: 'center', borderRadius: theme.roundness * 5, overflow: 'hidden' },
    gradientButtonText: { fontSize: 18, fontWeight: 'bold', color: '#FFFFFF', letterSpacing: 0.5 },
    switchButton: { marginTop: 16 },
    customSegmentedContainer: { flexDirection: 'row', marginBottom: 24, borderWidth: 1, borderColor: theme.colors.placeholder, borderRadius: theme.roundness, overflow: 'hidden' },
    customSegmentButton: { flex: 1, flexDirection: 'row', alignItems: 'center', justifyContent: 'center', paddingVertical: 10, backgroundColor: theme.colors.surface, paddingHorizontal: 5, },
    customSegmentButtonActive: { backgroundColor: theme.colors.primary },
    customSegmentLabel: { fontSize: 13, fontWeight: '600', color: theme.colors.primary, marginLeft: 6, flexShrink: 1, },
    customSegmentLabelActive: { color: '#FFFFFF' },
    infoIcon: { margin: -5 },
    checkboxContainer: { flexDirection: 'row', alignItems: 'center', marginTop: 16, backgroundColor: 'transparent', paddingVertical: 8 },
    checkboxLabel: { marginLeft: 6, color: theme.colors.placeholder, flex: 1 },
    checkboxLink: { fontWeight: 'bold', color: theme.colors.primary, textDecorationLine: 'underline' },
    dialog: { borderRadius: theme.roundness * 1.5 },
    dialogTitle: { textAlign: 'center', color: theme.colors.text },
    dialogParagraph: { textAlign: 'center', color: theme.colors.placeholder, lineHeight: 20 },
    modalContainer: { backgroundColor: 'white', margin: 20, borderRadius: theme.roundness * 1.5, height: '85%', elevation: 10 },
    modalContainerShort: { backgroundColor: 'white', margin: 20, borderRadius: theme.roundness * 1.5, elevation: 10, alignSelf: 'center', width: '90%', maxWidth: 400 },
    modalHeader: { paddingVertical: 20, paddingHorizontal: 20, alignItems: 'center' },
    modalTitle: { fontSize: 22, fontWeight: 'bold', color: theme.colors.text },
    modalSubtitle: { fontSize: 14, color: theme.colors.placeholder, textAlign: 'center' },
    modalContent: { paddingHorizontal: 24, paddingTop: 16 },
    modalScrollView: { paddingHorizontal: 24 },
    termsText: { fontSize: 14, lineHeight: 22, marginBottom: 16, textAlign: 'justify', color: theme.colors.text },
    termsSubheading: { fontSize: 16, fontWeight: 'bold', marginTop: 8, marginBottom: 8, color: theme.colors.text },
    modalFooter: { padding: 20, borderTopWidth: 1, borderTopColor: '#EEEEEE' },
    modalFooterRow: { padding: 20, borderTopWidth: 1, borderTopColor: '#EEEEEE', flexDirection: 'row', justifyContent: 'flex-end', alignItems: 'center' },
});


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\User-App\User-App\screens\Metas.jsx
=================================================================================

import React from 'react';
import { StyleSheet, View, ScrollView } from 'react-native';
import { 
  Provider as PaperProvider, 
  DefaultTheme, 
  Avatar, 
  Button, 
  Card, 
  Title, 
  Paragraph,
  Text,
  List,
  ProgressBar,
} from 'react-native-paper'; 
import { LinearGradient } from 'expo-linear-gradient';
import { MotiView, MotiText } from 'moti';
import { MotiPressable } from 'moti/interactions';
import * as Haptics from 'expo-haptics';

const theme = {
  ...DefaultTheme,
  roundness: 12,
  colors: {
    ...DefaultTheme.colors,
    primary: '#0A84FF',
    accent: '#005ecb',
    background: '#F2F2F7',
    surface: '#FFFFFF',
    text: '#1C1C1E',
    placeholder: '#8A8A8E',
    success: '#34C759',
    danger: '#FF3B30',
    warning: '#FF9500',
    gold: '#FFD700',
  },
};

const generalProgress = {
  active: 5,
  completed: 10,
  points: 1500,
};

const myGoals = [
  { id: '1', title: 'Economizar 100L de √°gua esta semana', progress: 0.75, status: 'Em andamento', icon: 'water-percent' },
  { id: '2', title: 'Reduzir o tempo de banho para 5 minutos', progress: 1, status: 'Conclu√≠da', icon: 'clock-check-outline' },
  { id: '3', title: 'Consertar o vazamento da torneira', progress: 0, status: 'Pendente', icon: 'wrench-outline' },
];

const communityChallenge = {
  title: 'Desafio Coletivo de Dezembro',
  description: 'Todo o condom√≠nio unido para reduzir o consumo em 15% e ganhar uma recompensa especial!',
  progress: 0.6,
};

const ranking = [
  { id: '1', name: 'Apto 12B', points: 2000, avatar: 'numeric-1-circle' },
  { id: '2', name: 'Voc√™', points: 1500, avatar: 'account-circle' },
  { id: '3', name: 'Apto 8A', points: 1200, avatar: 'numeric-3-circle' },
];

const MetasScreen = () => {
  return (
    <PaperProvider theme={theme}>
      <ScrollView style={styles.container} contentContainerStyle={styles.contentContainer}>
        
        <MotiView from={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'timing', duration: 500 }}>
          <LinearGradient
            colors={['#4A00E0', '#8E2DE2']}
            start={{x: 0, y: 0}}
            end={{x: 1, y: 1}}
            style={styles.gradientCard}
          >
            <View style={styles.cardHeader}>
              <Title style={styles.cardTitleWhite}>Seu Progresso</Title>
              <Avatar.Icon size={40} icon="trophy-award" color={theme.colors.gold} style={{ backgroundColor: 'rgba(255,255,255,0.1)' }} />
            </View>

            <View style={styles.statsContainer}>
              <View style={styles.statItem}>
                <Title style={styles.statNumeroBranco}>{generalProgress.active}</Title>
                <Paragraph style={styles.statLabelBranco}>Ativas</Paragraph>
              </View>
              <View style={styles.statItem}>
                <Title style={styles.statNumeroBranco}>{generalProgress.completed}</Title>
                <Paragraph style={styles.statLabelBranco}>Conclu√≠das</Paragraph>
              </View>
              <View style={styles.statItem}>
                <Title style={styles.statNumeroBranco}>{generalProgress.points}</Title>
                <Paragraph style={styles.statLabelBranco}>Pontos</Paragraph>
              </View>
            </View>
          </LinearGradient>
        </MotiView>

        <MotiView from={{ opacity: 0, translateY: 20 }} animate={{ opacity: 1, translateY: 0 }} transition={{ type: 'timing', duration: 500, delay: 100 }} style={styles.actionsContainer}>
            <MotiPressable 
              style={styles.actionButton}
              onPress={() => Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium)}
              animate={({ pressed }) => ({ scale: pressed ? 0.95 : 1 })}
            >
                <List.Icon icon="plus-circle-outline" color={theme.colors.primary} />
                <Text style={styles.actionText}>Criar Nova Meta</Text>
            </MotiPressable>
            <MotiPressable 
              style={[styles.actionButton, { backgroundColor: '#FFFBE6' }]}
              onPress={() => Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium)}
              animate={({ pressed }) => ({ scale: pressed ? 0.95 : 1 })}
            >
                <List.Icon icon="gift-outline" color={theme.colors.gold} />
                <Text style={[styles.actionText, { color: theme.colors.gold }]}>Recompensas</Text>
            </MotiPressable>
        </MotiView>

        <MotiView from={{ opacity: 0, translateY: 20 }} animate={{ opacity: 1, translateY: 0 }} transition={{ type: 'timing', duration: 500, delay: 200 }}>
          <Card style={styles.card} elevation={2}>
            <Card.Title title="Minhas Metas Atuais" titleStyle={styles.cardTitle} />
            <Card.Content>
              {myGoals.map((meta, index) => (
                <View key={meta.id} style={styles.goalItem}>
                  <List.Icon icon={meta.icon} color={meta.progress === 1 ? theme.colors.success : theme.colors.primary} style={{ marginLeft: -10 }} />
                  <View style={{ flex: 1 }}>
                    <Text style={styles.goalTitle}>{meta.title}</Text>
                    <ProgressBar progress={meta.progress} color={meta.progress === 1 ? theme.colors.success : theme.colors.primary} style={styles.goalProgressBar} />
                  </View>
                  <Text style={[styles.goalStatus, { color: meta.progress === 1 ? theme.colors.success : theme.colors.placeholder }]}>
                    {meta.status}
                  </Text>
                </View>
              ))}
            </Card.Content>
          </Card>
        </MotiView>
        
        <MotiView from={{ opacity: 0, translateY: 20 }} animate={{ opacity: 1, translateY: 0 }} transition={{ type: 'timing', duration: 500, delay: 300 }}>
          <Card style={styles.card} elevation={2}>
            <Card.Title title={communityChallenge.title} subtitle="Participe com seus vizinhos!" titleStyle={styles.cardTitle} />
            <Card.Content>
              <Paragraph style={styles.challengeDescription}>{communityChallenge.description}</Paragraph>
              <View style={{ marginTop: 10 }}>
                <Text style={styles.goalText}>Progresso do Condom√≠nio:</Text>
                <ProgressBar progress={communityChallenge.progress} color={theme.colors.success} style={styles.goalProgressBar} />
              </View>
            </Card.Content>
          </Card>
        </MotiView>

        <MotiView from={{ opacity: 0, translateY: 20 }} animate={{ opacity: 1, translateY: 0 }} transition={{ type: 'timing', duration: 500, delay: 400 }}>
          <Card style={styles.card} elevation={2}>
            <Card.Title title="Ranking de Pontos" titleStyle={styles.cardTitle} />
            <Card.Content>
              {ranking.map((item, index) => (
                <List.Item
                  key={item.id}
                  title={item.name}
                  titleStyle={item.name === 'Voc√™' ? styles.rankingYou : styles.rankingOthers}
                  left={() => <Avatar.Icon size={40} icon={item.avatar} color={item.name === 'Voc√™' ? theme.colors.primary : theme.colors.placeholder} style={{backgroundColor: 'transparent'}} />}
                  right={() => <Text style={styles.rankingPoints}>{item.points} pts</Text>}
                />
              ))}
            </Card.Content>
          </Card>
        </MotiView>
      </ScrollView>
    </PaperProvider>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: theme.colors.background,
  },
  contentContainer: {
    padding: 16,
    paddingBottom: 48,
  },
  card: {
    marginBottom: 20,
    borderRadius: theme.roundness * 1.5,
    backgroundColor: theme.colors.surface,
  },
  cardTitle: {
    fontWeight: 'bold',
  },
  gradientCard: {
    marginBottom: 20,
    borderRadius: theme.roundness * 1.5,
    elevation: 8,
    shadowColor: '#4A00E0',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
  },
  cardHeader: {
    paddingHorizontal: 20,
    paddingTop: 20,
    paddingBottom: 12,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  cardTitleWhite: {
    color: '#FFFFFF',
    fontWeight: 'bold',
    fontSize: 22,
  },
  statsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    width: '100%',
    paddingBottom: 20,
  },
  statItem: {
    alignItems: 'center',
  },
  statNumeroBranco: {
    fontSize: 28,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  statLabelBranco: {
    fontSize: 14,
    color: '#E0E0E0',
  },
  actionsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    gap: 16,
    marginBottom: 20,
  },
  actionButton: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: theme.colors.surface,
    borderRadius: theme.roundness,
    paddingVertical: 10,
    elevation: 2,
  },
  actionText: {
    fontSize: 15,
    fontWeight: '600',
    color: theme.colors.text,
  },
  goalItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 16,
  },
  goalTitle: {
    fontSize: 15,
    color: theme.colors.text,
    marginBottom: 6,
  },
  goalProgressBar: {
    height: 8,
    borderRadius: 4,
  },
  goalStatus: {
    marginLeft: 16,
    fontWeight: 'bold',
    fontSize: 14,
  },
  challengeDescription: {
    fontSize: 15,
    lineHeight: 22,
    color: theme.colors.placeholder,
  },
  goalText: {
    marginBottom: 8,
    fontSize: 14,
    color: theme.colors.placeholder,
  },
  rankingYou: {
    fontWeight: 'bold',
    color: theme.colors.primary,
  },
  rankingOthers: {
    color: theme.colors.text,
  },
  rankingPoints: {
    alignSelf: 'center',
    fontSize: 16,
    fontWeight: 'bold',
    color: theme.colors.gold,
  }
});

export default MetasScreen;


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\User-App\User-App\screens\Perfil.jsx
=================================================================================

// Arquivo: C:\Users\24250553\Documents\3mdR\aqua\User-App\User-App\screens\Perfil.jsx
// C√ìDIGO COMPLETO E CORRIGIDO

import React, { useState, useEffect, useCallback } from 'react';
import { View, StyleSheet, ScrollView, ActivityIndicator, Alert } from 'react-native';
import {
  Card,
  Divider,
  List,
  Switch,
  Button,
  useTheme,
  Snackbar,
  Title,
  Paragraph,
} from 'react-native-paper';
import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';
import ProfileHeader from '../components/Perfil/ProfileHeader';
import StatCard from '../components/Perfil/StatCard';

// ATEN√á√ÉO: Se estiver usando o Expo Go no celular, troque 'localhost' pelo IP da sua m√°quina.
const API_URL = 'http://localhost:3334/api';

const ProfileScreen = ({ navigation, onLogout }) => {
  const { colors } = useTheme();

  const [user, setUser] = useState(null);
  const [stats, setStats] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [snackbar, setSnackbar] = useState({ visible: false, message: '' });

  const [notificationPrefs, setNotificationPrefs] = useState({
    notif_vazamento: true,
    notif_consumo_alto: true,
    notif_metas: true,
    notif_comunidade: false,
    notif_relatorios: true,
  });

  const fetchProfileData = useCallback(async () => {
    // Para recargas, n√£o mostramos o spinner de tela cheia
    if (isLoading) setIsLoading(true);
    
    try {
      const authToken = await AsyncStorage.getItem('token');
      if (!authToken) {
        onLogout();
        return;
      }
      const headers = { Authorization: `Bearer ${authToken}` };
      const [profileResponse, statsResponse] = await Promise.all([
        axios.get(`${API_URL}/profile`, { headers }),
        axios.get(`${API_URL}/user/me/stats`, { headers })
      ]);

      if (profileResponse.data) {
        setUser(profileResponse.data);
        setNotificationPrefs({
          notif_vazamento: profileResponse.data.notif_vazamento,
          notif_consumo_alto: profileResponse.data.notif_consumo_alto,
          notif_metas: profileResponse.data.notif_metas,
          notif_comunidade: profileResponse.data.notif_comunidade,
          notif_relatorios: profileResponse.data.notif_relatorios,
        });
      }
      if (statsResponse.data) {
        setStats(statsResponse.data);
      }
    } catch (error) {
      console.error("ERRO AO BUSCAR DADOS:", error.response?.data || error.message);
      if (error.response?.status === 401) onLogout();
      else Alert.alert("Erro", "N√£o foi poss√≠vel carregar seus dados.");
    } finally {
      setIsLoading(false);
    }
  }, [onLogout]);

  useEffect(() => {
    fetchProfileData();
  }, [fetchProfileData]);

  const handleProfileUpdate = () => {
    setSnackbar({ visible: true, message: 'Foto atualizada! Recarregando perfil...' });
    fetchProfileData(); // Recarrega todos os dados
  };

  const handleNotificationChange = async (key, value) => {
    const originalPrefs = { ...notificationPrefs };
    setNotificationPrefs(prev => ({ ...prev, [key]: value }));

    try {
      const authToken = await AsyncStorage.getItem('token');
      await axios.put(`${API_URL}/user/me`, { [key]: value }, { headers: { Authorization: `Bearer ${authToken}` } });
      setSnackbar({ visible: true, message: 'Prefer√™ncia salva!' });
    } catch (error) {
      setNotificationPrefs(originalPrefs);
      Alert.alert("Erro", "N√£o foi poss√≠vel salvar sua prefer√™ncia.");
    }
  };

  const handleLogoutPress = async () => {
    await AsyncStorage.multiRemove(['token', 'user']);
    onLogout();
  };

  if (isLoading) {
    return (
      <View style={styles.centeredContainer}>
        <ActivityIndicator size="large" color={colors.primary} />
      </View>
    );
  }

  if (!user || !stats) {
    return (
      <View style={styles.centeredContainer}>
        <Title>Erro ao carregar perfil.</Title>
        <Paragraph>Por favor, tente novamente.</Paragraph>
        <Button onPress={onLogout} style={{ marginTop: 20 }}>Voltar ao Login</Button>
      </View>
    );
  }

  return (
    <>
      <ScrollView style={styles.container} contentContainerStyle={styles.contentContainer}>
        <ProfileHeader user={user} onProfileUpdate={handleProfileUpdate} />

        <Title style={styles.sectionTitle}>Minhas Estat√≠sticas</Title>
        <View style={styles.statsGrid}>
          <StatCard icon="trophy-award" color="#FFD700" label="Pontos" value={stats.pontos} delay={0} />
          <StatCard icon="podium" color="#C0C0C0" label="Ranking" value={stats.ranking} unit="¬∫" delay={100} />
          <StatCard icon="water-sync" color="#5dade2" label="√Ågua Poupada" value={stats.agua_poupada} unit=" L" delay={200} />
          <StatCard icon="cash-multiple" color="#2ecc71" label="Economia Total" value={stats.economia_total} unit=" R$" delay={300} />
          <StatCard icon="flag-checkered" color="#f1c40f" label="Metas Cumpridas" value={stats.metas_cumpridas} delay={400} />
          <StatCard icon="clock-time-eight-outline" color="#3498db" label="Dias no App" value={stats.tempo_no_app} delay={500} />
        </View>

        <Card style={styles.card}>
          <List.Accordion title="Notifica√ß√µes" id="1" left={props => <List.Icon {...props} icon="bell-outline" />}>
            <List.Item title="Alertas de Vazamento" right={() => <Switch value={notificationPrefs.notif_vazamento} onValueChange={(v) => handleNotificationChange('notif_vazamento', v)} />} />
            <List.Item title="Alto Consumo" right={() => <Switch value={notificationPrefs.notif_consumo_alto} onValueChange={(v) => handleNotificationChange('notif_consumo_alto', v)} />} />
            <List.Item title="Metas e Objetivos" right={() => <Switch value={notificationPrefs.notif_metas} onValueChange={(v) => handleNotificationChange('notif_metas', v)} />} />
            <List.Item title="Desafios da Comunidade" right={() => <Switch value={notificationPrefs.notif_comunidade} onValueChange={(v) => handleNotificationChange('notif_comunidade', v)} />} />
            <List.Item title="Relat√≥rios de Economia" right={() => <Switch value={notificationPrefs.notif_relatorios} onValueChange={(v) => handleNotificationChange('notif_relatorios', v)} />} />
          </List.Accordion>
          <Divider />
          <List.Accordion title="Ajuda & Suporte" id="2" left={props => <List.Icon {...props} icon="help-circle-outline" />}>
            <List.Item title="Central de Ajuda" onPress={() => { }} />
            <List.Item title="Suporte T√©cnico" onPress={() => { }} />
            <List.Item title="Termos de Servi√ßo" onPress={() => { }} />
          </List.Accordion>
        </Card>

        <Button icon="logout" mode="contained" onPress={handleLogoutPress} style={styles.logoutButton} buttonColor={colors.error}>
          Sair da Conta
        </Button>
      </ScrollView>
      <Snackbar visible={snackbar.visible} onDismiss={() => setSnackbar({ ...snackbar, visible: false })} duration={3000}>
        {snackbar.message}
      </Snackbar>
    </>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F2F2F7',
  },
  contentContainer: {
    padding: 10,
    paddingBottom: 20,
  },
  centeredContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
    backgroundColor: '#F2F2F7',
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    marginLeft: 5,
    marginBottom: 10,
  },
  statsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    gap: 10,
    marginBottom: 15,
  },
  card: {
    marginBottom: 15,
    borderRadius: 16,
  },
  logoutButton: {
    marginTop: 15,
    paddingVertical: 8,
    borderRadius: 16,
  },
});

export default ProfileScreen;


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\User-App\User-App\screens\Relatorios.jsx
=================================================================================

import React, { useState } from 'react';
import { View, StyleSheet, ScrollView, Dimensions, Text as RNText } from 'react-native';
import {
  SegmentedButtons,
  Card,
  List,
  Title,
  Paragraph,
  Icon,
} from 'react-native-paper';
// Importa√ß√µes do Skia
import { Canvas, Rect, Text } from "@shopify/react-native-skia";

const screenWidth = Dimensions.get('window').width;

const reportData = [
  { date: '01/11', consumption: 170, savings: 5 },
  { date: '02/11', consumption: 120, savings: 15 },
  { date: '03/11', consumption: 140, savings: 12 },
  { date: '04/11', consumption: 110, savings: 20 },
  { date: '05/11', consumption: 165, savings: 8 },
  { date: '06/11', consumption: 150, savings: 10 },
  { date: '07/11', consumption: 130, savings: 18 },
];

const LOW_CONSUMPTION_THRESHOLD = 130;
const HIGH_CONSUMPTION_THRESHOLD = 160;

// Fun√ß√£o de cor, agora fora do componente para ser acessada pelo SkiaChart
const getBarColor = (consumption) => {
  if (consumption >= HIGH_CONSUMPTION_THRESHOLD) return '#f31212ff';
  if (consumption < LOW_CONSUMPTION_THRESHOLD) return '#2ecc71';
  return '#3498db';
};

// --- NOSSO NOVO COMPONENTE DE GR√ÅFICO COM SKIA ---
const SkiaBarChart = ({ data, width, height }) => {
  const PADDING = { top: 30, bottom: 30, left: 10, right: 10 };
  const BAR_WIDTH = 35;
  const VISUAL_BASE_HEIGHT = 20;

  const chartHeight = height - PADDING.top - PADDING.bottom;
  const chartWidth = width - PADDING.left - PADDING.right;

  const values = data.map(d => d.consumption);
  const minConsumption = Math.min(...values);
  const maxConsumption = Math.max(...values);
  const dataRange = maxConsumption - minConsumption;

  const totalBarWidth = data.length * BAR_WIDTH;
  const totalSpacing = chartWidth - totalBarWidth;
  const gapWidth = data.length > 1 ? totalSpacing / (data.length - 1) : 0;

  return (
    <Canvas style={{ width, height }}>
      {data.map((item, index) => {
        const barHeight = dataRange === 0 
          ? chartHeight
          : ((item.consumption - minConsumption) / dataRange) * (chartHeight - VISUAL_BASE_HEIGHT) + VISUAL_BASE_HEIGHT;
        
        const x = PADDING.left + index * (BAR_WIDTH + gapWidth);
        const y = PADDING.top + chartHeight - barHeight;

        return (
          <React.Fragment key={index}>
            <Rect x={x} y={y} width={BAR_WIDTH} height={barHeight} color={getBarColor(item.consumption)} rx={4} />
            <Text x={x + BAR_WIDTH / 2 - 15} y={y - 8} text={`${item.consumption}`} color="black" />
            <Text x={x + BAR_WIDTH / 2 - 15} y={height - 10} text={item.date} color="gray" />
          </React.Fragment>
        );
      })}
    </Canvas>
  );
};

const ReportsScreen = () => {
  const [timeframe, setTimeframe] = useState('7d');
  const [viewMode, setViewMode] = useState('graph');

  // Os c√°lculos de resumo continuam os mesmos
  const totalConsumption = reportData.reduce((acc, item) => acc + item.consumption, 0);
  const totalSavings = reportData.reduce((acc, item) => acc + item.savings, 0);
  const dailyAverage = Math.round(totalConsumption / reportData.length);
  const bestDay = reportData.reduce(
    (best, current) => (current.consumption < best.consumption ? current : best),
    reportData[0]
  );

  const renderContent = () => {
    if (viewMode === 'graph') {
      return (
        <Card style={styles.card}>
          <Card.Content style={styles.chartCardContent}>
            <Title style={styles.chartTitle}>Consumo Di√°rio (Litros)</Title>
            <SkiaBarChart
              data={reportData}
              width={screenWidth - 40}
              height={250}
            />
          </Card.Content>
        </Card>
      );
    }

    return (
      <View>
        {reportData.map((item, index) => (
          <Card key={index} style={styles.card}>
            <List.Item
              title={`Consumo: ${item.consumption} L`}
              description={`Economia: ${item.savings} L`}
              left={props => <List.Icon {...props} icon="calendar" />}
              right={props => <Paragraph {...props} style={styles.reportDate}>{item.date}</Paragraph>}
            />
          </Card>
        ))}
      </View>
    );
  };

  return (
    <ScrollView style={styles.container}>
      {/* Controles do Topo */}
      <View style={styles.controlsContainer}>
        <SegmentedButtons
          value={timeframe}
          onValueChange={setTimeframe}
          buttons={[
            { value: '7d', label: '7 Dias' },
            { value: '30d', label: '30 Dias' },
            { value: '90d', label: '90 Dias' },
          ]}
          style={styles.segmentedButton}
        />
        <SegmentedButtons
          value={viewMode}
          onValueChange={setViewMode}
          buttons={[
            { value: 'graph', label: 'Gr√°fico', icon: 'chart-bar' },
            { value: 'list', label: 'Lista', icon: 'format-list-bulleted' },
          ]}
          style={styles.segmentedButton}
        />
      </View>
      
      {/* √Årea de Conte√∫do Principal */}
      <View style={styles.contentContainer}>
        {renderContent()}
      </View>
      
      {/* Grade de Resumo */}
      <View style={styles.summaryGridContainer}>
        <View style={styles.summaryRow}>
          <Card style={styles.summaryCard}>
            <Card.Content style={styles.summaryCardContent}>
              <Icon source="water-outline" size={30} color="#3498db" />
              <View>
                <Paragraph style={styles.summaryLabel}>Consumo Total</Paragraph>
                <Title style={styles.summaryValue}>{totalConsumption} L</Title>
              </View>
            </Card.Content>
          </Card>
          <Card style={styles.summaryCard}>
            <Card.Content style={styles.summaryCardContent}>
              <Icon source="leaf-outline" size={30} color="#2ecc71" />
              <View>
                <Paragraph style={styles.summaryLabel}>Economia</Paragraph>
                <Title style={styles.summaryValue}>{totalSavings} L</Title>
              </View>
            </Card.Content>
          </Card>
        </View>
        <View style={styles.summaryRow}>
          <Card style={styles.summaryCard}>
            <Card.Content style={styles.summaryCardContent}>
              <Icon source="chart-line" size={30} color="#9b59b6" />
              <View>
                <Paragraph style={styles.summaryLabel}>M√©dia Di√°ria</Paragraph>
                <Title style={styles.summaryValue}>{dailyAverage} L</Title>
              </View>
            </Card.Content>
          </Card>
          <Card style={styles.summaryCard}>
            <Card.Content style={styles.summaryCardContent}>
              <Icon source="trophy-outline" size={30} color="#f1c40f" />
              <View>
                <Paragraph style={styles.summaryLabel}>Melhor Dia</Paragraph>
                <Title style={styles.summaryValue}>{bestDay.consumption} L</Title>
                <Paragraph style={styles.bestDayDate}>({bestDay.date})</Paragraph>
              </View>
            </Card.Content>
          </Card>
        </View>
      </View>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
    container: { flex: 1, backgroundColor: '#f5f5f5' },
    controlsContainer: { padding: 10, backgroundColor: '#fff' },
    segmentedButton: { marginBottom: 10 },
    contentContainer: { paddingHorizontal: 10, alignItems: 'center' },
    chartTitle: { textAlign: 'center', marginBottom: 10 },
    card: { marginBottom: 10, width: screenWidth - 20 },
    reportDate: { alignSelf: 'center', marginRight: 10, color: '#666' },
    summaryGridContainer: { paddingHorizontal: 10, marginTop: 10, marginBottom: 20 },
    summaryRow: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 10 },
    summaryCard: { width: '48%' },
    summaryCardContent: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-around', paddingHorizontal: 5, paddingVertical: 15 },
    summaryLabel: { fontSize: 12, color: '#666' },
    summaryValue: { fontSize: 18, lineHeight: 20 },
    bestDayDate: { fontSize: 11, lineHeight: 12, color: '#666' },
    chartCardContent: {
      alignItems: 'center',
      paddingHorizontal: 0,
      paddingVertical: 10,
    },
});

export default ReportsScreen;


#################################################################################
IN√çCIO DA AN√ÅLISE DE: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src
#################################################################################

=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\app.js
=================================================================================

import Fastify from 'fastify';
import cors from '@fastify/cors';
import { fastifySwagger } from '@fastify/swagger';
import swaggerUI from '@fastify/swagger-ui';
import pino from 'pino'
import fs from 'fs'
import multipart from '@fastify/multipart'
import fastifyStatic from '@fastify/static';
import fastifyFormbody from '@fastify/formbody'
import path from 'path';
import { fileURLToPath } from 'url';

import userRoutes from './routes/user.routes.js';
import errorHandler from './middlewares/errorHandler.js';
import condominioRoutes from './routes/condominio.routes.js';
import unidadesRoutes from './routes/apartamento.routes.js'
import casaRoutes from './routes/casa.routes.js';
import sensorRoutes from './routes/sensor.routes.js';
import adminRoutes from './routes/admin.routes.js';
import authRoutes from './routes/auth.routes.js';
import residenciaRoutes from './routes/residencia.routes.js';
import alertasRoutes from './routes/alertas.routes.js';
import cepRoutes from './routes/cep.routes.js';
import leituraRoutes from './routes/leitura.routes.js';
import suporteRoutes from './routes/suporte.routes.js';
import crescimentoRoutes from './routes/crescimento.routes.js';
import vazamentoRoutes from './routes/vazamento.routes.js';
import comunicadoRoutes from './routes/comunicado.routes.js';

if (!fs.existsSync('./logs')) fs.mkdirSync('./logs')

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);


// cria log di√°rio
const date = new Date().toISOString().slice(0, 10)
const filePath = `./logs/${date}.log`
const fileStream = fs.createWriteStream(filePath, { flags: 'a' })

const prettyTransport = pino.transport({
    target: 'pino-pretty',
    options: {
        colorize: true,
        translateTime: 'SYS:standard',
        ignore: 'pid,hostname',
    },
})

const multiStream = pino.multistream([
    { stream: prettyTransport },
    { stream: fileStream },
])

const fastify = Fastify({
    logger: {
        level: 'info',
        stream: multiStream,
    }
})

await fastify.register(cors, {
    origin: 'http://localhost:3000',
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH']
})

fastify.register(fastifyFormbody);
await fastify.register(multipart);

fastify.register(fastifyStatic, {
    root: path.join(process.cwd(), 'uploads'),
    prefix: '/api/uploads/',
})


// docs api
await fastify.register(fastifySwagger, {
    openapi: {
        info: {
            title: 'Aqua API',
            version: '1.0.0',
            description: 'Documenta√ß√£o da nossa API administrativa do Sistema Aqua.'
        },
    }
});

await fastify.register(swaggerUI, {
    routePrefix: '/docs',
    uiConfig: {
        docExpansion: 'list',
        deepLinking: false
    },
    initOAuth: {},
});

fastify.get('/api', {
    schema: {
        tags: ['Health Check'],
        summary: 'Status da API',
        description: 'Verifica se a API est√° online e respondendo',
        response: {
            200: {
                type: 'string',
                example: 'Hello API'
            }
        }
    }
}, (req, reply) => {
    return reply.status(200).send('Hello API!')
})

await fastify.register(userRoutes, { prefix: '/api/users' });
await fastify.register(condominioRoutes, { prefix: '/api/condominios' });
await fastify.register(unidadesRoutes, { prefix: '/api/apartamentos' });
await fastify.register(casaRoutes, { prefix: '/api/casas' });
await fastify.register(sensorRoutes, { prefix: '/api/sensores' });
await fastify.register(adminRoutes, { prefix: '/api/admins' });
await fastify.register(authRoutes, { prefix: '/api/auth' });
await fastify.register(residenciaRoutes, { prefix: '/api/residencias' });
await fastify.register(alertasRoutes, { prefix: '/api/alertas' });
await fastify.register(leituraRoutes, { prefix: '/api/leituras' });
await fastify.register(suporteRoutes, { prefix: '/api/suporte' });
await fastify.register(crescimentoRoutes, { prefix: '/api/crescimento' });
await fastify.register(vazamentoRoutes, { prefix: '/api/vazamentos' });
await fastify.register(comunicadoRoutes, { prefix: '/api/comunicados' });
await fastify.register(cepRoutes, { prefix: '/api/cep' });
await fastify.register(errorHandler);

export default fastify;


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\config\sequelize.js
=================================================================================

import dotenv from 'dotenv';
import { resolve } from "path";
dotenv.config({ path: resolve("..", ".env") });

import { Sequelize } from "sequelize";

// escolhe host e porta com base no ambiente
const dbHost = process.env.DB_ENV === "docker"
  ? process.env.DB_HOST_DOCKER
  : process.env.DB_HOST_LOCAL;

const dbPort = process.env.DB_ENV === "docker"
  ? Number(process.env.DB_PORT_DOCKER)
  : Number(process.env.DB_PORT_LOCAL);

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASS,
  {
    host: dbHost,
    port: dbPort,
    dialect: process.env.DB_DIALECT || 'mysql',
    logging: false
  }
);

export const connectDB = async () => {
  try {
    await sequelize.authenticate();
    console.log('Conex√£o estabelecida com sucesso!!');
    await sequelize.sync();
    console.log('Tabelas sincronizadas com o banco!');
  } catch (error) {
    console.error('Erro ao conectar com o banco de dados:', error);
    process.exit(1);
  }
};

export default sequelize;



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\AdminController.js
=================================================================================

import AdminService from "../services/AdminService.js";
import { createAdminDTO } from '../dto/admin/createAdminDTO.js';
import { updateAdminDTO } from "../dto/admin/updateAdminDTO.js";
import { updatePasswordDTO } from "../dto/admin/updatePasswordDTO.js";

export default class AdminController {

    static async getAll(req, reply) {
        const admins = await AdminService.getAllAdmins();
        return reply.status(200).send(admins);
    }

    static async getAllAtivos(req, reply) {
        const admins = await AdminService.getAllAdminsAtivos();
        return reply.status(200).send(admins);
    }

    static async getAllInativos(req, reply) {
        const admins = await AdminService.getAllAdminsInativos();
        return reply.status(200).send(admins);
    }

    static async create(req, reply) {
        const validateAdmin = createAdminDTO.parse(req.body);
        const admin = await AdminService.createAdmin(validateAdmin);
        return reply.status(201).send(admin);
    }

    static async update(req, reply) {
        const validateAdmin = updateAdminDTO.parse(req.body);
        const admin = await AdminService.updateAdmin(validateAdmin);
        return reply.status(200).send(admin);
    }

    static async inativar(req, reply) {
        const { id } = req.params;
        const admin = await AdminService.inativarAdmin(id);
        return reply.status(200).send(admin);
    }

    static async ativar(req, reply) {
        const { id } = req.params;
        const admin = await AdminService.ativarAdmin(id);
        return reply.status(200).send(admin);
    }

    static async updatePassword(req, reply) {
        const validatePassword = updatePasswordDTO.parse(req.body);
        const adminId = req.admin.id;
        const admin = await AdminService.updateMe(adminId, validatePassword);
        return reply.status(200).send(admin);
    }

    static async uploadProfile(req, reply) {
        try {
            const file = await req.file(); // fastify-multipart
            if (!file) {
                return reply.status(400).send({ message: 'Arquivo n√£o enviado ou tipo inv√°lido' });
            }

            const imgUrl = await AdminService.uploadProfilePicture(req.admin.id, file);

            return reply.status(200).send({
                message: 'Foto enviada com sucesso!',
                img_url: imgUrl
            });
        } catch (err) {
            console.error('Erro no upload', err);
            return reply.status(500).send({ message: 'Erro ao enviar arquivo' });
        }
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\AlertaController.js
=================================================================================

import AlertasService from "../services/AlertasService.js";

export default class AlertasController {

    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const alertas = await AlertasService.getAllAlertas(page, limit);
        return reply.status(200).send(alertas);
    }

    static async getAllAtivos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const alertas = await AlertasService.getAllAlertasAtivos(page, limit);
        return reply.status(200).send(alertas);
    }

    static async getAllInativos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const alertas = await AlertasService.getAllAlertasResolvidos(page, limit);
        return reply.status(200).send(alertas);
    }

    static async getRecentes(req, reply) {
        const alertas = await AlertasService.getAlertasRecentes();
        return reply.status(200).send(alertas);
    }

    static async countAtivos(req, reply) {
        const alertas = await AlertasService.countAlertasAtivos();
        return reply.status(200).send(alertas);
    }

    static async countVazamentos(req, reply) {
        const alertas = await AlertasService.countAlertasDeVazamento();
        return reply.status(200).send(alertas);
    }

    static async countConsumoAlto(req, reply) {
        const alertas = await AlertasService.countAlertasDeConsumoAlto();
        return reply.status(200).send(alertas);
    }

    static async countTotalPorCasa(req, reply) {
        const alertas = await AlertasService.countTotalCasa();
        return reply.status(200).send(alertas);
    }

    static async countTotalPorApartamento(req, reply) {
        const alertas = await AlertasService.countTotalApartamento();
        return reply.status(200).send(alertas);
    }

    static async countPorCondominio(req, reply) {
        const alertas = await AlertasService.countPorCondominio();
        return reply.status(200).send(alertas);
    }

    static async countPorCasa(req, reply) {
        const { id } = req.params;
        const alertas = await AlertasService.countAlertasAtivosPorCasa(id);
        return reply.status(200).send(alertas);
    }
    
    static async countPorApartamento(req, reply) {
        const { id } = req.params;
        const alertas = await AlertasService.countAlertasAtivosPorApartamento(id);
        return reply.status(200).send(alertas);
    }

    static async resolverAlerta(req, reply) {
        const { id } = req.params;
        const alerta = await AlertasService.removerAlerta(id);
        return reply.status(200).send(alerta);
    }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\ApartamentoController.js
=================================================================================

import ApartamentoService from "../services/ApartamentoService.js";

export default class ApartamentoController {

    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const apartamentos = await ApartamentoService.getAllApartamentos(page, limit);
        return reply.status(200).send(apartamentos);
    }

    static async getAllAtivos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const apartamentos = await ApartamentoService.getAllApartamentosAtivos(page, limit);
        return reply.status(200).send(apartamentos);
    }

    static async getAllInativos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const apartamentos = await ApartamentoService.getAllApartamentosInativos(page, limit);
        return reply.status(200).send(apartamentos);
    }

    static async count(req, reply) {
        const apartamentos = await ApartamentoService.countApartamentos();
        return reply.status(200).send(apartamentos);
    }

    static async inativar(req, reply) {
        const {id} = req.params;
        const apartamento = await ApartamentoService.inativarApartamento(id);
        return reply.status(200).send(apartamento);
    }

    static async ativar(req, reply) {
        const {id} = req.params;
        const apartamento = await ApartamentoService.ativarApartamento(id);
        return reply.status(200).send(apartamento);
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\AuthController.js
=================================================================================

import jwt from 'jsonwebtoken';
import Admin from '../models/Admin.js';

const gerarToken = (payload) => {
    return jwt.sign(payload, process.env.JWT_SECRET, { expiresIn: '1h' });
};

// Blacklist de tokens 
const tokenBlacklist = new Set();


export const Login = async (req, reply) => {
    const { email, password } = req.body;

    try {
        const admin = await Admin.findOne({ where: { email } });

        if (!admin) {
            return reply.status(404).send({ message: 'Administrador n√£o encontrado.' });
        }

        if (admin.status !== 'ativo') {
            return reply.status(403).send({ message: 'Administrador inativo.' });
        }

        const senhaCorreta = await admin.checkPassword(password);

        if (!senhaCorreta) {
            return reply.status(401).send({ message: 'Senha incorreta.' });
        }

        const token = gerarToken({
            id: admin.id,
            email: admin.email,
            type: admin.type
        });

        return reply.status(200).send({
            message: 'Login efetuado com sucesso!',
            token
        });

    } catch (error) {
        console.error("Erro ao efetuar login:", error);
        return reply.status(500).send({ message: 'Erro ao efetuar login.' });
    }
}

export const Logout = async (req, reply) => {
    try {
        const authHeader = req.headers.authorization;

        if (!authHeader) {
            return reply.status(400).send({ message: 'Token n√£o fornecido.' });
        }

        const token = authHeader.split(' ')[1]; // espera "Bearer <token>"

        // adiciona o token na blacklist
        tokenBlacklist.add(token);

        return reply.status(200).send({ message: 'Logout realizado com sucesso.' });
    } catch (error) {
        console.error("Erro ao efetuar logout:", error);
        return reply.status(500).send({ message: 'Erro ao efetuar logout.' });
    }
};

export const verifyToken = async (req, reply, done) => {
    const authHeader = req.headers.authorization;

    if (!authHeader) {
        return reply.status(401).send({ message: 'Token n√£o fornecido.' });
    }

    const token = authHeader.split(' ')[1];

    if (tokenBlacklist.has(token)) {
        return reply.status(401).send({ message: 'Token inv√°lido (logout realizado).' });
    }

    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.admin = decoded;
        done();
    } catch (error) {
        return reply.status(401).send({ message: 'Token inv√°lido ou expirado.' });
    }
};

export const getMe = async (req, reply) => {
    try {
        const admin = await Admin.findByPk(req.admin.id);

        if (!admin) {
            return reply.status(404).send({ message: 'Administrador n√£o encontrado.' });
        }

        const adminData = admin.toJSON();
        delete adminData.password;

        // retornando sem a senha
        return reply.status(200).send(adminData);

    } catch (error) {
        console.error("Erro ao listar dados do administrador:", error);
        return reply.status(500).send({ message: 'Erro ao listar dados do administrador.' });
    }
};




=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\CasaController.js
=================================================================================

import CasaService from "../services/CasaService.js";

export default class CasaController {

    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const casas = await CasaService.getAllHouses(page, limit);
        return reply.status(200).send(casas);
    }

    static async getAllAtivos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const casas = await CasaService.getAllHousesAtivas(page, limit);
        return reply.status(200).send(casas);
    }

    static async getAllInativos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const casas = await CasaService.getAllHousesInativas(page, limit);
        return reply.status(200).send(casas);
    }

    static async count(req, reply) {
        const casas = await CasaService.countHouses();
        return reply.status(200).send(casas);
    }

    static async countAtivas(req, reply) {
        const casas = await CasaService.countHousesAtivas();
        return reply.status(200).send(casas);
    }

    static async inativar(req, reply) {
        const { id } = req.params;
        const casa = await CasaService.inativarCasa(id);
        return reply.status(200).send(casa);
    }

    static async ativar(req, reply) {
        const { id } = req.params;
        const casa = await CasaService.ativarCasa(id);
        return reply.status(200).send(casa);
    }



}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\CepController.js
=================================================================================

import CepService from "../services/CepService.js";

export default class CepController {

    static async buscarCep(req, reply) {
        const { cep } = req.params;

        // salvando cep limpo
        const cepLimpo = cep.replace(/\D/g, '');

        if (!/^\d{8}$/.test(cepLimpo)) {
            return reply.status(400).send({ error: 'CEP inv√°lido' });
        }

        const endereco = await CepService.buscarCep(cepLimpo);
        return reply.send(endereco);
    }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\ComunicadosController.js
=================================================================================

import { createComunicado } from "../dto/comunicados/createComunicadoDTO.js";
import { updateComunicado } from "../dto/comunicados/updateComunicadoDTO.js";
import ComunicadosService from "../services/ComunicadosService.js";

export default class ComunicadosController {
    static async getAll(req, reply){
        const comunicados = await ComunicadosService.getAll();
        return reply.status(200).send(comunicados);
    }

    static async create(req, reply) {
        const validateComunicado = createComunicado.parse(req.body);
        const comunicado = await ComunicadosService.create(validateComunicado);
        return reply.status(201).send(comunicado);
    }

    static async update(req, reply){
        const { id } = req.params;
        const validateComunicado = updateComunicado.parse(req.body);
        const comunicado = await ComunicadosService.update(id, validateComunicado);
        return reply.status(200).send(comunicado);
    }

    static async delete(req, reply){
        const {id} = req.params;
        const comunicado = await ComunicadosService.deleteComunicado(id);
        return reply.status(200).send(comunicado);
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\CondominioController.js
=================================================================================

import CondominioService from "../services/CondominioService.js";
import { createCondominioDTO } from "../dto/condominio/createCondominioDTO.js";
import {updateCondominioDTO} from '../dto/condominio/updateCondominioDTO.js'
import { atribuirSindicoDTO } from "../dto/condominio/atribuirSindicoDTO.js";
import { updateNameCondominioDTO } from "../dto/condominio/updateNameCondominioDTO.js";

export default class CondominioController {
    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const condominios = await CondominioService.getAllCondominios(page, limit);
        return reply.status(200).send(condominios);
    }

    static async getAllActives(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const condominios = await CondominioService.getAllActivesCondominios(page, limit);
        return reply.status(200).send(condominios);
    }

    static async getAllInativos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const condominios = await CondominioService.getAllDeactivetedCondominios(page, limit);
        return reply.status(200).send(condominios);
    }

    static async count(req, reply) {
        const condominiosTotais = await CondominioService.countAllCondominios();
        return reply.status(200).send(condominiosTotais);
    }

    static async create(req, reply) {
        const validateCondominio = createCondominioDTO.parse(req.body);
        const condominio = await CondominioService.createCondominio(validateCondominio)
        return reply.status(201).send(condominio);
    }

    static async update(req, reply) {
        const { id } = req.params;
        const validateCondominio = updateCondominioDTO.parse(req.body);
        const updateCondominio = await CondominioService.updateCondominio(id, validateCondominio);
        return reply.status(200).send(updateCondominio)
    }

    static async updateName(req, reply) {
        const { id } = req.params;
        const validateCondominio = updateNameCondominioDTO.parse(req.body);
        const updateCondominio = await CondominioService.updateNameCondominio(id, validateCondominio);
        return reply.status(200).send(updateCondominio)
    }

    static async atribuirSindico(req, reply) {
        const {id} = req.params;
        const validateSindico = atribuirSindicoDTO.parse(req.body);
        const condominio = await CondominioService.atribuirSindico(id, validateSindico);
        return reply.status(200).send(condominio);
    }

    static async inativar(req, reply) {
        const { id } = req.params;
        const condominio = await CondominioService.inativarCondominio(id);
        return reply.status(200).send(condominio);
    }

    static async ativar(req, reply) {
        const { id } = req.params;
        const condominio = await CondominioService.ativarCondominio(id);
        return reply.status(200).send(condominio);
    }

    static async listarQtdApartamentos(req, reply){
        const { id } = req.params;
        const apartamentos = await CondominioService.countApartamentosPorCondominio(id);
        return reply.status(200).send(apartamentos);
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\CrescimentoController.js
=================================================================================

import CrescimentoUsersService from "../services/CrescimentoUsersService.js";

export default class CrescimentoController {
    static async get(req, reply){
        const crescimentos = await CrescimentoUsersService.getAll();
        return reply.status(200).send(crescimentos)
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\LeituraSensor.js
=================================================================================

import LeituraSensorService from "../services/LeituraSensor.js";

export default class LeituraSensorController {

    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const leitura = await LeituraSensorService.getAll(page, limit);
        return reply.status(200).send(leitura);
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\ResidenciaController.js
=================================================================================

import ResidenciaService from "../services/ResidenciaService.js";

export default class ResidenciaController {

    static async getAll(req, reply) {
        const residencias = await ResidenciaService.getAllResidencias();
        return reply.status(200).send(residencias)
    }

    static async getPorEstado(req, reply) {
        const residencias = await ResidenciaService.getAllDistribuicaoPorUf();
        return reply.status(200).send(residencias);
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\SensorController.js
=================================================================================

import SensorService from "../services/SensorService.js";
import { z } from "zod";

const createSensorSchema = z.object({
    codigo: z.uuid(),
})


export default class SensorController {
    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const sensores = await SensorService.getAll(page, limit);
        return reply.status(200).send(sensores);
    }

    static async getAllInativos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const sensores = await SensorService.getAllInativos(page, limit);
        return reply.status(200).send(sensores);
    }

    static async getAllAtivos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const sensores = await SensorService.getAllAtivos(page, limit);
        return reply.status(200).send(sensores);
    }

    static async getConsumoTotalDosSensores(req, reply) {
        const sensor = await SensorService.consumoTotalSensores();
        return reply.status(200).send(sensor);
    }
    static async getConsumoTotalCasas(req, reply) {
        const sensor = await SensorService.consumoTotalSensoresCasas();
        return reply.status(200).send(sensor);
    }
    static async getConsumoTotalApartamentos(req, reply) {
        const sensor = await SensorService.consumoTotalSensoresApartamento();
        return reply.status(200).send(sensor);
    }

    static async count(req, reply) {
        const sensores = await SensorService.countSensores();
        return reply.status(200).send(sensores);
    }

    static async countAtivos(req, reply) {
        const sensores = await SensorService.countSensoresAtivos();
        return reply.status(200).send(sensores);
    }

    static async inativar(req, reply) {
        const { id } = req.params;
        const sensor = await SensorService.inativarSensor(id);
        return reply.status(200).send(sensor);
    }

    static async ativar(req, reply) {
        const { id } = req.params;
        const sensor = await SensorService.ativarSensor(id);
        return reply.status(200).send(sensor);
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\SuporteController.js
=================================================================================

import SuporteService from "../services/SuporteService.js";

export default class SuporteController {
    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const mensagens = await SuporteService.getAllMensagens(page, limit);
        return reply.status(200).send(mensagens)
    }

    static async enviarMensagem(req, reply) {
        const { id, resposta, respondido_por } = req.body;
        const mensagem = await SuporteService.responderMensagem(id, resposta);
        return reply.status(200).send(mensagem);
    }


}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\TaxaVazamentoController.js
=================================================================================

import TaxaVazamentoService from "../services/TaxaVazamentoService.js";

export default class TaxaVazamentoController {
    static async get(req, reply){
        const vazamentos = await TaxaVazamentoService.getAll();
        return reply.status(200).send(vazamentos);
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\controllers\UserController.js
=================================================================================

import UserService from "../services/UserService.js";

export default class UserController {

    static async getAll(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;

        const users = await UserService.getAllUsers(page, limit);
        return reply.send(users);
    }
    static async getAllSindicos(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;

        const sindicos = await UserService.getAllUsersSindicos(page, limit);
        return reply.send(sindicos);
    }

    static async getAllActives(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const users = await UserService.getAllUserActives(page, limit);
        return reply.send(users);
    }

    static async getAllDeactivated(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const users = await UserService.getAllUsersDeactivated(page, limit);
        return reply.send(users);
    }

    static async getAllMoramCondominio(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const users = await UserService.getAllUsersDeCondominio(page, limit);
        return reply.send(users);
    }

    static async getAllMoramEmCasa(req, reply) {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 10;
        const users = await UserService.getAllUsersDeCasa(page, limit);
        return reply.send(users);
    }

    static async getById(req, reply) {
        const { id } = req.params;
        const user = await UserService.getUserById(id);
        return reply.send(user)
    }

    static async count(req, reply) {
        const users = await UserService.countUsers();
        return reply.status(200).send(users);
    }

    static async countAtivos(req, reply) {
        const users = await UserService.countUsersAtivos();
        return reply.status(200).send(users);
    }

    static async countSindicos(req, reply) {
        const sindicos = await UserService.countSindicos();
        return reply.status(200).send(sindicos);
    }

    static async countMoradores(req, reply) {
        const moradores = await UserService.countMoradores();
        return reply.status(200).send(moradores);
    }

    static async moradoresCasa(req, reply) {
        const moradores = await UserService.countMoradoresCasa();
        return reply.status(200).send(moradores);
    }

    static async moradoresApartamentos(req, reply) {
        const moradores = await UserService.countMoradoresApartamentos();
        return reply.status(200).send(moradores);
    }

    static async deactivate(req, reply) {
        const { id } = (req.params);
        const user = await UserService.deactivateUser(id);
        return reply.status(200).send(user)
    }

    static async ativar(req, reply) {
        const { id } = (req.params);
        const user = await UserService.ativarUser(id);
        return reply.status(200).send(user)
    }

    static async sindico(req, reply) {
        const { id } = req.params;
        const user = await UserService.setarSindico(id);
        return reply.status(200).send(user);
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\admin\createAdminDTO.js
=================================================================================

import { z } from 'zod';

export const createAdminDTO = z.object({
  email: z.string().email(),
  password: z.string().min(6),
});



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\admin\updateAdminDTO.js
=================================================================================

import {z} from "zod";

export const updateAdminDTO = z.object({
    email: z.string().email().optional(),
    role: z.enum(['superadmin', 'admin']).optional(),
});


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\admin\updatePasswordDTO.js
=================================================================================

import {z} from 'zod';

export const updatePasswordDTO = z.object({
    password: z.string()
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\comunicados\createComunicadoDTO.js
=================================================================================

import {z} from 'zod';

export const createComunicado = z.object({
   title: z.string(),
   subject: z.string(),
   addressee: z.enum(["administradores", "usu√°rios"]),
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\comunicados\updateComunicadoDTO.js
=================================================================================

import {z} from 'zod';

export const updateComunicado = z.object({
   title: z.string().optional(),
   subject: z.string().optional(),
   addressee: z.enum(["administradores", "usu√°rios"]).optional(),
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\condominio\atribuirSindicoDTO.js
=================================================================================

import {z} from 'zod';

export const atribuirSindicoDTO = z.object({
    sindico_id: z.string().uuid()
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\condominio\createCondominioDTO.js
=================================================================================

import { z } from "zod";

export const createCondominioDTO = z.object({
    name: z.string(),
    numero: z.string(),
    cep: z.string().min(8).max(9),
    sindico_id: z.string().uuid().optional()
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\condominio\updateCondominioDTO.js
=================================================================================

import { z } from "zod";

export const updateCondominioDTO = z.object({
    name: z.string().optional(),
    numero: z.string().optional(),
    cep: z.string().min(8).max(9).optional(),
    sindico_id: z.string().uuid().optional()
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\dto\condominio\updateNameCondominioDTO.js
=================================================================================

import { z } from "zod";

export const updateNameCondominioDTO = z.object({
    name: z.string(),
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\jobs\gerarLeiturasDiarias.js
=================================================================================

import axios from 'axios';
import LeituraSensor from '../models/LeituraSensor.js';
import Sensor from '../models/Sensor.js';
import Casa from '../models/Casa.js';
import Apartamento from '../models/Apartamento.js';

const MEDIA_POR_PESSOA = 150;
// const WEBHOOK_URL = 'http://localhost:5678/webhook/alerta-aqua';
 const WEBHOOK_URL = '';

export async function registrarLeitura(sensorId, consumo, vazamento = false) {
    const leitura = await LeituraSensor.create({
        sensor_id: sensorId,
        consumo,
        vazamento_detectado: vazamento,
        data_registro: new Date()
    });

    const sensor = await Sensor.findByPk(sensorId, {
        include: [
            { model: Casa, attributes: ['numero_moradores', 'responsavel_nome', 'responsavel_email'] },
            { model: Apartamento, attributes: ['numero_moradores', 'responsavel_nome', 'responsavel_email'] }
        ]
    });

    const moradores = sensor.Casa?.numero_moradores || sensor.Apartamento?.numero_moradores || 1;
    const limite = moradores * MEDIA_POR_PESSOA;

    if (consumo > limite || vazamento) {
        try {
            await axios.post(WEBHOOK_URL, {
                tipo: vazamento ? 'vazamento' : 'consumo_alto',
                usuario: sensor.Casa?.responsavel_nome || sensor.Apartamento?.responsavel_nome,
                email: sensor.Casa?.responsavel_email || sensor.Apartamento?.responsavel_email,
                consumo
            });
            console.log(`Webhook disparado para sensor ${sensorId}`);
        } catch (err) {
            console.error('Erro ao disparar webhook', err.message);
        }
    }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\middlewares\AuthMiddleware.js
=================================================================================

import jwt from 'jsonwebtoken';
import Admin from '../models/Admin.js';

export const autenticarAdmin = async (req, reply) => {
    try {
        const authHeader = req.headers['authorization'];

        if (!authHeader) {
            return reply.status(401).send({ message: 'Token n√£o fornecido.' });
        }

        const parts = authHeader.split(' ');
        if (parts.length !== 2 || parts[0] !== 'Bearer') {
            return reply.status(401).send({ message: 'Token inv√°lido.' });
        }

        const token = parts[1].replace(/"/g, ''); 


        console.log("Token recebido:", token);
        console.log("JWT_SECRET:", process.env.JWT_SECRET);
        console.log("Tamanho:", process.env.JWT_SECRET.length);

        const decoded = jwt.verify(token, process.env.JWT_SECRET);

        const admin = await Admin.findByPk(decoded.id);

        if (!admin || admin.status !== 'ativo') {
            return reply.status(401).send({ message: 'Administrador inv√°lido ou inativo.' });
        }

        req.admin = admin;

    } catch (error) {
        console.error("Erro na autentica√ß√£o:", error);
        return reply.status(401).send({ message: 'Token inv√°lido ou expirado.' });
    }
};



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\middlewares\errorHandler.js
=================================================================================

export default async function errorHandler(fastify) {
  fastify.setErrorHandler((err, req, reply) => {
    // Log detalhado (mas ainda seguro)
    fastify.log.error({
      error: err.message,
      stack: err.stack,
      url: req.url,
      method: req.method,
      params: req.params,
      body: req.body,
    });

    // Tratamento de erros de valida√ß√£o (ex: Zod, SequelizeValidationError)
    if (err.name === "ZodError") {
      return reply.status(400).send({
        message: "Erro de valida√ß√£o dos dados",
        issues: err.errors,
      });
    }

    if (err.name === "SequelizeValidationError") {
      return reply.status(400).send({
        message: "Erro de valida√ß√£o no banco de dados",
        details: err.errors.map((e) => e.message),
      });
    }

    if (err.name === "SequelizeUniqueConstraintError") {
      return reply.status(409).send({
        message: "Registro j√° existe (viola√ß√£o de chave √∫nica)",
      });
    }

    // Erros de autentica√ß√£o/autoriza√ß√£o
    if (err.statusCode === 401) {
      return reply.status(401).send({ message: "N√£o autorizado" });
    }

    if (err.statusCode === 403) {
      return reply.status(403).send({ message: "Acesso negado" });
    }

    // Erro gen√©rico
    const status = err.statusCode || 500;
    const message =
      err.message && status !== 500
        ? err.message
        : "Erro interno do servidor";

    reply.status(status).send({ message });
  });
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Admin.js
=================================================================================

import { Model  , DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import { v4 as uuidv4 } from 'uuid';
import bcrypt from 'bcryptjs'
import sequelizePaginate from 'sequelize-paginate'

export default class Admin extends Model {
    // compare hash password
    async checkPassword(password) {
        return bcrypt.compare(password, this.password)
    }
}


Admin.init({
    id: {
        type: DataTypes.CHAR(36),
        primaryKey: true,
        defaultValue: () => uuidv4(),
    },
    email: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    password: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    img_url: {
        type: DataTypes.STRING,
        allowNull: true
    },
    type: {
        type: DataTypes.ENUM('superadmin', 'admin'),
        defaultValue: 'admin',
        allowNull: false
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        defaultValue: 'ativo'
    }
}, {
    sequelize,
    tableName: 'admins',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em',

    hooks: {
        
        // hash create user
        beforeCreate: async (user, options) => {
            if (user.password) {
                const salt = await bcrypt.genSalt(10);
                user.password = await bcrypt.hash(user.password, salt);
            }
        },
        
        // hash update user
        beforeUpdate: async (user, options) => {
            if (user.changed('password')) {
                const salt = await bcrypt.genSalt(10);
                user.password = await bcrypt.hash(user.password, salt)
            }
        }
    }
})
sequelizePaginate.paginate(Admin);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Alertas.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import Sensor from "./Sensor.js";
import sequelizePaginate from 'sequelize-paginate'
import Casa from "./Casa.js";
import Apartamento from "./Apartamento.js";

export default class Alertas extends Model {}

Alertas.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        allowNull: true
    },
    sensor_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: {model: Sensor, key: 'id'}
    },
    residencia_type: {
        type: DataTypes.ENUM("casa", "apartamento"),
        allowNull: false
    },
    residencia_id: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    tipo: {
        type: DataTypes.ENUM("vazamento", 'consumo_alto'),
        allowNull: false
    },
    mensagem: {
        type: DataTypes.STRING,
        allowNull: true
    },
    nivel: {
        type: DataTypes.ENUM('baixo', 'medio', 'alto', 'critico'),
        defaultValue: 'baixo'
    },
    resolvido: {
        type: DataTypes.BOOLEAN,
        defaultValue: false
    }
}, {
    sequelize,
    tableName: 'alertas',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: false
})

Alertas.belongsTo(Casa, { as: 'casa', foreignKey: 'residencia_id' });
Alertas.belongsTo(Apartamento, { as: 'apartamento', foreignKey: 'residencia_id' });

sequelizePaginate.paginate(Alertas);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Apartamento.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import Condominio from "./Condominio.js";
import sequelizePaginate from 'sequelize-paginate'
import Sensor from "./Sensor.js";

export default class Apartamento extends Model { }

Apartamento.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    condominio_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { model: Condominio, key: 'id' }
    },
    numero: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    bloco: {
        type: DataTypes.STRING,
        allowNull: true
    },
    numero_moradores: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    sensor_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { model: Sensor, key: 'id' }
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        allowNull: false,
        defaultValue: 'ativo'
    },
    codigo_acesso: {
        type: DataTypes.CHAR(10),
        defaultValue: () => nanoid(5),
        allowNull: false,
        unique: true
    },
    responsavel_id: {
        type: DataTypes.CHAR(36),
        allowNull: true,
        references: { model: 'users', key: 'id' }
    }
}, {
    sequelize,
    tableName: 'apartamentos',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})

Apartamento.belongsTo(Condominio, { as: 'condominio', foreignKey: 'condominio_id' });

sequelizePaginate.paginate(Apartamento);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\ApartamentoView.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import sequelizePaginate from "sequelize-paginate";

export default class ApartamentoView extends Model {}

ApartamentoView.init(
  {
    apartamento_id: {
      type: DataTypes.INTEGER,
      primaryKey: true,
    },
    apartamento_codigo: {      
      type: DataTypes.CHAR(10),
    },
    condominio_id: {
      type: DataTypes.INTEGER,
    },
    condominio_nome: {
      type: DataTypes.STRING,
    },
    logradouro: {
      type: DataTypes.STRING,
    },
    condominio_numero: {
      type: DataTypes.STRING,
    },
    bairro: {
      type: DataTypes.STRING,
    },
    cidade: {
      type: DataTypes.STRING,
    },
    uf: {
      type: DataTypes.STRING(2),
    },
    cep: {
      type: DataTypes.STRING(9),
    },
    endereco_completo: {
      type: DataTypes.STRING,
    },
    endereco_condominio: {
      type: DataTypes.STRING,
    },
    numero_moradores: {
      type: DataTypes.INTEGER,
    },
    responsavel_id: {        
      type: DataTypes.CHAR(36),
    },
    responsavel_nome: {
      type: DataTypes.STRING,
    },
    responsavel_email: {
      type: DataTypes.STRING,
    },
    responsavel_cpf: {
      type: DataTypes.STRING,
    },
    sensor_id: {
      type: DataTypes.INTEGER,
    },
    sensor_codigo: {
      type: DataTypes.CHAR(10),
    },
    consumo_total: {
      type: DataTypes.DECIMAL(10, 2),
    },
    apartamento_status: {
      type: DataTypes.ENUM("ativo", "inativo"),
    },
    sensor_status: {
      type: DataTypes.ENUM("ativo", "inativo"),
    },
    ultimo_envio: {
      type: DataTypes.DATE,
    },
  },
  {
    sequelize,
    tableName: "vw_apartamentos",
    timestamps: false,
  }
);

sequelizePaginate.paginate(ApartamentoView);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Casa.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import sequelizePaginate from 'sequelize-paginate'
import Sensor from "./Sensor.js";
import { nanoid } from "nanoid";

export const estados = {
    AC: "Acre",
    AL: "Alagoas",
    AP: "Amap√°",
    AM: "Amazonas",
    BA: "Bahia",
    CE: "Cear√°",
    DF: "Distrito Federal",
    ES: "Esp√≠rito Santo",
    GO: "Goi√°s",
    MA: "Maranh√£o",
    MT: "Mato Grosso",
    MS: "Mato Grosso do Sul",
    MG: "Minas Gerais",
    PA: "Par√°",
    PB: "Para√≠ba",
    PR: "Paran√°",
    PE: "Pernambuco",
    PI: "Piau√≠",
    RJ: "Rio de Janeiro",
    RN: "Rio Grande do Norte",
    RS: "Rio Grande do Sul",
    RO: "Rond√¥nia",
    RR: "Roraima",
    SC: "Santa Catarina",
    SP: "S√£o Paulo",
    SE: "Sergipe",
    TO: "Tocantins",
};

export default class Casa extends Model { }

Casa.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    logradouro: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    bairro: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    numero: {
        type: DataTypes.CHAR(10),
        allowNull: false
    },
    cidade: {
        type: DataTypes.STRING(100),
        allowNull: false
    },
    uf: {
        type: DataTypes.STRING(2),
        allowNull: false,
    },
    estado: {
        type: DataTypes.STRING(50),
        allowNull: false,
    },
    cep: {
        type: DataTypes.CHAR(10),
        allowNull: false
    },
    numero_moradores: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 1
    },
    sensor_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { model: Sensor, key: 'id' }
    },
    codigo_acesso: {
        type: DataTypes.CHAR(10),
        defaultValue: () => nanoid(5).replace(/[^a-zA-Z0-9]/g, '').toUpperCase(),
        allowNull: false,
        unique: true
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        allowNull: false,
        defaultValue: 'ativo'
    },
    responsavel_id: {
        type: DataTypes.CHAR(36),
        allowNull: true,
        references: { model: 'users', key: 'id' }
    }
}, {
    sequelize,
    tableName: 'casas',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em',

    hooks: {
        beforeValidate: (casa) => {
            if (casa.uf) {
                casa.estado = estados[casa.uf] || casa.estado;
            }
        },
    },
})

sequelizePaginate.paginate(Casa);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\CasaView.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import sequelizePaginate from "sequelize-paginate";

export default class CasaView extends Model {}

CasaView.init(
  {
    casa_id: {
      type: DataTypes.INTEGER,
      primaryKey: true,
    },
    casa_codigo: { // novo campo
      type: DataTypes.CHAR(10),
    },

    endereco_completo: {
      type: DataTypes.STRING,
    },
    numero_moradores: {
      type: DataTypes.INTEGER,
    },
    responsavel_id: { 
      type: DataTypes.CHAR(36),
    },
    responsavel_nome: {
      type: DataTypes.STRING,
    },
    responsavel_email: {
      type: DataTypes.STRING,
    },
    responsavel_cpf: {
      type: DataTypes.STRING,
    },
    sensor_id: {
      type: DataTypes.INTEGER,
    },
    sensor_codigo: {
      type: DataTypes.CHAR(10),
    },
    consumo_total: {
      type: DataTypes.DECIMAL(10, 2),
    },
    casa_status: {
      type: DataTypes.ENUM("ativo", "inativo"),
    },
    sensor_status: {
      type: DataTypes.ENUM("ativo", "inativo"),
    },
    ultimo_envio: {
      type: DataTypes.DATE,
    },
    cep: {
      type: DataTypes.STRING(10),
    },
    estado: {
      type: DataTypes.STRING(50),
    },
    cidade: {
      type: DataTypes.STRING(100),
    },
    uf: {
      type: DataTypes.STRING(2),
    },
    bairro: {
      type: DataTypes.STRING(255),
    },
    numero: {
      type: DataTypes.STRING(10),
    },
  },
  {
    sequelize,
    tableName: "vw_casas",
    timestamps: false,
  }
);

sequelizePaginate.paginate(CasaView);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Comunicados.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";

export default class Comunicados extends Model {}

Comunicados.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    title: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    subject: {
        type: DataTypes.TEXT,
        allowNull: false
    },
    addressee: {
        type: DataTypes.ENUM('adminstradores', 'usu√°rios'),
        allowNull: false
    }
}, {
    sequelize,
    tableName: 'comunicados',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Condominio.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import { nanoid } from 'nanoid';
import sequelizePaginate from 'sequelize-paginate'

export const estados = {
    AC: "Acre",
    AL: "Alagoas",
    AP: "Amap√°",
    AM: "Amazonas",
    BA: "Bahia",
    CE: "Cear√°",
    DF: "Distrito Federal",
    ES: "Esp√≠rito Santo",
    GO: "Goi√°s",
    MA: "Maranh√£o",
    MT: "Mato Grosso",
    MS: "Mato Grosso do Sul",
    MG: "Minas Gerais",
    PA: "Par√°",
    PB: "Para√≠ba",
    PR: "Paran√°",
    PE: "Pernambuco",
    PI: "Piau√≠",
    RJ: "Rio de Janeiro",
    RN: "Rio Grande do Norte",
    RS: "Rio Grande do Sul",
    RO: "Rond√¥nia",
    RR: "Roraima",
    SC: "Santa Catarina",
    SP: "S√£o Paulo",
    SE: "Sergipe",
    TO: "Tocantins",
};

export default class Condominio extends Model { }

Condominio.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    name: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    logradouro: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    numero: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    bairro: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    cidade: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    uf: {
        type: DataTypes.STRING(2),
        allowNull: false,
    },
    estado: {
        type: DataTypes.STRING(50),
        allowNull: false,
    },
    cep: {
        type: DataTypes.CHAR(9),
        allowNull: false
    },
    codigo_acesso: {
        type: DataTypes.CHAR(10),
        defaultValue: () => nanoid(5).replace(/[^a-zA-Z0-9]/g, '').toUpperCase(),
        allowNull: false,
        unique: true
    },
    sindico_id: {
        type: DataTypes.CHAR(36),
        allowNull: true,
        references: { model: 'users', key: 'id' }
    },
    status: {
        type: DataTypes.ENUM("ativo", 'inativo'),
        defaultValue: 'ativo',
        allowNull: false
    }
}, {
    sequelize,
    tableName: 'condominios',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em',

    hooks: {
        beforeValidate: (condominio) => {
            if (condominio.uf) {
                condominio.estado = estados[condominio.uf] || condominio.estado;
            }
        },
    },
})

sequelizePaginate.paginate(Condominio);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\CondominioView.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import sequelizePaginate from "sequelize-paginate";

export default class CondominioView extends Model {}

CondominioView.init(
  {
    condominio_id: {
      type: DataTypes.INTEGER,
      primaryKey: true,
    },
    condominio_nome: {
      type: DataTypes.STRING,
      allowNull: false,
    },
    condominio_codigo: {
      type: DataTypes.STRING(10),
      allowNull: false,
    },
    logradouro: {
      type: DataTypes.STRING,
      allowNull: false,
    },
    numero: {
      type: DataTypes.STRING(10),
      allowNull: true,
    },
    bairro: {
      type: DataTypes.STRING,
      allowNull: true,
    },
    cidade: {
      type: DataTypes.STRING,
      allowNull: false,
    },
    uf: {
      type: DataTypes.STRING(2),
      allowNull: false,
    },
    cep: {
      type: DataTypes.STRING(9),
      allowNull: true,
    },
    endereco_completo: {
      type: DataTypes.STRING,
      allowNull: false,
    },
    data_criacao: {
      type: DataTypes.DATE,
      allowNull: false,
    },
    numero_apartamentos: {
      type: DataTypes.INTEGER,
      allowNull: true,
    },
    numero_sensores: {
      type: DataTypes.INTEGER,
      allowNull: true,
    },
    sindico_nome: {
      type: DataTypes.STRING,
      allowNull: true,
    },
    condominio_status: {
      type: DataTypes.ENUM("ativo", "inativo"),
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: "vw_condominios",
    timestamps: false,
  }
);

sequelizePaginate.paginate(CondominioView);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\CrescimentoUserView.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";

export default class CrescimentoUserView extends Model {}

CrescimentoUserView.init({
    mes: {
        type: DataTypes.DATE,
        primaryKey: true
    },
    total_condominio: {
        type: DataTypes.INTEGER
    },
    total_casa: {
        type: DataTypes.INTEGER,
    },
    total_geral: {
        type: DataTypes.INTEGER
    }
}, {
    sequelize,
    tableName: 'view_crescimento_usuarios',
    freezeTableName: true,
    timestamps: false
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\LeituraSensor.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import Sensor from "./Sensor.js";
import sequelizePaginate from 'sequelize-paginate'

export default class LeituraSensor extends Model {}

LeituraSensor.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    sensor_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: {model: Sensor, key: 'id'}
    },
    consumo: {
        type: DataTypes.DECIMAL(10, 2),
        allowNull: false
    },
    vazamento_detectado: {
        type: DataTypes.BOOLEAN,
        defaultValue: false
    },
    data_registro: {
        type: DataTypes.DATE,
        defaultValue: DataTypes.NOW
    }
}, {
    sequelize,
    tableName: 'leituras_sensores',
    timestamps: false
})


sequelizePaginate.paginate(LeituraSensor);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Sensor.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import { nanoid } from 'nanoid';
import sequelizePaginate from 'sequelize-paginate'

export default class Sensor extends Model { }

Sensor.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    codigo: {
        type: DataTypes.CHAR(10), 
        defaultValue: () => nanoid(10), 
        allowNull: false,
        unique: true
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        defaultValue: 'ativo'
    },
    consumo_total: {
        type: DataTypes.DECIMAL(10, 2),
        allowNull: false
    },
    ultimo_envio: {
        type: DataTypes.DATE,
        allowNull: true
    }
}, {
    sequelize,
    tableName: 'sensores',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})

sequelizePaginate.paginate(Sensor);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\SensorView.js
=================================================================================

import {Model, DataTypes} from 'sequelize';
import sequelize from '../config/sequelize.js';
import sequelizePaginate from 'sequelize-paginate'

export default class SensorView extends Model {}

SensorView.init({
    sensor_id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
    },
    sensor_codigo: {
        type: DataTypes.STRING(10),
        allowNull: false,
    },
    residencia_type: {
        type: DataTypes.ENUM('casa', 'apartamento'),
        allowNull: true,
    },
    localizacao: {
        type: DataTypes.STRING(255),
        allowNull: true,
    },
    consumo_total: {
        type: DataTypes.DECIMAL(10,2),
        allowNull: false,
        defaultValue: 0
    },
    sensor_status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        allowNull: false
    },
    ultimo_envio: {
        type: DataTypes.DATE,
        allowNull: true
    }
}, {
    sequelize,
    tableName: "vw_sensores_residencias",
    timestamps: false
});

sequelizePaginate.paginate(SensorView);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\Suporte.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import User from "./User.js";
import Admin from "./Admin.js";
import sequelizePaginate from 'sequelize-paginate'

export default class Suporte extends  Model {}

Suporte.init({
    id: {
       type: DataTypes.INTEGER,
       primaryKey: true,
       autoIncrement: true
    },
    assunto: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    mensagem: {
        type: DataTypes.STRING,
        allowNull: false
    },
    remetente_id: {
        type: DataTypes.CHAR(36),
        allowNull: false,
        references: {model: User, key: 'id'}
    },
    resposta: {
        type: DataTypes.STRING,
        allowNull: false
    },
    status: {
        type: DataTypes.ENUM('pendente', 'respondido'),
        defaultValue: 'pendente',
    }
}, {
    sequelize,
    tableName: 'suporte',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em'
})

sequelizePaginate.paginate(Suporte);


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\TaxaVazamentoView.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";

export default class TaxaVazamentoView extends Model {}

TaxaVazamentoView.init({
    total_leituras: {
        type: DataTypes.INTEGER,
        primaryKey: true
    },
    total_vazamentos: {
        type: DataTypes.INTEGER
    },
    percentual_vazamentos: {
        type: DataTypes.DECIMAL(10, 2)
    }
}, {
    sequelize,
    tableName: 'vw_taxa_vazamentos_geral',
    freezeTableName: true,
    timestamps: false
})


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\User.js
=================================================================================

import sequelize from "../config/sequelize.js";
import { DataTypes, Model } from "sequelize";
import { v4 as uuidv4 } from 'uuid';
import bcrypt from 'bcryptjs'
import sequelizePaginate from 'sequelize-paginate'
import Apartamento from './Apartamento.js';
import Casa from "./Casa.js";

export default class User extends Model {
    // compare hash password
    async checkPassword(password) {
        return bcrypt.compare(password, this.password)
    }
}

User.init({
    id: {
        type: DataTypes.CHAR(36),
        primaryKey: true,
        defaultValue: () => uuidv4(),
    },
    name: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    email: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    cpf: {
        type: DataTypes.CHAR(14),
        allowNull: false
    },
    password: {
        type: DataTypes.STRING(255),
        allowNull: false
    },
    // representa de onde o usu√°rio vem
    type: {
        type: DataTypes.ENUM('casa', 'condominio'),
        allowNull: false
    },
    responsavel_id: {
        type: DataTypes.CHAR(36),
        allowNull: true,
        references: { model: 'users', key: 'id' }
    },
    // indica para a residencia/unidade para atribuir para a tabela correta
    // uma especie de polimorfismo em banco de dados
    residencia_type: {
        type: DataTypes.ENUM('casa', 'apartamento'),
        allowNull: false
    },
    // id da residencia
    residencia_id: {
        type: DataTypes.INTEGER,
        allowNull: true
    },
    status: {
        type: DataTypes.ENUM('ativo', 'inativo'),
        defaultValue: 'ativo',
        allowNull: false
    },
    role: {
        type: DataTypes.ENUM('morador', 'sindico'),
        defaultValue: 'morador',
        allowNull: false
    },
}, {
    sequelize,
    tableName: 'users',
    timestamps: true,
    createdAt: 'criado_em',
    updatedAt: 'atualizado_em',

    // hooks hash password
    hooks: {

        // hash create user
        beforeCreate: async (user, options) => {
            if (user.password) {
                const salt = await bcrypt.genSalt(10);
                user.password = await bcrypt.hash(user.password, salt);
            }
        },

        // hash update user
        beforeUpdate: async (user, options) => {
            if (user.changed('password')) {
                const salt = await bcrypt.genSalt(10);
                user.password = await bcrypt.hash(user.password, salt)
            }
        }
    }
})
User.belongsTo(Casa, {
    foreignKey: 'residencia_id',
    constraints: false,
    as: 'casa'
});

User.belongsTo(Apartamento, {
    foreignKey: 'residencia_id',
    constraints: false,
    as: 'apartamento'
});
sequelizePaginate.paginate(User);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\models\UserView.js
=================================================================================

import { Model, DataTypes } from "sequelize";
import sequelize from "../config/sequelize.js";
import sequelizePaginate from "sequelize-paginate";

export default class UserView extends Model {}

UserView.init(
  {
    user_id: {
      type: DataTypes.CHAR(36),
      primaryKey: true,
    },
    user_name: {
      type: DataTypes.STRING,
    },
    user_email: {
      type: DataTypes.STRING,
    },
    user_cpf: {
      type: DataTypes.STRING,
    },
    user_role: { 
      type: DataTypes.ENUM("morador", "sindico"),
    },
    user_type: { 
      type: DataTypes.ENUM("casa", "condominio"),
    },
    user_status: {
      type: DataTypes.ENUM("ativo", "inativo"),
    },
    residencia_type: { 
      type: DataTypes.ENUM("casa", "apartamento"),
    },
    residencia_id: {
      type: DataTypes.INTEGER,
    },
    responsavel_id: {
      type: DataTypes.CHAR(36),
    },
    responsavel_nome: {
      type: DataTypes.STRING,
    },
    responsavel_email: {
      type: DataTypes.STRING,
    },
    responsavel_cpf: {
      type: DataTypes.STRING,
    },
    logradouro: {
      type: DataTypes.STRING,
    },
    numero: {
      type: DataTypes.STRING,
    },
    bairro: {
      type: DataTypes.STRING,
    },
    cidade: {
      type: DataTypes.STRING,
    },
    uf: {
      type: DataTypes.CHAR(2),
    },
    cep: {
      type: DataTypes.STRING,
    },
  },
  {
    sequelize,
    tableName: "vw_users",
    timestamps: false,
  }
);

sequelizePaginate.paginate(UserView);



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\admin.routes.js
=================================================================================

import AdminController from "../controllers/AdminController.js";
import { autenticarAdmin } from "../middlewares/AuthMiddleware.js";
import uploadProfile  from '../controllers/AdminController.js';
import { verifyToken } from '../controllers/AuthController.js';

export default async function adminRoutes(fastify) {

        fastify.get('/',
                {
                        schema: {
                                summary: 'Listando todos os admins do sistema',
                                tags: ['administradores'],
                                description: 'Listar admis'
                        }
                }, AdminController.getAll);

        fastify.get('/ativos',
                {
                        schema: {
                                summary: 'Listando todos os administadores ativos do sistema',
                                tags: ['administradores'],
                                description: 'Listar administradores ativos'
                        }
                }, AdminController.getAllAtivos);

        fastify.get('/inativos',
                {
                        schema: {
                                summary: 'Listando todos os administradores inativos do sistema',
                                tags: ['administradores'],
                                description: 'Listar administradores inativos'
                        }
                }, AdminController.getAllInativos);

        fastify.post('/',
                {
                        schema: {
                                summary: 'Criando novo administrador',
                                tags: ['administradores'],
                                description: 'Criando novo administrador para o sistema com o valor default de admin'
                        }
                }, AdminController.create);

        fastify.put('/:id', {
                schema: {
                        summary: 'Atualizando email de um administrador',
                        tags: ['administradores'],
                        description: 'Superadmin atualizando cadastro de um admin comum'
                }
        }, AdminController.update);

        fastify.patch('/:id/inativar', {
                schema: {
                        summary: 'Inativando um administrador',
                        tags: ['administradores'],
                        description: 'Inativando um administrador'
                }
        }, AdminController.inativar);

        fastify.patch('/:id/ativar',
                {
                        schema: {
                                summary: 'Ativando um administrador',
                                tags: ['administradores'],
                                description: 'Ativando um administrador'
                        }
                }, AdminController.ativar);

        fastify.patch('/me',
                {
                        schema: {
                                summary: 'Alterar informa√ß√µes do administrador conectado via token',
                                tags: ['administradores'],
                                description: 'Alterar infos do administrador'
                        },
                        preHandler: autenticarAdmin
                },
                AdminController.updatePassword
        );

        fastify.post('/upload-img', { preHandler: verifyToken }, AdminController.uploadProfile);

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\alertas.routes.js
=================================================================================

import AlertasController from "../controllers/AlertaController.js";

export default async function alertasRoutes(fastify) {

    fastify.get('/',
        {
            schema: {
                summary: 'Listando todos os alertas',
                tags: ['alertas'],
                description: 'Todos os alertas do sistema'
            }
        }, AlertasController.getAll);

    fastify.get('/ativos',
        {
            schema: {
                summary: 'Todos os alertas ativos',
                tags: ['alertas'],
                description: 'Listando todos os alertas ativos do sistema'
            }
        }, AlertasController.getAllAtivos);

    fastify.get('/inativos',
        {
            schema: {
                summary: 'Todos os alertas inativos',
                tags: ['alertas'],
                description: 'Listando todos os alertas inativos do sistema'
            }
        }, AlertasController.getAllInativos);

    fastify.get('/recentes',
        {
            schema: {
                summary: 'Os ultimos 5 alertas recentes',
                tags: ['alertas'],
                description: 'Listando os ultimos 5 alertas recentes do sistema'
            }
        }, AlertasController.getRecentes);

    fastify.get('/count/ativos',
        {
            schema: {
                summary: 'Contagem de alertas ativos',
                tags: ['alertas'],
                description: 'Contagem dos alertas ativos do sistema'
            }
        }, AlertasController.countAtivos);

    fastify.get('/count/vazamentos',
        {
            schema: {
                summary: 'Contagem de alertas por vazamento',
                tags: ['alertas'],
                description: 'Contagem de alertas por vazamento do sistema'
            }
        }, AlertasController.countVazamentos);

    fastify.get('/count/consumo-alto',
        {
            schema: {
                summary: 'Contagem de alertas por consumo alto',
                tags: ['alertas'],
                description: 'Contagem de alertas por consumo alto do sistema'
            }
        }, AlertasController.countConsumoAlto);

    fastify.get('/:id/count/casas',
        {
            schema: {
                summary: 'Contagem de alertas que pertecem a casas',
                tags: ['alertas'],
                description: 'Contagem de alertas que pertecem a casa'
            }
        }, AlertasController.countPorCasa);

    fastify.get('/:id/count/apartamentos',
        {
            schema: {
                summary: 'Contagem de alertas que pertecem a apartamentos',
                tags: ['alertas'],
                description: 'Contagem de alertas que pertecem a apartamentos do sistema'
            }
        }, AlertasController.countPorApartamento);

    fastify.get('/count/condominios',
        {
            schema: {
                summary: 'Contagem de alertas que pertecem a condominios',
                tags: ['alertas'],
                description: 'Contagem de alertas que pertecem a condominios do sistema'
            }

        }, AlertasController.countPorCondominio);
    fastify.patch('/:id',
        {
            schema: {
                summary: 'Resolver alertar',
                tags: ['alertas'],
                description: 'Resolvendo o alerta por ID, marcando como resolvido'
            }
        }, AlertasController.resolverAlerta);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\apartamento.routes.js
=================================================================================

import ApartamentoController from "../controllers/ApartamentoController.js";

export default async function unidadeRoutes(fastify) {

    fastify.get('/',
        {
            schema: {
                summary: 'Todos os apartamentos',
                tags: ['apartamentos'],
                description: 'Listando todos os apartamentos do sistema'
            }
        }, ApartamentoController.getAll);

    fastify.get('/ativos',
        {
            schema: {
                summary: 'Todos os apartamentos ativo',
                tags: ['apartamentos'],
                description: 'Listando todos os apartamentos ativos do sistema'
            }
        }, ApartamentoController.getAllAtivos);

    fastify.get('/inativos',
        {
            schema: {
                summary: 'Todos os apartamentos inativos',
                tags: ['apartamentos'],
                description: 'Listando todos os apartamentos inativos do sistema'
            }
        },
        ApartamentoController.getAllInativos);

    fastify.get('/count',
        {
            schema: {
                summary: 'Contagem de apartamentos no sistema',
                tags: ['apartamentos'],
                description: 'Fazendo contagem de apartamentos no sistema'
            }
        },   ApartamentoController.count);

    fastify.patch('/:id/inativar',
        {
            schema :{
                summary: 'Inativando um apartamento',
                tags: ['apartamentos'],
                description: 'Inativando um apartamento especifico do sistema'
            }
        }, ApartamentoController.inativar);
        
    fastify.patch('/:id/ativar',
        {
            schema: {
                summary: 'Ativando um apartamento',
                tags: ['apartamentos'],
                description: 'Ativando um apartamento especifico do sistema'
            }
        },      ApartamentoController.ativar);

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\auth.routes.js
=================================================================================

import { Login, Logout, getMe, verifyToken } from "../controllers/AuthController.js";
import { autenticarAdmin } from "../middlewares/AuthMiddleware.js";

export default async function authRoutes(fastify) {
    fastify.post('/login',
        {
            schema: {
                summary: 'Autentica√ß√£o para entrar no sistema',
                tags: ['autentica√ß√£o'],
                description: 'Rota para adentrar ao sistema'
            }
        }, Login);
    fastify.get('/me',
        {
            schema: {
                summary: 'Get de informa√ß√µes do user logado',
                tags: ['autentica√ß√£o'],
                description: 'Puxar informa√ß√µes do usu√°rio logado'
            },
            preHandler: autenticarAdmin
        },
        getMe);
        
    fastify.post('/logout', {
        schema: {
            summary: 'Logout de conta administrador',
            tags: ['autentica√ß√£o'],
            description: 'Rota para efetuar o logout do administrador'
        },
        preHandler: verifyToken
    }, Logout);
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\casa.routes.js
=================================================================================

import CasaController from "../controllers/CasaController.js";

export default async function casaRoutes(fastify) {

        fastify.get('/',
                {
                        schema: {
                                summary: 'Todas as casas do sistema',
                                tags: ['casas'],
                                description: 'Listando todas as casas do sistema'
                        }
                }, CasaController.getAll);

        fastify.get('/ativos',
                {
                        schema: {
                                summary: 'Todas as casas ativas do sistema',
                                tags: ['casas'],
                                description: 'Listando todas as casas ativas do sistema'
                        }
                }, CasaController.getAllAtivos);

        fastify.get('/inativos',
                {
                        schema: {
                                summary: 'Todas as casas inativas do sistema',
                                tags: ['casas'],
                                description: 'Listando todas as casas inativas do sistema'
                        }
                }, CasaController.getAllInativos);

        fastify.get('/count',
                {
                        schema: {
                                summary: 'Contagem de casas do sistema',
                                tags: ['casas'],
                                description: 'Fazendo contagem de casas do sistema'
                        }
                },
                CasaController.count);

        fastify.get('/count-ativas',
                {
                        schema: {
                                summary: 'Contagem de casas ativas do sistema',
                                tags: ['casas'],
                                description: 'Fazendo contagem de casas ativas do sistema'
                        }
                },
                CasaController.countAtivas);

        fastify.patch('/:id/ativar',
                {
                        schema: {
                                summary: 'Ativando uma casa',
                                tags: ['casas'],
                                description: 'Ativando uma casa inativada do sistema'
                        }
                },
                CasaController.ativar)

        fastify.patch('/:id/inativar',
                {
                        schema: {
                                summary: 'Inativando uma casa',
                                tags: ['casas'],
                                description: 'Inativando uma casa do sistema'
                        }
                },
                CasaController.inativar)
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\cep.routes.js
=================================================================================

import CepController from "../controllers/CepController.js";

export default async function cepRoutes(fastify) {
  fastify.get('/:cep', {
    schema: {
      summary: 'Integrando api externa do Viacep',
      tags: ['cep'],
      description: 'API de cep'
    }
  }, CepController.buscarCep);
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\comunicado.routes.js
=================================================================================

import ComunicadosController from "../controllers/ComunicadosController.js";

export default async function comunicadoRoutes(fastify) {
    fastify.get('/', ComunicadosController.getAll);
    fastify.post('/', ComunicadosController.create);
    fastify.put('/:id', ComunicadosController.update);
    fastify.delete('/:id', ComunicadosController.delete);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\condominio.routes.js
=================================================================================

import CondominioController from "../controllers/CondominioController.js";

export default async function condominioRoutes(fastify) {

    fastify.get('/',
        {
            schema: {
                summary: 'Todos os condominios do sistema',
                tags: ['condominios'],
                description: 'Listando todos os condominios do sistema'
            }
        },
        CondominioController.getAll);

    fastify.get('/ativos',
        {
            schema: {
                summary: 'Todos os condominios ativos do sistema',
                tags: ['condominios'],
                description: 'Listando todos os condominios ativos do sistema'
            }
        },
        CondominioController.getAllActives);

    fastify.get('/inativos',
        {
            schema: {
                summary: 'Todos os condominios inativos do sistema',
                tags: ['condominios'],
                description: 'Listando todos os condominios inativos do sistema'
            }
        },
        CondominioController.getAllInativos);

    fastify.get('/count',
        {
            schema: {
                summary: 'Contagem de condominios do sistema',
                tags: ['condominios'],
                description: 'Fazendo contagem de condominios do sistema'
            }
        },
        CondominioController.count);

    fastify.get('/:id/apartamentos',
        {
            schema: {
                summary: 'Listar a quantidade de apartamentos de um condominio especifico',
                tags: ['condominios'],
                description: 'Fazendo contagem de apartamentos do condominio'
            }
        },
        CondominioController.listarQtdApartamentos);

    fastify.post('/',
        {
            schema: {
                summary: 'Cadastrando um novo condominio',
                tags: ['condominios'],
                description: 'Criando um novo condominio no sistema'
            }
        },
        CondominioController.create);

    fastify.put('/:id',
        {
            schema: {
                summary: 'Atualizando cadastro de um condominio',
                tags: ['condominios'],
                description: 'Atualizando informa√ß√µes de um condominio do sistema'
            }
        },
        CondominioController.update);

    fastify.put('/:id/name',
        {
            schema: {
                summary: 'Atualizando cadastro do nome de um condominio',
                tags: ['condominios'],
                description: 'Atualizando informa√ß√µes de um condominio do sistema'
            }
        },
        CondominioController.updateName);

    fastify.patch('/:id/sindico',
        {
            schema: {
                summary: 'Atribuindo um sindico para o condominio',
                tags: ['condominios'],
                description: 'Aualizando o sindico do condominio'
            }
        },
        CondominioController.atribuirSindico);

    fastify.patch('/:id/inativar', 
        {
            schema: {
                summary: 'Inativando um condominio',
                tags: ['condominios'],
                description: 'Inativando um condominio do sistema'
            }
        },
        CondominioController.inativar);

    fastify.patch('/:id/ativar',
        {
            schema: {
                summary: 'Ativando um condominio',
                tags: ['condominios'],
                description: 'Ativando um condominio do sistema'
            }
        },
        CondominioController.ativar);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\crescimento.routes.js
=================================================================================

import CrescimentoController from "../controllers/CrescimentoController.js";

export default async function crescimentoRoutes(fastify){
    fastify.get('/', 
        {
            schema: {
                summary: 'Listando todo o crescimento',
                tags: ['crescimento'],
                description: 'view para grafico de crescimento de usuarios'
            }
        },
        CrescimentoController.get);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\leitura.routes.js
=================================================================================

import LeituraSensorController from "../controllers/LeituraSensor.js";

export default async function leituraRoutes(fastify){

    fastify.get('/',
        {
            schema: {
                summary: 'Leitura dos sensores',
                tags: ['leitura-sensores'],
                description: 'Leitura de todos os sensores do sistema.'
            }
        },
        LeituraSensorController.getAll);

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\residencia.routes.js
=================================================================================

import ResidenciaController from "../controllers/ResidenciaController.js";

export default async function residenciaRoutes(fastify) {

    fastify.get('/',
        {
            schema: {
                summary: 'Total de residencias no sistema',
                tags: ['residencias'],
                description: 'Listando o total de residencias cadastrado no sistema'
            }
        },
        ResidenciaController.getAll);

    fastify.get('/estados',
        {
            schema: {
                summary: "Listando o total de residencias por estado",
                tags: ['residencias'],
                description: 'Listando o total de residencias por estado cadastrado no sistema'
            }
        },
        ResidenciaController.getPorEstado);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\sensor.routes.js
=================================================================================

import SensorController from "../controllers/SensorController.js";

export default async function sensorRoutes(fastify) {

        fastify.get('/',
                {
                        schema: {
                                summary: 'Todos os sensores',
                                tags: ['sensores'],
                                description: 'Listando todos os sensores do sistema'
                        }
                },
                SensorController.getAll);

        fastify.get('/ativos',
                {
                        schema: {
                                summary: 'Todos os sensores ativos',
                                tags: ['sensores'],
                                description: 'Listando todos os sensores ativos do sistema'
                        }
                },
                SensorController.getAllAtivos);

        fastify.get('/inativos',
                {
                        schema: {
                                summary: 'Todos os sensores inativos',
                                tags: ['sensores'],
                                description: 'Listando todos os sensores inativos do sistema'
                        }
                },
                SensorController.getAllInativos);

        fastify.get('/count',
                {
                        schema: {
                                summary: 'Contagem de sensores',
                                tags: ['sensores'],
                                description: 'Contagem de sensores do sistema'
                        }
                },
                SensorController.count);

        fastify.get('/count-ativos',
                {
                        schema: {
                                summary: 'Contagem de sensores ativos',
                                tags: ['sensores'],
                                description: 'Contagem de sensores ativos do sistema'
                        }
                },
                SensorController.countAtivos);

        fastify.get('/consumo-total',
                {
                        schema: {
                                summary: 'Consumo total dos sensores',
                                tags: ['sensores'],
                                description: 'Listando o consumo total dos sensores do sistema'
                        }
                },
                SensorController.getConsumoTotalDosSensores);

        fastify.get('/consumo-total-casas',
                {
                        schema: {
                                summarya: 'Consumo total dos sensores que ficam em casa',
                                tags: ['sensores'],
                                description: 'Listando o consumo total de sensores do tipo casa do sistema'
                        }
                },
                SensorController.getConsumoTotalCasas);

        fastify.get('/consumo-total-apartamentos',
                {
                        schema: {
                                summary: 'Consumo total dos sensores que ficam em apartamento',
                                tags: ['sensores'],
                                description: 'Listando o consumo total de sensores do tipo apartamento do sistema'
                        }
                },
                SensorController.getConsumoTotalApartamentos);

        fastify.patch('/:id/inativar',
                {
                        schema: {
                                summary: 'Inativando sensor',
                                tags: ['sensores'],
                                description: 'Inativando um sensor do sistema'
                        }
                },
                SensorController.inativar);
        fastify.patch('/:id/ativar',
                {
                        schema: {
                                summary: 'Ativando sensor',
                                tags: ['sensores'],
                                description: 'Ativando um sensor do sistema'
                        }
                },
                SensorController.ativar);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\suporte.routes.js
=================================================================================

import SuporteController from "../controllers/SuporteController.js";

export default async function suporteRoutes(fastify) {

    fastify.get('/',
        {
            schema: {
                summary: 'Listando todas as mensagens de clientes para a administra√ß√£o',
                tags: ['suporte'],
                description: 'Listando todas as mensagens'
            }
        }, SuporteController.getAll);

    fastify.post('/',
        {
            schema: {
                summary: 'Respondendo mensagem de cliente',
                tags: ['suporte'],
                description: 'Enviando mensagem para o cliente'
            }
        }, SuporteController.enviarMensagem);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\user.routes.js
=================================================================================

import UserController from "../controllers/UserController.js";

export default async function userRoutes(fastify) {

    fastify.get('/', {
        schema: {
            summary: 'Listar Usu√°rios',
            description: 'Lista todos os usu√°rios do sistema',
            tags: ['usu√°rios'],
            description: 'List Users',
        }
    }, UserController.getAll);

    fastify.get('/ativos',
        {
            schema: {
                summary: 'Listar Usu√°rios ativos',
                tags: ['usu√°rios'],
                description: "Listando todos os usu√°rios ativos do sistema",
            }
        }, UserController.getAllActives);

    fastify.get('/inativos',
        {
            schema: {
                summary: 'Listar Usu√°rios inativos',
                tags: ['usu√°rios'],
                description: "Listando todos os usu√°rios inativos do sistema",
            }
        }, UserController.getAllDeactivated);


    fastify.get('/casa',
        {
            schema: {
                summary: 'Listando Usu√°rios que moram em uma casa',
                tags: ['usu√°rios'],
                description: "Listando todos os usu√°rios do tipo 'casa' do sistema"
            }
        }, UserController.getAllMoramEmCasa);

    fastify.get('/condominio',
        {
            schema: {
                summary: 'Listando Usu√°rios que moram em condominio',
                tags: ['usu√°rios'],
                description: "Listando todos os usu√°rios do tipo condominio do sistema"
            }
        }, UserController.getAllMoramCondominio);

    fastify.get('/count', {
        schema: {
            summary: 'Fazendo contagem de usu√°rios do sistema',
            tags: ['usu√°rios'],
            description: "Contagem de usu√°rios do sistema",
        }
    }, UserController.count);

    fastify.get('/count-ativos',
        {
            schema: {
                summary: 'Fazendo contagem de usu√°rios ativos do sistema',
                tags: ['usu√°rios'],
                description: "Contagem de usu√°rios ativos do sistema",
            }
        }, UserController.countAtivos);

    fastify.get('/sindicos', {
        schema: {
            summary: 'Listando todos os sindicos do sistema',
            tags: ['usu√°rios'],
            description: "Sindicos do sistema",
        }
    }, UserController.getAllSindicos);

    fastify.get('/count/sindicos', {
        schema: {
            summary: 'Fazendo contagem de sindicos do sistema',
            tags: ['usu√°rios'],
            description: "Contagem de sindicos do sistema",
        }
    }, UserController.countSindicos);

    fastify.get('/moradores', {
        schema: {
            summary: 'Fazendo contagem de moradores do sistema',
            tags: ['usu√°rios'],
            description: "Contagem de moradores do sistema",
        }
    }, UserController.countMoradores);

    fastify.get('/moradores/casas',
        {
            schema: {
                summary: "Fazendo contagem de moradores do sistema que s√£o do tipo casa",
                tags: ['usu√°rios'],
                description: "Contagem de moradores do sistema",
            }
        }, UserController.moradoresCasa);


    fastify.get('/moradores/apartamentos',
        {
            schema: {
                summary: "Fazendo contagem de moradores do sistema que moram em apartamento",
                tags: ['usu√°rios'], 
                description: "Contagem de moradores de apto do sistema",
            }
        }, UserController.moradoresApartamentos);

    fastify.get('/:id', {
        schema: {
            summary: 'Get de um user pelo Id',
            tags: ['usu√°rios'],
            description: "puxando dados do usu√°rio pelo id",
        }
    }, UserController.getById);

    fastify.patch('/:id/inativar',
        {
            schema: {
                summary: 'Inativando o usu√°rio',
                tags: ['usu√°rios'],
                description: "Inativando o usu√°rio pelo id no sistema",
            }
        }, UserController.deactivate);

    fastify.patch('/:id/ativar',
        {
            schema: {
                summary: "Ativando o usu√°rio",
                tags: ['usu√°rios'],
                description: "Ativando o usu√°rio pelo ID no sistema",
            }
        }, UserController.ativar);

    fastify.patch('/:id/sindico',
        {
            schema: {
                summary: "Tornando um usu√°rio comum em sindico",
                tags: ['usu√°rios'],
                description: "Atribuindo como sindico",
            }
        }, UserController.sindico);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\routes\vazamento.routes.js
=================================================================================

import TaxaVazamentoController from "../controllers/TaxaVazamentoController.js";

export default async function vazamentoRoutes(fastify) {
    fastify.get('/', {
        schema: {
            summary: 'Listando o vazamento entre sensores',
            tags: ['vazamentos'],
            description: 'Taxa de vazamento'
        }
    }, TaxaVazamentoController.get);
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\seeds\AdminSeed.js
=================================================================================

import Admin from './models/Admin.js';
import sequelize from './config/sequelize.js';

const seedAdmin = async () => {
  try {
    await sequelize.authenticate();

    const existe = await Admin.findOne({ where: { email: 'aqua@gmail.com' } });

    if (!existe) {
      await Admin.create({
        email: 'aqua@gmail.com',
        password: 'admin123', 
        type: 'superadmin',
      });

      console.log('Superadmin criado com sucesso!');
    } else {
      console.log('Superadmin j√° existe.');
    }

    process.exit(0);
  } catch (error) {
    console.error('Erro ao criar admin:', error);
    process.exit(1);
  }
};

seedAdmin();



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\server.js
=================================================================================

import dotenv from 'dotenv';
import { resolve } from "path";
dotenv.config({ path: resolve("..", ".env") }); 

import app from "./app.js";
import { connectDB } from "./config/sequelize.js";
import Admin from "./models/Admin.js"; 

const PORT = 3333;

// dados mockados de um admin padr√£o...
const criarSuperadminPadrao = async () => {
    const existe = await Admin.findOne({ where: { email: 'aqua@gmail.com' } });

    if (!existe) {
        await Admin.create({
            email: 'aqua@gmail.com',
            password: 'admin123', 
            type: 'superadmin',
        });
        console.log(' Superadmin criado automaticamente!');
    } else {
        console.log(' Superadmin j√° existe.');
    }
};

const start = async () => {
    try {
        await connectDB();               
        await criarSuperadminPadrao();     

        await app.listen({
            host: '0.0.0.0',
            port: PORT
        });

        console.log(`HTTP Server rodando na porta ${PORT}`);
    } catch (error) {
        console.error(' Erro ao iniciar servidor:', error);
        process.exit(1);
    }
};

start();



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\AdminService.js
=================================================================================

import Admin from '../models/Admin.js'
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs'



export default class AdminService {

    static async getAllAdmins(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']],
                attributes: { exclude: ['password'] },
            }
            const admins = Admin.paginate(options);
            return admins;
        } catch (error) {
            console.error('Erro ao listar administradores', error);
            throw error;
        }
    }

    static async getAllAdminsAtivos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']],
                attributes: { exclude: ['password'] },
                where: { status: 'ativo' }

            }
            const admins = await Admin.paginate(options);
            return admins;
        } catch (error) {
            console.error('Erro ao listar administradores ativos', error);
            throw error;
        }
    }

    static async getAllAdminsInativos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']],
                attributes: { exclude: ['password'] },
                where: { status: 'inativo' }
            }
            const admins = await Admin.paginate(options);
            return admins;
        } catch (error) {
            console.error('Erro ao listar administradores inativos', error);
            throw error;
        }
    }

    static async createAdmin({ email, password }) {
        try {
            const admin = await Admin.create({
                email, password
            })
            return admin;
        } catch (error) {
            console.error('Erro ao criar administrador', error);
            throw error;
        }
    }

    static async updateAdmin(id, { email, type }) {
        try {
            const admin = await Admin.findByPk(id);
            if (!admin) {
                throw new Error('Administrador n√£o encontrado');
            }
            await admin.update({
                email, type
            })
            return admin;
        } catch (error) {
            console.error('Erro ao atualizar administrador', error);
            throw error;
        }
    }

    static async inativarAdmin(id) {
        try {
            const admin = await Admin.findByPk(id);
            if (!admin) {
                throw new Error('Administrador n√£o encontrado');
            }

            await admin.update({
                status: 'inativo'
            })

            return { message: 'Administrador inativado com sucesso!', admin }
        } catch (error) {
            console.error('Erro ao inativar administrador', error);
            throw error;
        }
    }

    static async ativarAdmin(id) {
        try {
            const admin = await Admin.findByPk(id);
            if (!admin) {
                throw new Error('Administrador n√£o encontrado');
            }

            await admin.update({
                status: 'ativo'
            })

            return { message: 'Administrador ativado com sucesso!', admin }
        } catch (error) {
            console.error('Erro ao ativar administrador', error);
            throw error;
        }
    }

    static async updateMe(adminId, data) {
        try {
            const admin = await Admin.findByPk(adminId);
            if (!admin) throw new Error('Usu√°rio n√£o encontrado');

            await admin.update(data);
            const adminData = admin.toJSON();
            delete adminData.password;
            return adminData;
        } catch (error) {
            console.error('Erro ao atualizar usu√°rio', error);
            throw error;
        }
    }

    static async uploadProfilePicture(adminId, file) {
        try {

            const uploadDir = path.join(process.cwd(), 'uploads');

            // cria a pasta uploads se n√£o existir
            if (!fs.existsSync(uploadDir)) fs.mkdirSync(uploadDir);

            // gera nome √∫nico
            const fileName = `${Date.now()}-${file.filename}`;
            const filePath = path.join(uploadDir, fileName);

            // salva o arquivo
            const buffer = await file.toBuffer();
            await fs.promises.writeFile(filePath, buffer);

            // atualiza campo img_url do admin
            const admin = await Admin.findByPk(adminId);
            if (!admin) throw new Error('Administrador n√£o encontrado');

            admin.img_url = `/api/uploads/${fileName}`;

            console.log('path importado:', path);
            console.log('file recebido:', file);
            await admin.save();

            return admin.img_url;
        } catch (error) {
            console.error('Erro ao atualizar foto de usu√°rio', error);
            throw error;
        }
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\AlertasService.js
=================================================================================

import { fn, col, Op } from "sequelize";
import Alertas from "../models/Alertas.js";
import Condominio from "../models/Condominio.js";
import Casa from "../models/Casa.js";
import Apartamento from "../models/Apartamento.js";

export default class AlertasService {

    static async getAlertasRecentes() {
        try {
            const alertas = await Alertas.findAll({
                limit: 5, // pega apenas 5
                order: [['criado_em', 'DESC']]
            });
            return alertas;
        } catch (error) {
            console.error('Erro ao listar alertas recentes', error);
            throw error;
        }
    }

    static async getAllAlertas(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']]
            }
            const alertas = await Alertas.paginate(options);
            return alertas;
        } catch (error) {
            console.error('Erro ao listar alertas', error);
            throw error;
        }
    }

    static async getAllAlertasAtivos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']],
                where: { resolvido: false }
            }
            const alertas = await Alertas.paginate(options);
            return alertas;
        } catch (error) {
            console.error('Erro ao listar alertas ativos', error);
            throw error;
        }
    }

    static async getAllAlertasResolvidos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']],
                where: { resolvido: true }
            }
            const alertas = await Alertas.paginate(options);
            return alertas;
        } catch (error) {
            console.error('Erro ao listar alertas resolvidos', error);
            throw error;
        }
    }

    static async countAlertasAtivos() {
        try {
            const alertas = await Alertas.count({
                where: { resolvido: false }
            });
            return { totalAlertasAtivos: alertas };
        } catch (error) {
            console.error('Erro ao fazer contagem de alertas ativos', error);
            throw error;
        }
    }

    static async countTotalCasa() {
        try {
            const total = await Alertas.count({
                where: {
                    casa_id: { [Op.ne]: null },
                    resolvido: false // apenas alertas ativos
                }
            });

            return { totalAlertasCasa: total };
        } catch (error) {
            console.error('Erro ao contar alertas gerais de casas:', error);
            throw error;
        }
    }

    static async countAlertasDeVazamento() {
        try {
            const total = await Alertas.count({
                where: {
                    tipo: 'vazamento'
                }
            });

            return total;
        } catch (error) {
            console.error('Erro ao contar alertas gerais de vazamento:', error);
            throw error;
        }
    }

    static async countAlertasDeConsumoAlto() {
        try {
            const total = await Alertas.count({
                where: {
                    tipo: 'consumo_alto'
                }
            });

            return total;
        } catch (error) {
            console.error('Erro ao contar alertas gerais de consumo alto:', error);
            throw error;
        }
    }

    static async countTotalApartamento() {
        try {
            const total = await Alertas.count({
                where: {
                    condominio_id: { [Op.ne]: null },
                    resolvido: false
                }
            });

            return { totalAlertasCondominios: total };
        } catch (error) {
            console.error('Erro ao contar alertas gerais de condom√≠nios:', error);
            throw error;
        }
    }

    static async countPorCondominio() {
        try {
            const resultados = await Alertas.findAll({
                attributes: [
                    'condominio_id',
                    [fn('COUNT', col('id')), 'totalAlertas']
                ],
                include: [
                    {
                        model: Condominio,
                        as: 'condominio',
                        attributes: ['id', 'nome']
                    }
                ],
                where: {
                    condominio_id: { [Op.ne]: null },
                    resolvido: false // apenas ativos
                },
                group: ['condominio_id', 'condominio.id', 'condominio.nome'],
                order: [[fn('COUNT', col('id')), 'DESC']]
            });

            const condominios = resultados.map(r => ({
                condominioId: r.condominio_id,
                nome: r.condominio?.nome || 'Desconhecido',
                totalAlertas: Number(r.dataValues.totalAlertas)
            }));

            return { condominios };
        } catch (error) {
            console.error('Erro ao contar alertas por condom√≠nio:', error);
            throw error;
        }
    }

    // alertas por cada casa
    static async countAlertasAtivosPorCasa() {
        try {
            const alertas = await Alertas.findAll({
                attributes: [
                    'residencia_id',
                    [fn('COUNT', col('Alertas.id')), 'total_alertas']
                ],
                where: {
                    resolvido: false,
                    residencia_type: 'casa'
                },
                group: ['residencia_id'],
                include: [
                    {
                        model: Casa,
                        as: 'casa',
                        attributes: ['logradouro', 'numero', 'bairro', 'cidade', 'uf']
                    }
                ],
                order: [[fn('COUNT', col('Alertas.id')), 'DESC']]
            });

            return alertas.map((a, index) => ({
                id: index + 1,
                residencia_id: a.residencia_id,
                identificacao: a.casa
                    ? `${a.casa.logradouro}, N¬∫ ${a.casa.numero} - ${a.casa.bairro}, ${a.casa.cidade} - ${a.casa.uf}`
                    : 'Desconhecido',
                total_alertas: Number(a.getDataValue('total_alertas'))
            }));
        } catch (error) {
            console.error("Erro ao contar alertas ativos por casa", error);
            throw error;
        }
    }

    static async countAlertasAtivosPorApartamento() {
        try {
            const alertas = await Alertas.findAll({
                attributes: [
                    'residencia_id',
                    [fn('COUNT', col('Alertas.id')), 'total_alertas']
                ],
                where: {
                    resolvido: false,
                    residencia_type: 'apartamento'
                },
                group: ['residencia_id'],
                include: [
                    {
                        model: Apartamento,
                        as: 'apartamento',
                        attributes: ['numero', 'bloco']
                    }
                ],
                order: [[fn('COUNT', col('Alertas.id')), 'DESC']]
            });

            return alertas.map((a, index) => ({
                id: index + 1,
                residencia_id: a.residencia_id,
                identificacao: a.apartamento
                    ? `Bloco ${a.apartamento.bloco || '-'}, N¬∫ ${a.apartamento.numero}`
                    : 'Desconhecido',
                total_alertas: Number(a.getDataValue('total_alertas'))
            }));
        }
        catch (error) {
            console.error('Erro ao listar count', error);
            throw error;
        }
    }

    static async removerAlerta(id) {
        try {
            const alerta = await Alertas.findByPk(id);
            if (!alerta) {
                throw new Error("Alerta n√£o encontrado")
            }

            await alerta.update({ resolvido: true });

            return { message: 'Alerta resolvido com sucesso!', alerta };
        } catch (error) {
            console.error('Erro ao atualizar status do alerta', error);
            throw error;
        }
    }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\ApartamentoService.js
=================================================================================

import Apartamento from "../models/Apartamento.js";
import ApartamentoView from "../models/ApartamentoView.js";

export default class ApartamentoService {

    static async getAllApartamentos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['apartamento_id', 'DESC']]
            }
            const apartamentos = await ApartamentoView.paginate(options);
            return apartamentos;
        } catch (error) {
            console.error("Erro ao listr todas as apartamentos", error);
            throw error;
        }
    }

    static async getAllApartamentosAtivos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['apartamento_id', 'DESC']],
                where: { apartamento_status: 'ativo' }
            }
            const apartamentos = await ApartamentoView.paginate(options);
            return apartamentos;
        } catch (error) {
            console.error('Erro ao listar todas as apartamentos ativas');
            throw error;
        }
    }

    static async getAllApartamentosInativos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['apartamento_id', 'DESC']],
                where: { apartamento_status: 'inativo' }
            }
            const apartamentos = await ApartamentoView.paginate(options);
            return apartamentos;
        } catch (error) {
            console.error('Erro ao listar todas as apartamentos inativas');
            throw error;
        }
    }

    static async countApartamentos(){
        try {
            const apartamentos = await Apartamento.count();
            return apartamentos;
        } catch (error) {
            console.error('Erro ao contar apartamentos', error);
            throw error;
        }
    }

    static async inativarApartamento(id) {
        try {
            const apartamento = await Apartamento.findByPk(id);
            if (!apartamento) {
                throw new Error('Apartamento n√£o encontrada.')
            }
            await apartamento.update({
                status: 'inativo'
            })

            return { message: 'Apartamento inativada com sucesso!', apartamento }
        } catch (error) {
            console.error('Erro ao inativar apartamento', error);
            throw error;
        }
    }

    static async ativarApartamento(id) {
        try {
            const apartamento = await Apartamento.findByPk(id);
            if (!apartamento) {
                throw new Error('Apartamento n√£o encontrada.')
            }
            await apartamento.update({
                status: 'ativo'
            })

            return { message: 'Apartamento ativada com sucesso!', apartamento }
        } catch (error) {
            console.error('Erro ao ativar apartamento', error);
            throw error;
        }
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\CasaService.js
=================================================================================

import Casa from "../models/Casa.js";
import CasaView from "../models/CasaView.js";

export default class CasaService {

    static async getAllHouses(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [["casa_id", "ASC"]],
            }

            const casas = await CasaView.paginate(options);
            return casas;
        } catch (error) {
            console.error('Erro ao listar casas', error);
            throw error;
        }
    }

    static async getAllHousesAtivas(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [["casa_id", "ASC"]],
                where: { casa_status: 'ativo' }
            }
            const casas = await CasaView.paginate(options);
            return casas;
        } catch (error) {
            console.error('Erro ao listar casas ativas', error);
            throw error;
        }
    }

    static async getAllHousesInativas(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [["casa_id", "ASC"]],
                where: { casa_status: 'inativo' }
            }
            const casas = await CasaView.paginate(options);
            return casas;
        } catch (error) {
            console.error('Erro ao listar casas inativas');
            throw error;
        }
    }

    static async countHouses() {
        try {
            const casas = await Casa.count();
            return casas;
        } catch (error) {
            console.error('Erro ao listar contagem de casas');
            throw error;
        }
    }

    static async countHousesAtivas() {
        try {
            const casas = await Casa.count({
                where: { status: 'ativo' }
            })
            return casas;
        } catch (error) {
            console.error('Erro ao listar contagem de casas ativas');
            throw error;
        }
    }

    static async inativarCasa(id) {
        try {
            const casa = await Casa.findByPk(id);
            if (!casa) {
                throw new Error('Casa n√£o encontrada');
            }

            if (casa.status === 'inativo') {
                throw new Error('Casa j√° est√° inativa');
            }

            await casa.update({
                status: 'inativo'
            })
            return casa;
        } catch (error) {
            console.error('Erro ao inativar casa:', error.message);
            throw new Error(error.message);
        }
    }

    static async ativarCasa(id) {
        try {
            const casa = await Casa.findByPk(id);
            if (!casa) {
                throw new Error('Casa n√£o encontrada');
            }

            if (casa.status === 'ativo') {
                throw new Error('Casa j√° est√° ativada');
            }

            await casa.update({
                status: 'ativo'
            })
            return { message: 'Casa ativada com sucesso', casa };
        } catch (error) {
            console.error('Erro ao ativar casa');
            throw error;
        }
    }


}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\CepService.js
=================================================================================

import axios from 'axios';

export default class CepService {
  static async buscarCep(cep) {
    try {
      const response = await axios.get(`https://viacep.com.br/ws/${cep}/json/`);

      if (response.data.erro) {
        throw new Error('CEP n√£o encontrado');
      }

      return {
        logradouro: response.data.logradouro,
        bairro: response.data.bairro,
        cidade: response.data.localidade,
        uf: response.data.uf,
        cep: response.data.cep
      };
    } catch (error) {
      console.error('Erro ao buscar CEP:', error.message);
      throw new Error('N√£o foi poss√≠vel consultar o CEP');
    }
  }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\ComunicadosService.js
=================================================================================

import Comunicados from "../models/Comunicados.js";

export default class ComunicadosService {

    static async getAll() {
        try {
            const comunicados = await Comunicados.findAll();
            return comunicados;
        } catch (error) {
            console.error('Erro ao listar comunicados', error);
            throw error;
        }
    }

    static async create({ title, subject, addressee }) {
        try {
            const comunicado = await Comunicados.create({
                title, subject, addressee
            });
            return comunicado;
        } catch (error) {
            console.error('Erro ao criar comunicado.', error);
            throw error;
        }
    }

    static async update(id, {title, subject, addressee}){
        try {
            const comunicado = await Comunicados.findByPk(id);
            if(!comunicado) throw new Error('Comunicado n√£o encontrado');

            await comunicado.update({
                title, subject, addressee
            })
            return comunicado;

        } catch (error) {
            console.error("Erro ao atualizar comunicado.", error);
            throw error;
        }
    }

    static async deleteComunicado(id) {
        try {
            const comunicado = await Comunicados.findByPk(id);
            if(!comunicado) throw new Error('Comunicado n√£o encontrado');

            await comunicado.destroy();
            return {
                success: true,
                message: 'Comunicado deletado com sucesso!'
            };
        } catch (error) {
            console.error('Erro ao deletar comunicado', error);
            throw error;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\CondominioService.js
=================================================================================

import Condominio from "../models/Condominio.js";
import CondominioView from "../models/CondominioView.js";
import CepService from "./CepService.js";

export default class CondominioService {

    static async getAllCondominios(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['condominio_id', 'DESC']],
            }
            const condomonios = await CondominioView.paginate(options);
            return condomonios;
        } catch (error) {
            console.error('Erro ao buscar condominios', error);
            throw error;
        }
    }

    static async getAllActivesCondominios(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['condominio_id', 'DESC']],
                where: { condominio_status: 'ativo' },
            }
            const condominios = await CondominioView.paginate(options);
            return condominios;
        } catch (error) {
            console.error('Erro ao buscar condominios ativos');
            throw error;
        }
    }

    static async getAllDeactivetedCondominios(page = 1, limit = 10) {
        try {

            const options = {
                page,
                paginate: limit,
                order: [['condominio_id', 'DESC']],
                where: { condominio_status: 'ativo' },
            }
            const condominios = await CondominioView.paginate(options);
            return condominios;

        } catch (error) {
            console.error('Erro ao buscar condominios inativos', error);
            throw error;
        }
    }

    static async getAllApartamentosAtivosDeUmCondominio(id, page = 1, limit = 10) {
        try {
            const condominio = await Condominio.findByPk(id);
            if (!condominio) {
                throw new Error('Condominio n√£o encontrado');
            }

            const options = {
                page,
                paginate: limit,
                order: [['criado_em', 'DESC']],
                where: {
                    condominio_id: id,
                    status: 'ativo'
                }
            }

            const apartamentos = await Condominio.paginate(options);
            return apartamentos;
        } catch (error) {
            console.error('Erro ao listar apartamentos ativas do condominio')
        }
    }

    static async countAllCondominios() {
        try {
            const condominiosTotais = await Condominio.count();
            return condominiosTotais;
        } catch (error) {
            console.error('Erro ao contar condominios', error);
            throw error;
        }
    }

    static async createCondominio({ name, numero, cep, sindico_id }) {
        try {
            const endereco = await CepService.buscarCep(cep);

            const condominioExistente = await Condominio.findOne({
                where: { cep: endereco.cep },
            });

            if (condominioExistente) {
                throw new Error(`J√° existe um condom√≠nio cadastrado com o CEP ${endereco.cep}`);
            }

            const condominio = await Condominio.create({
                name,
                numero,
                cep: endereco.cep,
                logradouro: endereco.logradouro,
                bairro: endereco.bairro,
                cidade: endereco.cidade,
                uf: endereco.uf,
                sindico_id,
            });

            if (condominio.cep)

                return condominio;
        } catch (error) {
            console.error("Erro ao criar condom√≠nio:", error);
            throw error;
        }
    }

    static async updateNameCondominio(id, { name }) {
        try {
            
            const condominio = await Condominio.findByPk(id);
            
            if (!condominio) {
                throw new Error('Condominio n√£o encontrado.')
            }

            await condominio.update({
                name,
            })

            return condominio;
        } catch (error) {
            console.error('Erro ao atualizar condominio', error);
            throw error;
        }
    }


    static async updateCondominio(id, { name, numero, cep, sindico_id }) {
        try {
            const endereco = await CepService.buscarCep(cep);

            const condominio = await Condominio.findByPk(id);
            if (!condominio) {
                throw new Error('Condominio n√£o encontrado.')
            }

            const condominioExistente = await Condominio.findOne({
                where: { cep: endereco.cep },
            });

            if (condominioExistente) {
                throw new Error(`J√° existe um condom√≠nio cadastrado com o CEP ${endereco.cep}`);
            }

            await condominio.update({
                name, numero, sindico_id, cep: endereco.cep,
                logradouro: endereco.logradouro,
                bairro: endereco.bairro,
                cidade: endereco.cidade,
                uf: endereco.uf,
            })

            return condominio;
        } catch (error) {
            console.error('Erro ao atualizar condominio', error);
            throw error;
        }
    }

    static async atribuirSindico(id, { sindico_id }) {
        try {
            const condominio = await Condominio.findByPk(id);
            if (!condominio) throw new Error('Condom√≠nio n√£o encontrado');

            if (condominio.sindico_id) {
                throw new Error('Esse condom√≠nio j√° possui um s√≠ndico.');
            }

            await condominio.update({ sindico_id });

            return condominio;
        } catch (error) {
            console.error('Erro ao atribuir s√≠ndico', error);
            throw error;
        }
    }

    static async inativarCondominio(id) {
        try {
            const condominio = await Condominio.findByPk(id);
            if (!condominio) {
                throw new Error('Condominio n√£o encontrado');
            }

            await condominio.update({ status: 'inativo' });
            return { message: 'Condominio inativado com sucesso!' }
        } catch (error) {
            console.error('Erro ao inativar condominio');
            throw error;
        }
    }

    static async ativarCondominio(id) {
        try {
            const condominio = await Condominio.findByPk(id);
            if (!condominio) {
                throw new Error('Condominio n√£o encontrado');
            }

            await condominio.update({ status: 'ativo' });
            return { message: 'Condominio ativado com sucesso!' }
        } catch (error) {
            console.error('Erro ao ativar condominio');
            throw error;
        }
    }

    static async countApartamentosPorCondominio() {
        try {
            const condominio = await Condominio.findByPk(id);

            if (!condominio) {
                throw new Error('Condom√≠nio n√£o encontrado');
            }

            const total = await Apartamento.count({
                where: { condominio_id: id }
            });

            return {
                condominio_id: id,
                nome: condominio.nome,
                total_apartamentos: total
            };
        } catch (error) {
            console.error('Erro ao listar contagem de apartamentos.', error);
            throw error;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\CrescimentoUsersService.js
=================================================================================

import CrescimentoUserView from "../models/CrescimentoUserView.js";

export default class CrescimentoUsersService {

    static async getAll(){
        try {
            const crescimento = await CrescimentoUserView.findAll();
            return crescimento;
        } catch (error){
            console.error("Erro ao listar crescimento", error);
            throw error;
        }
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\LeituraSensor.js
=================================================================================

import LeituraSensor from '../models/LeituraSensor.js'

export default class LeituraSensorService {

    static async getAll(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['data_registro', 'DESC']]
            }
            const leitura = LeituraSensor.paginate(options);
            return leitura;
        } catch (error){
            console.error('Erro ao listar Leitura de sensores', error);
            throw error;
        }
    }

}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\ResidenciaService.js
=================================================================================

import Condominio from "../models/Condominio.js";
import Apartamento from "../models/Apartamento.js";
import Casa from '../models/Casa.js'
import { estados } from '../models/Condominio.js';
import sequelize from "../config/sequelize.js";

export default class ResidenciaService {

    static async getAllResidencias() {
        try {
            const totalCasas = await Casa.count();
            const totalApartamentos = await Apartamento.count();

            const totalResidencias = totalCasas + totalApartamentos;

            return {
                totalResidencias,
                totalCasas,
                totalApartamentos
            }
        } catch (error) {
            console.error('Erro ao buscar total de residencias', error);
            throw error;
        }
    }

    static async getAllDistribuicaoPorUf() {
        try {
            // Contar casas por UF
            const casasPorUf = await Casa.findAll({
                attributes: ['uf', [sequelize.fn('COUNT', sequelize.col('id')), 'total']],
                group: ['uf'],
                raw: true
            });

            // Contar condom√≠nios por UF
            const condominiosPorUf = await Condominio.findAll({
                attributes: ['uf', [sequelize.fn('COUNT', sequelize.col('id')), 'total']],
                group: ['uf'],
                raw: true
            });

            const distribuicao = {};

            casasPorUf.forEach(c => {
                const nomeEstado = estados[c.uf] || c.uf;
                distribuicao[nomeEstado] = { casas: parseInt(c.total), condominios: 0 };
            });

            condominiosPorUf.forEach(c => {
                const nomeEstado = estados[c.uf] || c.uf;
                if (distribuicao[nomeEstado]) {
                    distribuicao[nomeEstado].condominios = parseInt(c.total);
                } else {
                    distribuicao[nomeEstado] = { casas: 0, condominios: parseInt(c.total) };
                }
            });

            return distribuicao;

        } catch (error) {
            console.error('Erro ao buscar distribui√ß√£o por estado', error);
            throw error;
        }
    }

}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\SensorService.js
=================================================================================

import Sensor from "../models/Sensor.js";
import { Op } from 'sequelize';
import SensorView from "../models/SensorView.js";


export default class SensorService {

    static async getAll(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['sensor_id', 'ASC']]
            }
            const sensores = await SensorView.paginate(options);
            return sensores;
        } catch (error) {
            console.error('Erro ao listar sensores', error);
            throw error;
        }
    }

    static async getAllAtivos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['sensor_id', 'ASC']],
                where: { sensor_status: 'ativo' }
            }
            const sensores = await SensorView.paginate(options);
            return sensores;
        } catch (error) {
            console.error('Erro ao listar sensores ativos', error);
            throw error;
        }
    }

    static async getAllInativos(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                order: [['sensor_id', 'ASC']],
                where: { sensor_status: 'inativo' }
            }
            const sensores = await SensorView.paginate(options);
            return sensores;
        } catch (error) {
            console.error('Erro ao listar sensores inativos', error);
            throw error;
        }
    }

    static async countSensores() {
        try {
            const sensores = await Sensor.count();
            return sensores;
        } catch (error) {
            console.error('Erro ao listar contagem de sensores', error);
            throw error;
        }
    }

    static async countSensoresAtivos() {
        try {
            const sensores = await Sensor.count({
                where: { status: 'ativo' }
            })
            return sensores;
        } catch (error) {
            console.error('Erro ao listar sensores ativos', error);
            throw error;
        }
    }

    static async countSensoresPorCasa() {
        try {
            const total = await Sensor.count({
                where: {
                    casa_id: {
                        [Op.ne]: null, // exclui Sensores que n√£o pertencem a casa

                    },
                    status: 'ativo'
                }
            });

            return { totalSensoresCasa: total };
        } catch (error) {
            console.error('Erro ao contar sensores gerais de casas:', error);
            throw error;
        }
    }

    static async countSensoresPorApartamento() {
        try {
            const total = await Sensor.count({
                where: {
                    apartamento_id: {
                        [Op.ne]: null,

                    },
                    status: 'ativo'
                }
            });

            return { totalSensoresApartamento: total };
        } catch (error) {
            console.error('Erro ao contar sensores gerais de apartamento:', error);
            throw error;
        }
    }

    static async consumoTotalSensores() {
        try {
            const total = await Sensor.sum('consumo_total');
            return total;
        } catch (error) {
            console.error('Erro ao calcular consumo total dos sensores', error);
            throw error;
        }
    }

    static async consumoTotalSensoresCasas() {
        try {
            const total = await Sensor.sum('consumo_total', {
                where: {
                    casa_id: { [Op.ne]: null } // somente sensores de casas
                }
            });
            return total;
        } catch (error) {
            console.error('Erro ao calcular consumo total dos sensores de casas', error);
            throw error;
        }
    }

    static async consumoTotalSensoresApartamento() {
        try {
            const total = await Sensor.sum('consumo_total', {
                where: {
                    apartamento_id: { [Op.ne]: null }
                }
            });
            return total;
        } catch (error) {
            console.error('Erro ao calcular consumo total dos sensores de apartamentos', error);
            throw error;
        }
    }

    static async updatesensor(id, { codigo }) {
        try {
            const sensor = await Sensor.findByPk(id);
            if (!sensor) {
                throw new Error('Sensor n√£o encontrado');
            }

            await sensor.update({
                codigo
            })
            return sensor;
        } catch (error) {
            console.error('Erro ao atualizar sensor', error);
            throw error;
        }
    }

    static async inativarSensor(id) {
        try {
            const sensor = await Sensor.findByPk(id);
            if (!sensor) {
                throw new Error('Sensor n√£o encontrado');
            }

            await sensor.update({
                status: 'inativo'
            })
            return sensor;
        } catch (error) {
            console.error('Erro ao inativar sensor', error);
            throw error;
        }
    }

    static async ativarSensor(id) {
        try {
            const sensor = await Sensor.findByPk(id);
            if (!sensor) {
                throw new Error('Sensor n√£o encontrado');
            }

            await sensor.update({
                status: 'ativo'
            })
            return sensor;
        } catch (error) {
            console.error('Erro ao ativar sensor', error);
            throw error;
        }
    }


}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\SuporteService.js
=================================================================================

import Suporte from "../models/Suporte.js";

export default class SuporteService {
    static async getAllMensagens(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit
            }
            const mensagens = await Suporte.paginate(options);
            return mensagens;
        } catch (error) {
            console.error('Erro ao listar as mensagens', error);
            throw error;
        }
    }

    static async responderMensagem(id, resposta) {
        try {
            const mensagem = await Suporte.findByPk(id);
            if (!mensagem) {
                throw new Error("Mensagem n√£o encontrada.");
            }

            mensagem.resposta = resposta;
            mensagem.status = "respondido";
            await mensagem.save();

            return mensagem;
        } catch (error) {
            console.error("Erro ao responder a mensagem", error);
            throw error;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\TaxaVazamentoService.js
=================================================================================

import TaxaVazamentoView from "../models/TaxaVazamentoView.js";

export default class TaxaVazamentoService {
    static async getAll(){
        try {
            const vazamentos = await TaxaVazamentoView.findAll();
            return vazamentos;
        } catch (error) {
            console.error('Erro ao listar taxa de vazamento', error);
            throw error;
        }
    }
}



=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\services\UserService.js
=================================================================================

import User from "../models/User.js";
import UserView from "../models/UserView.js";

export default class UserService {

    static async getAllUsers(page = 1, limit = 10) {
            try {
                const options = {
                    page,
                    paginate: limit,
                    order: [['user_id', 'DESC']]
                }
                const usuarios = await UserView.paginate(options);
                return usuarios;
            } catch (error) {
                console.error("Erro ao listar todas as usuarios", error);
                throw error;
            }
        }

         static async getAllUsersSindicos(page = 1, limit = 10) {
            try {
                const options = {
                    page,
                    paginate: limit,
                    where: {user_role: 'sindico'},
                    order: [['user_id', 'DESC']]
                }
                const sindicos = await UserView.paginate(options);
                return sindicos;
            } catch (error) {
                console.error("Erro ao listar todas as sindicos", error);
                throw error;
            }
        }


    static async getAllUserActives(page = 1, limit = 10) {
        try {
            
                const options = {
                    page,
                    paginate: limit,
                    where: {user_status: 'ativo'},
                    order: [['user_id', 'DESC']]
                }
                const usuarios = await UserView.paginate(options);
                return usuarios;
            } catch (error) {
                console.error("Erro ao listar todas as usuarios", error);
                throw error;
            }
        }
    
    

    static async getAllUsersDeactivated(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                where: {user_status: 'inativo'},
                order: [['user_id', 'DESC']]
            }
            const usuarios = await UserView.paginate(options);
            return usuarios;
        } catch (error) {
            console.error("Erro ao listar todas as usuarios", error);
            throw error;
        }
    }

    static async getAllUsersDeCondominio(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                where: { type: 'condominio' },
                order: [['criado_em', 'DESC']],
                attributes: { exclude: ['password'] }
            }
            const users = await User.paginate(options);
            return users;
        } catch (error) {
            console.error('Erro ao buscar usu√°rios', error);
            throw error;
        }
    }
    static async getAllUsersDeCasa(page = 1, limit = 10) {
        try {
            const options = {
                page,
                paginate: limit,
                where: { type: 'casa' },
                order: [['criado_em', 'DESC']],
                attributes: { exclude: ['password'] }
            }
            const users = await User.paginate(options);
            return users;
        } catch (error) {
            console.error('Erro ao buscar usu√°rios', error);
            throw error;
        }
    }


    static async countUsers() {
        try {
            const users = await User.count();
            return users;
        } catch (error) {
            console.error('Erro ao listar contagem de usu√°rios', error);
            throw error;
        }
    }

    static async countUsersAtivos() {
        try {
            const users = await User.count({ where: { status: 'ativo' } });
            return users;
        } catch (error) {
            console.error('Erro ao listar contagem de usu√°rios', error);
            throw error;
        }
    }

    static async countSindicos() {
        try {
            const users = await User.count({ where: { role: 'sindico' } });
            return users;
        } catch (error) {
            console.error('Erro ao listar contagem de sindicos', error);
            throw error;
        }
    }

    static async countMoradores() {
        try {
            const users = await User.count({ where: { role: 'morador' } });
            return users;
        } catch (error) {
            console.error('Erro ao listar contagem de moradores', error);
            throw error;
        }
    }

    static async countMoradoresCasa() {
        try {
            const users = await User.count({ where: { type: 'casa' } });
            return users;
        } catch (error) {
            console.error('Erro ao listar contagem de moradores', error);
            throw error;
        }
    }

    static async countMoradoresApartamentos() {
        try {
            const users = await User.count({ where: { type: 'condominio' } });
            return users;
        } catch (error) {
            console.error('Erro ao listar contagem de moradores', error);
            throw error;
        }
    }

    static async getUserById(id) {
        try {
            const user = await User.findByPk(id);
            if (!user) {
                throw new Error("Usu√°rio n√£o encontrado");
            }
            return user;
        } catch (error) {
            console.error('Erro ao listar usu√°rio.', error);
            throw error;
        }
    }

    static async deactivateUser(id) {
        try {
            const user = await User.findByPk(id);
            if (!user) {
                throw new Error('Usu√°rio n√£o encontrado.')
            }
            await user.update({ status: 'inativo' });
            const userWithoutPassword = user.toJSON();
            delete userWithoutPassword.password;
            return { message: 'Usu√°rio inativado com sucesso!', user: userWithoutPassword };
        } catch (error) {
            console.error('Erro ao inativar usu√°rio:', error);
            throw error;
        }
    }

    static async ativarUser(id) {
        try {
            const user = await User.findByPk(id);
            if (!user) {
                throw new Error('Usu√°rio n√£o encontrado.')
            }
            await user.update({ status: 'ativo' });
            const userWithoutPassword = user.toJSON();
            delete userWithoutPassword.password;
            return { message: 'Usu√°rio ativado com sucesso!', user: userWithoutPassword };
        } catch (error) {
            console.error('Erro ao ativar usu√°rio:', error);
            throw error;
        }
    }

    static async setarSindico(id){
        try {
            const user = await User.findByPk(id);
            if(!user) throw new Error('Usuario nao encontrado');

            if(user.type === 'casa') throw new Error('Esse usu√°rio n√£o faz parte de um condominio')
            if(user.role === 'sindico') throw new Error('Esse usu√°rio ja √© sindico')

                await user.update({
                    role: "sindico"
                })

                return user;
        } catch (error) {
            console.error('Erro ao atualizar para sindico', error);
            throw error;
        }
    }
}


=================================================================================
Arquivo: C:\Users\24250553\Documents\3mdR\aqua\backend-admin\src\utils\GenerateSecretKey.js
=================================================================================

import crypto from 'crypto';

class SecretKeyGenerator {
  constructor(keyLength = 64) {
    this.keyLength = keyLength;
  }
  generate() {
    return crypto.randomBytes(this.keyLength).toString('hex');
  }
}
const generator = new SecretKeyGenerator();
const secretKey = generator.generate();

console.log("Chave secreta gerada:", secretKey);

